<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tabi â€” Travel Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#fef6f0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg-primary:#fef6f0;--bg-secondary:#fae8e0;--bg-tertiary:#e8d5d0;
--bg-card:rgba(255,255,255,0.65);--bg-card-hover:rgba(255,255,255,0.85);
--accent-primary:#c94b4b;--accent-secondary:#8b3a62;
--accent-gradient:linear-gradient(135deg,#c94b4b,#8b3a62);
--text-primary:#2c1810;--text-secondary:#8b6f5c;--text-tertiary:#b8a090;
--success:#689f63;--warning:#daa520;--danger:#c94b4b;
--border-color:rgba(0,0,0,0.06);
--shadow-sm:0 1px 3px rgba(0,0,0,0.04),0 1px 2px rgba(0,0,0,0.06);
--shadow-md:0 4px 12px rgba(0,0,0,0.06),0 1px 4px rgba(0,0,0,0.04);
--shadow-lg:0 12px 40px rgba(0,0,0,0.08),0 4px 12px rgba(0,0,0,0.04);
--radius-sm:12px;--radius-md:16px;--radius-lg:20px;--radius-xl:24px;--radius-full:9999px;
--transition:300ms cubic-bezier(0.4,0,0.2,1);
--transition-fast:150ms cubic-bezier(0.4,0,0.2,1);
--transition-slow:500ms cubic-bezier(0.4,0,0.2,1);
--font-sans:'Noto Sans JP',-apple-system,sans-serif;
--font-serif:'Noto Serif JP',Georgia,serif;
--z-nav:100;--z-menu:200;--z-modal:300;--z-toast:400;--z-lightbox:500;
--safe-bottom:env(safe-area-inset-bottom,0px);
}
[data-theme="spring"]{--bg-primary:#fef6f0;--bg-secondary:#fae8e0;--bg-tertiary:#e8d5d0;--bg-card:rgba(255,255,255,0.65);--bg-card-hover:rgba(255,255,255,0.85);--accent-primary:#c94b4b;--accent-secondary:#8b3a62;--accent-gradient:linear-gradient(135deg,#c94b4b,#8b3a62);--text-primary:#2c1810;--text-secondary:#8b6f5c;--text-tertiary:#b8a090;--border-color:rgba(0,0,0,0.06);--success:#689f63;--warning:#daa520;--danger:#c94b4b}
[data-theme="autumn"]{--bg-primary:#faf3ea;--bg-secondary:#f0e0c8;--bg-tertiary:#dcc8a8;--bg-card:rgba(255,250,240,0.7);--bg-card-hover:rgba(255,250,240,0.9);--accent-primary:#c45d2c;--accent-secondary:#8b4513;--accent-gradient:linear-gradient(135deg,#c45d2c,#8b4513);--text-primary:#3a2210;--text-secondary:#8b6b4a;--text-tertiary:#b89878;--border-color:rgba(60,30,0,0.06);--success:#689f63;--warning:#daa520;--danger:#c45d2c}
[data-theme="winter"]{--bg-primary:#f0f4f8;--bg-secondary:#dce4ec;--bg-tertiary:#c8d4e0;--bg-card:rgba(255,255,255,0.7);--bg-card-hover:rgba(255,255,255,0.9);--accent-primary:#4a7c9b;--accent-secondary:#2c4a6e;--accent-gradient:linear-gradient(135deg,#4a7c9b,#2c4a6e);--text-primary:#1a2a3a;--text-secondary:#5a7a8a;--text-tertiary:#8aa0b0;--border-color:rgba(0,20,60,0.06);--success:#689f63;--warning:#daa520;--danger:#c94b4b}
[data-theme="summer"]{--bg-primary:#fefdf5;--bg-secondary:#fdf0d0;--bg-tertiary:#f0dca8;--bg-card:rgba(255,255,250,0.7);--bg-card-hover:rgba(255,255,250,0.9);--accent-primary:#d4882a;--accent-secondary:#b85c1a;--accent-gradient:linear-gradient(135deg,#d4882a,#b85c1a);--text-primary:#2a2010;--text-secondary:#8b7a50;--text-tertiary:#b0a070;--border-color:rgba(60,40,0,0.06);--success:#689f63;--warning:#daa520;--danger:#c94b4b}
[data-theme="tokyo"]{--bg-primary:#f2f0f8;--bg-secondary:#e4e0f0;--bg-tertiary:#d0c8e4;--bg-card:rgba(255,255,255,0.7);--bg-card-hover:rgba(255,255,255,0.88);--accent-primary:#d04090;--accent-secondary:#3090c0;--accent-gradient:linear-gradient(135deg,#d04090,#3090c0);--text-primary:#1a1028;--text-secondary:#6a5888;--text-tertiary:#9888b0;--border-color:rgba(40,20,80,0.07);--success:#40c080;--warning:#e0a820;--danger:#d04060}
[data-theme="edo"]{--bg-primary:#f5f0e6;--bg-secondary:#e8dcc8;--bg-tertiary:#d8c8a8;--bg-card:rgba(248,240,225,0.7);--bg-card-hover:rgba(248,240,225,0.9);--accent-primary:#8b2020;--accent-secondary:#2a4a3a;--accent-gradient:linear-gradient(135deg,#8b2020,#2a4a3a);--text-primary:#2a1a10;--text-secondary:#6a5a40;--text-tertiary:#9a8a70;--border-color:rgba(40,20,0,0.08);--success:#689f63;--warning:#daa520;--danger:#8b2020}
[data-mode="dark"][data-theme="spring"]{--bg-primary:#1a1210;--bg-secondary:#2a1e1a;--bg-tertiary:#3a2e28;--bg-card:rgba(50,35,30,0.7);--bg-card-hover:rgba(60,45,38,0.85);--text-primary:#f0e4d8;--text-secondary:#c4a88c;--text-tertiary:#8a7060;--border-color:rgba(255,200,180,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.25);--shadow-lg:0 12px 40px rgba(0,0,0,0.35)}
[data-mode="dark"][data-theme="autumn"]{--bg-primary:#1a1408;--bg-secondary:#2a2010;--bg-tertiary:#3a3018;--bg-card:rgba(50,38,18,0.7);--bg-card-hover:rgba(60,48,28,0.85);--text-primary:#f0e0c8;--text-secondary:#c4a070;--text-tertiary:#8a7448;--border-color:rgba(200,160,80,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.25);--shadow-lg:0 12px 40px rgba(0,0,0,0.35)}
[data-mode="dark"][data-theme="winter"]{--bg-primary:#0e1420;--bg-secondary:#162030;--bg-tertiary:#1e2c40;--bg-card:rgba(20,35,55,0.7);--bg-card-hover:rgba(28,45,65,0.85);--text-primary:#dce8f0;--text-secondary:#8aa8c0;--text-tertiary:#5a7890;--border-color:rgba(120,180,255,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.25);--shadow-lg:0 12px 40px rgba(0,0,0,0.35)}
[data-mode="dark"][data-theme="summer"]{--bg-primary:#1a1608;--bg-secondary:#2a2410;--bg-tertiary:#3a3418;--bg-card:rgba(50,44,18,0.7);--bg-card-hover:rgba(60,54,28,0.85);--text-primary:#f0e8d0;--text-secondary:#c4b078;--text-tertiary:#8a7c48;--border-color:rgba(200,180,80,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.25);--shadow-lg:0 12px 40px rgba(0,0,0,0.35)}
[data-mode="dark"][data-theme="tokyo"]{--bg-primary:#0a0810;--bg-secondary:#141220;--bg-tertiary:#1c1a30;--bg-card:rgba(20,18,40,0.75);--bg-card-hover:rgba(30,28,55,0.88);--accent-primary:#f050a8;--accent-secondary:#50b8e0;--accent-gradient:linear-gradient(135deg,#f050a8,#50b8e0);--text-primary:#eae4f8;--text-secondary:#a898c8;--text-tertiary:#685888;--border-color:rgba(200,140,255,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.3);--shadow-md:0 4px 12px rgba(0,0,0,0.35);--shadow-lg:0 12px 40px rgba(0,0,0,0.45)}
[data-mode="dark"][data-theme="edo"]{--bg-primary:#14100a;--bg-secondary:#241c12;--bg-tertiary:#34281a;--bg-card:rgba(42,32,18,0.7);--bg-card-hover:rgba(52,42,28,0.85);--text-primary:#e8dcc0;--text-secondary:#b8a478;--text-tertiary:#807050;--border-color:rgba(200,160,100,0.08);--shadow-sm:0 1px 3px rgba(0,0,0,0.2);--shadow-md:0 4px 12px rgba(0,0,0,0.25);--shadow-lg:0 12px 40px rgba(0,0,0,0.35)}
[data-mode="dark"][data-theme="tokyo"] .accent-glow{text-shadow:0 0 20px rgba(240,80,168,0.5)}
[data-mode="dark"][data-theme="tokyo"] .trip-progress-fill{box-shadow:0 0 12px rgba(240,80,168,0.5)}
[data-mode="dark"][data-theme="tokyo"] .action-btn-primary{box-shadow:0 4px 28px rgba(240,80,168,0.35)}
[data-mode="dark"][data-theme="tokyo"] .top-bar{border-bottom-color:rgba(240,80,168,0.12)}
[data-mode="dark"][data-theme="tokyo"] .widget-card{border-color:rgba(80,184,224,0.1)}
html{height:100%;overflow-x:hidden}
body{font-family:var(--font-sans);background:var(--bg-primary);color:var(--text-primary);min-height:100%;line-height:1.6;font-weight:400;-webkit-font-smoothing:antialiased;transition:background var(--transition-slow),color var(--transition-slow);overflow-x:hidden}
h1,h2,h3{font-family:var(--font-serif);font-weight:600;line-height:1.3}
h1{font-size:1.75rem}h2{font-size:1.35rem}h3{font-size:1.1rem}
.top-bar{position:fixed;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--bg-primary);border-bottom:1px solid var(--border-color);z-index:var(--z-nav);transition:background var(--transition-slow),border-color var(--transition-slow)}
.top-bar-left,.top-bar-right{display:flex;align-items:center;gap:4px}
.top-bar-center{position:absolute;left:50%;transform:translateX(-50%)}
.top-bar-logo{font-family:var(--font-serif);font-size:1.25rem;font-weight:700;color:var(--text-primary);cursor:pointer;transition:color var(--transition-slow)}
.top-bar-logo span{font-weight:400;font-size:0.75rem;color:var(--text-tertiary);display:block;text-align:center;letter-spacing:0.12em;text-transform:uppercase;margin-top:-2px}
.nav-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:1.25rem;color:var(--text-primary);transition:background var(--transition-fast),color var(--transition-slow)}
.nav-btn:active{background:var(--bg-secondary)}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:var(--z-menu);pointer-events:none;transition:background var(--transition)}
.menu-overlay.open{background:rgba(0,0,0,0.3);pointer-events:auto}
.menu-panel{position:fixed;top:0;right:0;bottom:0;width:min(320px,85vw);background:var(--bg-primary);z-index:calc(var(--z-menu)+1);transform:translateX(100%);transition:transform var(--transition),background var(--transition-slow);display:flex;flex-direction:column;overflow-y:auto;box-shadow:-4px 0 24px rgba(0,0,0,0.1)}
.menu-overlay.open .menu-panel{transform:translateX(0)}
.menu-header{padding:20px 20px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
.menu-header h2{font-size:1.2rem}
.menu-items{padding:8px 12px;flex:1}
.menu-item{display:flex;align-items:center;gap:14px;padding:14px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:background var(--transition-fast);color:var(--text-primary);font-size:0.95rem;border:none;background:none;width:100%;text-align:left;font-family:var(--font-sans)}
.menu-item:active{background:var(--bg-secondary)}
.menu-item-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:1.1rem;flex-shrink:0}
.menu-divider{height:1px;background:var(--border-color);margin:4px 12px}
.menu-mode-section{padding:12px 20px;border-top:1px solid var(--border-color)}
.mode-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
.mode-toggle-label{display:flex;align-items:center;gap:10px;font-size:0.9rem;color:var(--text-primary)}
.menu-theme-section{padding:16px 20px;border-top:1px solid var(--border-color)}
.menu-section-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);margin-bottom:12px}
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.theme-option{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 4px;border-radius:var(--radius-sm);border:2px solid transparent;cursor:pointer;transition:all var(--transition-fast);background:none;font-family:var(--font-sans)}
.theme-option.active{border-color:var(--accent-primary);background:var(--bg-secondary)}
.theme-option:active{transform:scale(0.95)}
.theme-swatch{width:40px;height:40px;border-radius:var(--radius-sm);overflow:hidden;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;box-shadow:var(--shadow-sm)}
.theme-swatch>div{width:100%;height:100%}
.theme-option-name{font-size:0.7rem;font-weight:500;color:var(--text-secondary)}
.app-content{padding:56px 0 0;min-height:100vh}
.page{display:none;animation:pageIn 400ms ease forwards}.page.active{display:block}
@keyframes pageIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.landing-page{padding:20px 16px calc(20px + var(--safe-bottom));max-width:480px;margin:0 auto}
.greeting-section{text-align:center;padding:32px 0 24px}
.greeting-text{font-family:var(--font-serif);font-size:1.6rem;font-weight:600;margin-bottom:4px}
.greeting-sub{font-size:0.9rem;color:var(--text-secondary);font-weight:300}
.clock-section{text-align:center;margin-bottom:28px}
.clock-time{font-size:3.5rem;font-weight:300;letter-spacing:-0.02em;line-height:1.1}
.clock-date{font-size:0.85rem;color:var(--text-secondary);margin-top:2px}
.clock-timezone{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.widget-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.widget-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition)}
.widget-card:active{transform:scale(0.98);background:var(--bg-card-hover)}
.widget-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:5px}
.widget-value{font-size:1.5rem;font-weight:600;line-height:1.2}
.widget-sub{font-size:0.75rem;color:var(--text-secondary);margin-top:2px}
.weather-widget{grid-column:span 2}
.weather-content{display:flex;align-items:center;justify-content:space-between}
.weather-main{display:flex;align-items:center;gap:12px}
.weather-temp{font-size:2.5rem;font-weight:300;line-height:1}
.weather-icon-large{font-size:2rem}
.weather-details{text-align:right}
.weather-condition{font-size:0.85rem;font-weight:500}
.weather-hilo{font-size:0.75rem;color:var(--text-secondary)}
.weather-location{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.weather-placeholder{display:flex;align-items:center;gap:12px;color:var(--text-secondary);font-size:0.85rem}
.weather-placeholder-icon{font-size:2rem;opacity:0.4}
.currency-content{display:flex;flex-direction:column;gap:4px}.currency-rate{font-size:1.3rem;font-weight:600}.currency-pair{font-size:0.75rem;color:var(--text-secondary)}.currency-placeholder{color:var(--text-secondary);font-size:0.8rem}
.trip-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:20px;margin-bottom:12px;backdrop-filter:blur(20px);transition:all var(--transition)}
.trip-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.trip-card-title{font-family:var(--font-serif);font-size:1.15rem;font-weight:600}
.trip-badge{font-size:0.65rem;font-weight:600;padding:3px 10px;border-radius:var(--radius-full);text-transform:uppercase;letter-spacing:0.08em}
.trip-badge.active{background:rgba(104,159,99,0.15);color:var(--success)}
.trip-badge.upcoming{background:rgba(218,165,32,0.15);color:var(--warning)}
.trip-badge.past{background:var(--bg-secondary);color:var(--text-tertiary)}
.trip-dates{font-size:0.8rem;color:var(--text-secondary);margin-bottom:14px}
.trip-progress-bar{height:4px;background:var(--bg-tertiary);border-radius:var(--radius-full);overflow:hidden;margin-bottom:6px}
.trip-progress-fill{height:100%;background:var(--accent-gradient);border-radius:var(--radius-full);transition:width 1s ease}
.trip-progress-text{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-tertiary)}
.no-trip-card{background:var(--bg-card);border:2px dashed var(--border-color);border-radius:var(--radius-lg);padding:32px 20px;text-align:center;margin-bottom:12px}
.no-trip-icon{font-size:2.5rem;margin-bottom:12px;opacity:0.5}.no-trip-text{font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px}
.landing-actions{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.action-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px 24px;border:none;border-radius:var(--radius-md);cursor:pointer;font-family:var(--font-sans);font-weight:500;font-size:0.95rem;transition:all var(--transition)}
.action-btn-primary{background:var(--accent-gradient);color:white;box-shadow:0 4px 16px rgba(201,75,75,0.2)}
.action-btn-primary:active{transform:scale(0.98)}
.action-btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color)}
.action-btn-secondary:active{background:var(--bg-card-hover);transform:scale(0.98)}
.trips-page,.settings-page{padding:20px 16px;max-width:480px;margin:0 auto}
.page-title{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:20px;padding:8px 0}
.trips-list{display:flex;flex-direction:column;gap:12px}
.trip-list-item{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:18px;cursor:pointer;transition:all var(--transition);backdrop-filter:blur(20px)}
.trip-list-item:active{transform:scale(0.98);background:var(--bg-card-hover)}
.trip-list-name{font-family:var(--font-serif);font-size:1.05rem;font-weight:600;margin-bottom:4px}
.trip-list-dates{font-size:0.8rem;color:var(--text-secondary)}.trip-list-status{margin-top:8px}
.empty-trips{text-align:center;padding:48px 20px;color:var(--text-tertiary)}.empty-trips-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.hub-page{padding:20px 16px calc(20px + var(--safe-bottom));max-width:480px;margin:0 auto}
.hub-header{text-align:center;padding:16px 0 20px}
.hub-trip-name{font-family:var(--font-serif);font-size:1.5rem;font-weight:700;margin-bottom:2px;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hub-trip-dates{font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px}.hub-trip-status{display:inline-flex;margin-top:4px}
.hub-zen{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:20px 24px;margin-bottom:16px;text-align:center;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.hub-zen-text{font-family:var(--font-serif);font-size:0.95rem;font-weight:400;color:var(--text-secondary);line-height:1.6;font-style:italic}
.hub-zen-attr{font-size:0.7rem;color:var(--text-tertiary);margin-top:8px;font-style:normal}
.hub-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.hub-action-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:20px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);cursor:pointer;transition:all var(--transition);font-family:var(--font-sans);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.hub-action-btn:active{transform:scale(0.97);background:var(--bg-card-hover)}
.hub-action-btn .ha-icon{font-size:1.6rem}.hub-action-btn .ha-label{font-size:0.85rem;font-weight:500;color:var(--text-primary)}.hub-action-btn .ha-sub{font-size:0.7rem;color:var(--text-tertiary)}
.hub-action-btn.primary-action{background:var(--accent-gradient);border-color:transparent}
.hub-action-btn.primary-action .ha-label,.hub-action-btn.primary-action .ha-icon{color:white;-webkit-text-fill-color:white}
.hub-action-btn.primary-action .ha-sub{color:rgba(255,255,255,0.7)}
.hub-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.hub-stat{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:14px 10px;text-align:center;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.hub-stat-value{font-size:1.4rem;font-weight:700;line-height:1.2}.hub-stat-label{font-size:0.65rem;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-tertiary);margin-top:2px}
.hub-section-title{font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);margin-bottom:10px;padding:0 4px}
.hub-calendar{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:16px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);overflow:hidden}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-nav-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:1.1rem;color:var(--text-secondary);transition:background var(--transition-fast)}
.cal-nav-btn:active{background:var(--bg-secondary)}.cal-nav-btn:disabled{opacity:0.25;cursor:default}
.cal-month-label{font-family:var(--font-serif);font-size:1rem;font-weight:600;text-align:center}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px}
.cal-weekday{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);text-align:center;padding:4px 0}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day{position:relative;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:400;color:var(--text-tertiary);border-radius:var(--radius-sm);cursor:default;transition:all var(--transition-fast)}
.cal-day.in-trip{color:var(--text-secondary);font-weight:500}.cal-day.in-trip.clickable{cursor:pointer}.cal-day.in-trip.clickable:active{background:var(--bg-secondary)}
.cal-day.today{font-weight:700;color:var(--accent-primary)}.cal-day.today::after{content:'';position:absolute;bottom:2px;width:4px;height:4px;border-radius:50%;background:var(--accent-primary)}
.cal-day.has-entries{background:var(--bg-secondary)}.cal-day.has-entries.in-trip{background:rgba(201,75,75,0.1)}
.cal-day.has-entries .cal-dot{position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--accent-primary)}
.cal-day.today.has-entries::after{display:none}
.cal-today-btn{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:10px;padding:10px;width:100%;background:var(--bg-secondary);border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-sans);font-size:0.8rem;font-weight:500;color:var(--text-secondary);transition:all var(--transition-fast)}
.cal-today-btn:active{background:var(--bg-tertiary)}
.cal-swipe-container{position:relative;overflow:hidden;touch-action:pan-y}.cal-swipe-track{display:flex;transition:transform 300ms cubic-bezier(0.4,0,0.2,1)}.cal-swipe-track.no-transition{transition:none}.cal-month-pane{flex:0 0 100%;min-width:100%}
/* === JOURNAL PAGE === */
.journal-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.journal-date-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:8px}
.journal-date-nav button{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;font-size:1.1rem;color:var(--text-primary);transition:all var(--transition-fast);font-family:var(--font-sans)}
.journal-date-nav button:active{background:var(--bg-card-hover);transform:scale(0.95)}
.journal-date-nav button:disabled{opacity:0.3;cursor:default;transform:none}
.journal-date-center{flex:1;text-align:center}
.journal-date-main{font-family:var(--font-serif);font-size:1.1rem;font-weight:600}
.journal-date-sub{font-size:0.75rem;color:var(--text-tertiary)}
.journal-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.journal-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.journal-empty p{font-size:0.9rem;margin-bottom:16px}
.entry-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:18px;margin-bottom:12px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition)}
.entry-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
.entry-card-title{font-family:var(--font-serif);font-size:1.05rem;font-weight:600;flex:1}
.entry-card-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.entry-cat-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;padding:3px 10px;border-radius:var(--radius-full);background:var(--bg-secondary);color:var(--text-secondary);font-weight:500}
.entry-time-badge{font-size:0.75rem;color:var(--text-tertiary)}
.entry-card-actions{display:flex;gap:4px}
.entry-card-actions button{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:0.9rem;color:var(--text-tertiary);transition:all var(--transition-fast)}
.entry-card-actions button:active{background:var(--bg-secondary)}
.entry-photos{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px}
.entry-photo{aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;position:relative}
.entry-photo img{width:100%;height:100%;object-fit:cover;display:block}
.entry-photo-more{position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:1.1rem}
.entry-maps-link{display:inline-flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--accent-primary);text-decoration:none;padding:6px 12px;background:rgba(201,75,75,0.08);border-radius:var(--radius-full);margin-bottom:8px}
.entry-section{margin-top:8px}
.entry-section-toggle{display:flex;align-items:center;gap:8px;width:100%;background:none;border:none;padding:8px 0;cursor:pointer;font-family:var(--font-sans);font-size:0.8rem;font-weight:500;color:var(--text-secondary);transition:color var(--transition-fast)}
.entry-section-toggle:active{color:var(--text-primary)}
.entry-section-toggle .arrow{transition:transform var(--transition-fast);font-size:0.7rem}
.entry-section-toggle.open .arrow{transform:rotate(90deg)}
.entry-section-content{display:none;padding:6px 0 4px 24px;font-size:0.85rem;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap}
.entry-section-toggle.open+.entry-section-content{display:block}
.entry-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.entry-tag{font-size:0.7rem;padding:3px 10px;border-radius:var(--radius-full);background:var(--bg-secondary);color:var(--text-secondary);font-weight:500}
.entry-meals{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color)}
.entry-meal-item{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:0.85rem}
.entry-meal-item img{width:36px;height:36px;border-radius:var(--radius-sm);object-fit:cover}
.entry-meal-name{font-weight:500;flex:1}
.entry-nested{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color)}
.nested-event{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-color)}
.nested-event:last-child{border-bottom:none}
.nested-event img{width:40px;height:40px;border-radius:var(--radius-sm);object-fit:cover;flex-shrink:0}
.nested-event-info{flex:1}
.nested-event-name{font-weight:500;font-size:0.85rem}
.nested-event-note{font-size:0.8rem;color:var(--text-secondary)}
.nested-event-time{font-size:0.7rem;color:var(--text-tertiary)}
.entry-reflection{margin-top:12px;padding:12px 14px;background:var(--bg-secondary);border-radius:var(--radius-sm);border-left:3px solid var(--accent-primary)}
.entry-reflection-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);margin-bottom:4px}
.entry-reflection-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap}
.entry-reflection-date{font-size:0.7rem;color:var(--text-tertiary);margin-top:4px}
.journal-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.journal-fab:active{transform:scale(0.93)}
.form-textarea{width:100%;padding:14px 16px;border:1px solid var(--border-color);border-radius:var(--radius-sm);font-family:var(--font-sans);font-size:0.95rem;background:var(--bg-secondary);color:var(--text-primary);transition:border-color var(--transition-fast),background var(--transition-slow),color var(--transition-slow);-webkit-appearance:none;resize:vertical;min-height:80px;line-height:1.5}
.form-textarea:focus{outline:none;border-color:var(--accent-primary)}
.form-textarea::placeholder{color:var(--text-tertiary)}
.form-hint{font-size:0.75rem;color:var(--text-tertiary);margin-top:4px;font-style:italic}
.form-select{width:100%;padding:14px 16px;border:1px solid var(--border-color);border-radius:var(--radius-sm);font-family:var(--font-sans);font-size:1rem;background:var(--bg-secondary);color:var(--text-primary);-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b6f5c' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
.form-select:focus{outline:none;border-color:var(--accent-primary)}
.suggested-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.suggested-tag{font-size:0.75rem;padding:4px 12px;border-radius:var(--radius-full);background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer;border:1.5px solid transparent;transition:all var(--transition-fast);font-family:var(--font-sans)}
.suggested-tag.selected{border-color:var(--accent-primary);background:rgba(201,75,75,0.1);color:var(--accent-primary)}
.suggested-tag:active{transform:scale(0.95)}
/* === TAG STICKERS === */
.sticker-picker{margin-top:10px}
.sticker-picker-tabs{display:flex;gap:0;margin-bottom:10px;background:var(--bg-secondary);border-radius:var(--radius-md);overflow:hidden;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.sticker-picker-tabs::-webkit-scrollbar{display:none}
.sticker-tab{flex:0 0 auto;padding:9px 14px;font-size:0.72rem;font-weight:500;cursor:pointer;border:none;background:none;font-family:var(--font-sans);color:var(--text-tertiary);transition:all var(--transition-fast);white-space:nowrap;display:flex;align-items:center;gap:4px}
.sticker-tab.active{background:var(--bg-card);color:var(--text-primary);font-weight:600;box-shadow:var(--shadow-sm);border-radius:var(--radius-sm)}
.sticker-tab:active{transform:scale(0.95)}
.sticker-grid{display:flex;flex-wrap:wrap;gap:6px;padding:2px 0}
.sticker-btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border-radius:var(--radius-full);border:1.5px solid var(--border-color);background:var(--bg-card);cursor:pointer;font-family:var(--font-sans);font-size:0.72rem;font-weight:500;color:var(--text-secondary);transition:all var(--transition-fast);-webkit-tap-highlight-color:transparent}
.sticker-btn:active{transform:scale(0.93)}
.sticker-btn.selected{border-color:var(--accent-primary);background:rgba(201,75,75,0.1);color:var(--accent-primary);box-shadow:0 0 0 1px rgba(201,75,75,0.12)}
.sticker-btn .sticker-emoji{font-size:0.85rem;line-height:1}
.sticker-selected-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;min-height:0;transition:min-height var(--transition)}
.sticker-selected-row:empty{margin-top:0}
.sticker-badge{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:var(--radius-full);background:var(--bg-secondary);font-size:0.68rem;font-weight:500;color:var(--text-secondary);border:1px solid var(--border-color);cursor:pointer;transition:all var(--transition-fast)}
.sticker-badge:active{transform:scale(0.93)}
.sticker-badge .sticker-emoji{font-size:0.75rem}
.sticker-badge-remove{font-size:0.6rem;margin-left:2px;opacity:0.4}
/* Entry card sticker display */
.entry-stickers{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.entry-sticker{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--radius-full);background:var(--bg-secondary);font-size:0.68rem;font-weight:500;color:var(--text-secondary);border:1px solid var(--border-color)}
.entry-sticker .sticker-emoji{font-size:0.72rem}
/* Journal sticker filter bar */
.journal-sticker-filter{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
.journal-sticker-filter::-webkit-scrollbar{display:none}
.jsf-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.72rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all var(--transition-fast)}
.jsf-btn:active{transform:scale(0.95)}
.jsf-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
.jsf-btn .sticker-emoji{font-size:0.8rem}
.photo-upload-area{border:2px dashed var(--border-color);border-radius:var(--radius-md);padding:20px;text-align:center;cursor:pointer;transition:all var(--transition-fast)}
.photo-upload-area:active{border-color:var(--accent-primary);background:rgba(201,75,75,0.04)}
.photo-upload-area-icon{font-size:1.5rem;margin-bottom:4px}
.photo-upload-area-text{font-size:0.8rem;color:var(--text-tertiary)}
.photo-preview-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.photo-preview-item{position:relative;aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden}
.photo-preview-item img{width:100%;height:100%;object-fit:cover}
.photo-preview-remove{position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,0.6);color:white;border:none;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center}
.add-nested-btn,.add-meal-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:10px;background:none;border:1px dashed var(--border-color);border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-sans);font-size:0.85rem;color:var(--text-secondary);margin-top:8px;transition:all var(--transition-fast)}
.add-nested-btn:active,.add-meal-btn:active{background:var(--bg-secondary);border-color:var(--accent-primary)}
.form-section-header{display:flex;align-items:center;gap:8px;padding:10px 0;cursor:pointer;font-size:0.9rem;font-weight:500;color:var(--text-secondary);border:none;background:none;width:100%;text-align:left;font-family:var(--font-sans)}
.form-section-header .chevron{transition:transform var(--transition-fast);font-size:0.7rem}
.form-section-header.open .chevron{transform:rotate(90deg)}
.form-section-body{display:none}.form-section-header.open+.form-section-body{display:block}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:var(--z-modal);display:flex;align-items:flex-end;justify-content:center;pointer-events:none;transition:background var(--transition)}
.modal-overlay.open{background:rgba(0,0,0,0.35);pointer-events:auto}
.modal-sheet{width:100%;max-width:480px;max-height:92vh;background:var(--bg-primary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;transform:translateY(100%);transition:transform var(--transition),background var(--transition-slow);overflow-y:auto;overscroll-behavior:contain}
.modal-overlay.open .modal-sheet{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--bg-tertiary);border-radius:var(--radius-full);margin:12px auto 0}
.modal-sheet-header{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg-primary);z-index:1;transition:background var(--transition-slow)}
.modal-sheet-header h2{font-size:1.2rem}
.modal-close-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);border:none;border-radius:50%;cursor:pointer;font-size:1rem;color:var(--text-secondary)}
.modal-body{padding:0 20px 32px}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:0.8rem;font-weight:500;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:14px 16px;border:1px solid var(--border-color);border-radius:var(--radius-sm);font-family:var(--font-sans);font-size:1rem;background:var(--bg-secondary);color:var(--text-primary);transition:border-color var(--transition-fast),background var(--transition-slow),color var(--transition-slow);-webkit-appearance:none}
.form-input:focus{outline:none;border-color:var(--accent-primary)}
.form-input::placeholder{color:var(--text-tertiary)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-btn{width:100%;padding:16px;border:none;border-radius:var(--radius-md);font-family:var(--font-sans);font-size:1rem;font-weight:500;cursor:pointer;transition:all var(--transition)}
.form-btn-primary{background:var(--accent-gradient);color:white}.form-btn-primary:active{transform:scale(0.98)}
.form-btn-danger{background:none;color:var(--danger);border:1px solid var(--danger);margin-top:8px}.form-btn-danger:active{background:rgba(201,75,75,0.08)}
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:var(--z-lightbox);display:none;align-items:center;justify-content:center;cursor:pointer}
.lightbox.open{display:flex}
.lightbox img{max-width:95vw;max-height:90vh;object-fit:contain;border-radius:4px}
.lightbox-close{position:absolute;top:16px;right:16px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.15);border:none;color:white;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.toast-container{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:var(--z-toast);display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--text-primary);color:var(--bg-primary);padding:12px 20px;border-radius:var(--radius-full);font-size:0.85rem;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn 300ms ease forwards;white-space:nowrap}
.toast.out{animation:toastOut 200ms ease forwards}
@keyframes toastIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateY(-8px)}}
.settings-group{margin-bottom:24px}
.settings-group-title{font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);margin-bottom:8px;padding:0 4px}
.settings-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);overflow:hidden}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background var(--transition-fast)}
.settings-item:last-child{border-bottom:none}.settings-item:active{background:var(--bg-secondary)}
.settings-item-left{display:flex;align-items:center;gap:12px}.settings-item-icon{font-size:1.2rem}.settings-item-label{font-size:0.9rem}.settings-item-value{font-size:0.85rem;color:var(--text-tertiary)}
.toggle{width:48px;height:28px;background:var(--bg-tertiary);border-radius:var(--radius-full);position:relative;cursor:pointer;transition:background var(--transition);flex-shrink:0;border:none;padding:0}
.toggle.on{background:var(--success)}.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:white;border-radius:50%;transition:transform var(--transition);box-shadow:0 1px 3px rgba(0,0,0,0.2)}.toggle.on::after{transform:translateX(20px)}
/* === PURCHASES === */
.purchases-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.purchases-header{margin-bottom:16px}
.purchases-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.purchases-header p{font-size:0.8rem;color:var(--text-tertiary)}
.purchases-search{position:relative;margin-bottom:12px}
.purchases-search input{width:100%;padding:12px 16px 12px 40px;border:1px solid var(--border-color);border-radius:var(--radius-full);font-family:var(--font-sans);font-size:0.9rem;background:var(--bg-card);color:var(--text-primary);-webkit-appearance:none;transition:border-color var(--transition-fast),background var(--transition-slow),color var(--transition-slow)}
.purchases-search input:focus{outline:none;border-color:var(--accent-primary)}
.purchases-search input::placeholder{color:var(--text-tertiary)}
.purchases-search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:1rem;color:var(--text-tertiary);pointer-events:none}
.purchases-filters{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
.purchases-filters::-webkit-scrollbar{display:none}
.pf-btn{padding:7px 14px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all var(--transition-fast);flex-shrink:0}
.pf-btn:active{transform:scale(0.95)}
.pf-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
.purchases-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.ps-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:12px;text-align:center;backdrop-filter:blur(20px)}
.ps-card-value{font-size:1.2rem;font-weight:700;line-height:1.2}
.ps-card-label{font-size:0.65rem;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-tertiary);margin-top:2px}
.purchase-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition);cursor:pointer}
.purchase-card:active{background:var(--bg-card-hover)}
.purchase-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.purchase-card-info{flex:1;min-width:0}
.purchase-card-name{font-family:var(--font-serif);font-size:0.95rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.purchase-card-store{font-size:0.8rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.purchase-card-date{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.purchase-card-price{text-align:right;flex-shrink:0}
.purchase-card-amount{font-size:1rem;font-weight:700}
.purchase-card-converted{font-size:0.7rem;color:var(--text-tertiary)}
.purchase-card-detail{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
.purchase-card.expanded .purchase-card-detail{display:block}
.purchase-card-photo{width:100%;border-radius:var(--radius-sm);margin-bottom:10px;max-height:200px;object-fit:cover}
.purchase-card-notes{font-size:0.85rem;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap;margin-bottom:10px}
.purchase-card-link{display:inline-flex;align-items:center;gap:4px;font-size:0.8rem;color:var(--accent-primary);background:rgba(201,75,75,0.08);padding:4px 12px;border-radius:var(--radius-full);cursor:pointer;border:none;font-family:var(--font-sans);margin-bottom:8px}
.purchase-card-actions{display:flex;gap:8px;margin-top:8px}
.purchase-card-actions button{flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.purchase-card-actions button:active{background:var(--bg-tertiary)}
.purchase-card-actions button.danger{color:var(--danger);border-color:rgba(201,75,75,0.2)}
.purchase-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.purchase-fab:active{transform:scale(0.93)}
.purchases-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.purchases-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.purchases-empty p{font-size:0.9rem;margin-bottom:16px}
.about-page{padding:20px 16px;max-width:480px;margin:0 auto;text-align:center}
.about-logo{font-family:var(--font-serif);font-size:2.5rem;font-weight:700;margin:40px 0 4px;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.about-subtitle{font-size:0.85rem;color:var(--text-tertiary);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:32px}
.about-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.7;max-width:320px;margin:0 auto 24px}
.about-version{font-size:0.75rem;color:var(--text-tertiary);margin-top:40px}
.fade-in{animation:fadeIn 500ms ease forwards}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.stagger-1{animation-delay:50ms}.stagger-2{animation-delay:100ms}.stagger-3{animation-delay:150ms}.stagger-4{animation-delay:200ms}.stagger-5{animation-delay:250ms}
/* Currency Calculator */
.cc-header{text-align:center;padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid var(--border-color)}
.cc-rate-display{font-size:0.85rem;color:var(--text-secondary);margin-bottom:4px}
.cc-rate-value{font-size:1.4rem;font-weight:700;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.cc-rate-updated{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.cc-fields{display:flex;flex-direction:column;gap:0;align-items:center;margin-bottom:20px}
.cc-field{width:100%;position:relative}
.cc-field-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.cc-field-label .cc-flag{font-size:1rem}
.cc-field input{width:100%;padding:16px 16px 16px 44px;border:1px solid var(--border-color);border-radius:var(--radius-sm);font-family:var(--font-sans);font-size:1.3rem;font-weight:600;background:var(--bg-secondary);color:var(--text-primary);-webkit-appearance:none;transition:border-color var(--transition-fast)}
.cc-field input:focus{outline:none;border-color:var(--accent-primary)}
.cc-field input::placeholder{color:var(--text-tertiary);font-weight:400}
.cc-field-symbol{position:absolute;left:16px;bottom:16px;font-size:1.3rem;font-weight:600;color:var(--text-tertiary);pointer-events:none}
.cc-swap-row{display:flex;justify-content:center;margin:-6px 0;z-index:1;position:relative}
.cc-swap-btn{width:44px;height:44px;border-radius:50%;background:var(--bg-card);border:2px solid var(--border-color);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--text-secondary);transition:all var(--transition-fast);box-shadow:var(--shadow-sm)}
.cc-swap-btn:active{transform:scale(0.9) rotate(180deg);border-color:var(--accent-primary);color:var(--accent-primary)}
.cc-actions{display:flex;flex-direction:column;gap:8px}
.cc-action-btn{padding:14px;border:none;border-radius:var(--radius-md);font-family:var(--font-sans);font-size:0.9rem;font-weight:500;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:8px}
.cc-action-btn.primary{background:var(--accent-gradient);color:white}
.cc-action-btn.primary:active{transform:scale(0.98)}
.cc-action-btn.secondary{background:var(--bg-secondary);color:var(--text-secondary)}
.cc-action-btn.secondary:active{background:var(--bg-tertiary)}
.cc-no-rate{text-align:center;padding:24px 16px;color:var(--text-secondary)}
.cc-no-rate-icon{font-size:2rem;margin-bottom:8px;opacity:0.4}
.cc-no-rate p{font-size:0.85rem;margin-bottom:16px}
::-webkit-scrollbar{width:0;height:0}::selection{background:var(--accent-primary);color:white}
/* === LANGUAGE NOTES === */
.language-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.language-header{margin-bottom:16px}
.language-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.language-header p{font-size:0.8rem;color:var(--text-tertiary)}
.language-search{position:relative;margin-bottom:12px}
.language-search input{width:100%;padding:12px 16px 12px 40px;border:1px solid var(--border-color);border-radius:var(--radius-full);font-family:var(--font-sans);font-size:0.9rem;background:var(--bg-card);color:var(--text-primary);-webkit-appearance:none;transition:border-color var(--transition-fast),background var(--transition-slow),color var(--transition-slow)}
.language-search input:focus{outline:none;border-color:var(--accent-primary)}
.language-search input::placeholder{color:var(--text-tertiary)}
.language-search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:1rem;color:var(--text-tertiary);pointer-events:none}
.lang-tags-bar{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
.lang-tags-bar::-webkit-scrollbar{display:none}
.lang-tag-btn{padding:7px 14px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all var(--transition-fast);flex-shrink:0}
.lang-tag-btn:active{transform:scale(0.95)}
.lang-tag-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
.lang-sort-bar{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none}
.lang-sort-bar::-webkit-scrollbar{display:none}
.lang-sort-btn{padding:6px 12px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.7rem;font-weight:500;color:var(--text-tertiary);cursor:pointer;white-space:nowrap;transition:all var(--transition-fast);flex-shrink:0}
.lang-sort-btn.active{background:var(--bg-secondary);color:var(--text-primary);border-color:var(--accent-primary)}
.phrase-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition)}
.phrase-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px}
.phrase-english{font-size:0.95rem;font-weight:500;color:var(--text-primary);flex:1}
.phrase-fav-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;font-size:1.1rem;flex-shrink:0;transition:transform var(--transition-fast);color:var(--text-tertiary)}
.phrase-fav-btn.fav{color:#e8a030}
.phrase-fav-btn:active{transform:scale(0.85)}
.phrase-romaji{font-size:0.85rem;color:var(--text-secondary);margin-bottom:4px;font-style:italic}
.phrase-japanese{font-size:1.1rem;font-weight:500;margin-bottom:8px}
.phrase-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
.phrase-tag{font-size:0.65rem;padding:2px 8px;border-radius:var(--radius-full);background:var(--bg-secondary);color:var(--text-tertiary)}
.phrase-actions{display:flex;gap:6px;flex-wrap:wrap}
.phrase-action-btn{padding:8px 14px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);display:flex;align-items:center;gap:4px}
.phrase-action-btn:active{background:var(--bg-tertiary);transform:scale(0.95)}
.phrase-action-btn.show-btn{background:var(--accent-gradient);color:white;border-color:transparent}
.phrase-action-btn.show-btn:active{opacity:0.9}
.phrase-count{font-size:0.7rem;color:var(--text-tertiary);text-align:center;padding:8px 0}
.language-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.language-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.lang-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.lang-fab:active{transform:scale(0.93)}
/* === SOUVENIRS === */
.souvenirs-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.souvenirs-header{margin-bottom:16px}
.souvenirs-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.souvenirs-header p{font-size:0.8rem;color:var(--text-tertiary)}
.souvenirs-search{position:relative;margin-bottom:12px}
.souvenirs-search input{width:100%;padding:12px 16px 12px 40px;border:1px solid var(--border-color);border-radius:var(--radius-full);font-family:var(--font-sans);font-size:0.9rem;background:var(--bg-card);color:var(--text-primary);-webkit-appearance:none;transition:border-color var(--transition-fast),background var(--transition-slow),color var(--transition-slow)}
.souvenirs-search input:focus{outline:none;border-color:var(--accent-primary)}
.souvenirs-search input::placeholder{color:var(--text-tertiary)}
.souvenirs-search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:1rem;color:var(--text-tertiary);pointer-events:none}
.souvenirs-filters{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
.souvenirs-filters::-webkit-scrollbar{display:none}
.sf-btn{padding:7px 14px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all var(--transition-fast);flex-shrink:0}
.sf-btn:active{transform:scale(0.95)}
.sf-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
.souvenirs-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.ss-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:12px;text-align:center;backdrop-filter:blur(20px)}
.ss-card-value{font-size:1.2rem;font-weight:700;line-height:1.2}
.ss-card-label{font-size:0.65rem;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-tertiary);margin-top:2px}
.souvenir-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition);cursor:pointer}
.souvenir-card:active{background:var(--bg-card-hover)}
.souvenir-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.souvenir-card-info{flex:1;min-width:0}
.souvenir-card-name{font-family:var(--font-serif);font-size:0.95rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.souvenir-card-recipient{font-size:0.8rem;color:var(--accent-primary);font-weight:500}
.souvenir-card-store{font-size:0.8rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.souvenir-card-date{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.souvenir-card-price{text-align:right;flex-shrink:0}
.souvenir-card-amount{font-size:1rem;font-weight:700}
.souvenir-card-converted{font-size:0.7rem;color:var(--text-tertiary)}
.souvenir-card-status{display:inline-flex;align-items:center;gap:4px;font-size:0.7rem;padding:2px 8px;border-radius:var(--radius-full);font-weight:500;margin-top:4px}
.souvenir-card-status.purchased{background:rgba(104,159,99,0.12);color:var(--success)}
.souvenir-card-status.planned{background:rgba(218,165,32,0.12);color:var(--warning)}
.souvenir-card-detail{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
.souvenir-card.expanded .souvenir-card-detail{display:block}
.souvenir-card-photo{width:100%;border-radius:var(--radius-sm);margin-bottom:10px;max-height:200px;object-fit:cover}
.souvenir-card-notes{font-size:0.85rem;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap;margin-bottom:10px}
.souvenir-card-actions{display:flex;gap:8px;margin-top:8px}
.souvenir-card-actions button{flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.souvenir-card-actions button:active{background:var(--bg-tertiary)}
.souvenir-card-actions button.danger{color:var(--danger);border-color:rgba(201,75,75,0.2)}
.souvenir-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.souvenir-fab:active{transform:scale(0.93)}
.souvenirs-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.souvenirs-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.souvenirs-empty p{font-size:0.9rem;margin-bottom:16px}
.souvenirs-recipient-section{margin-bottom:16px}
.souvenirs-recipient-header{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;margin-bottom:8px}
.souvenirs-recipient-name{font-family:var(--font-serif);font-size:0.95rem;font-weight:600;display:flex;align-items:center;gap:6px}
.souvenirs-recipient-total{font-size:0.75rem;color:var(--text-tertiary)}
/* Quick Show Overlay */
.quickshow-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:var(--z-lightbox);display:none;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;padding:24px}
.quickshow-overlay.open{display:flex}
.quickshow-text{font-size:52px;font-weight:600;color:white;text-align:center;line-height:1.4;font-family:var(--font-sans);max-width:90vw;word-break:keep-all}
.quickshow-hint{font-size:0.8rem;color:rgba(255,255,255,0.4);margin-top:32px}
.quickshow-close{position:absolute;top:16px;right:16px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.12);border:none;color:white;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* === RECIPIENT PROFILES === */
.recipient-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border-color);flex-shrink:0}
.recipient-avatar-sm{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1.5px solid var(--border-color)}
.recipient-avatar-lg{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-primary)}
.recipient-avatar-placeholder{width:32px;height:32px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;border:2px solid var(--border-color)}
.recipient-avatar-placeholder.lg{width:64px;height:64px;font-size:1.4rem}
.sf-btn-with-avatar{display:flex;align-items:center;gap:6px;padding:5px 12px 5px 5px}
.recipient-profile-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;backdrop-filter:blur(20px);text-align:center}
.recipient-profile-top{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:12px}
.recipient-profile-name{font-family:var(--font-serif);font-size:1.1rem;font-weight:600}
.recipient-profile-bio{font-size:0.8rem;color:var(--text-secondary);max-width:280px;margin:0 auto}
.recipient-budget-bar{height:8px;background:var(--bg-tertiary);border-radius:var(--radius-full);overflow:hidden;margin:8px 0 4px}
.recipient-budget-fill{height:100%;border-radius:var(--radius-full);transition:width 600ms ease;background:var(--accent-gradient)}
.recipient-budget-fill.over{background:linear-gradient(135deg,var(--danger),#e06060)}
.recipient-budget-text{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-tertiary)}
.recipient-profile-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
.recipient-profile-actions button{padding:8px 16px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.75rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.recipient-profile-actions button:active{background:var(--bg-tertiary)}
/* === STAMPS === */
.stamps-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.stamps-header{margin-bottom:16px}
.stamps-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.stamps-header p{font-size:0.8rem;color:var(--text-tertiary)}
.stamps-tabs{display:flex;gap:0;margin-bottom:16px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);overflow:hidden}
.stamps-tab{flex:1;padding:12px;text-align:center;font-family:var(--font-sans);font-size:0.8rem;font-weight:500;cursor:pointer;border:none;background:none;color:var(--text-secondary);transition:all var(--transition-fast)}
.stamps-tab.active{background:var(--accent-gradient);color:white}
.stamps-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.stamp-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:14px;margin-bottom:10px;backdrop-filter:blur(20px);transition:all var(--transition);cursor:pointer}
.stamp-card:active{background:var(--bg-card-hover)}
.stamp-card-top{display:flex;align-items:flex-start;gap:10px}
.stamp-card-photo{width:60px;height:60px;border-radius:var(--radius-sm);object-fit:cover;flex-shrink:0}
.stamp-card-info{flex:1;min-width:0}
.stamp-card-name{font-family:var(--font-serif);font-size:0.9rem;font-weight:600}
.stamp-card-location{font-size:0.8rem;color:var(--text-secondary)}
.stamp-card-date{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.stamp-card-quest{display:inline-flex;align-items:center;gap:4px;font-size:0.65rem;padding:2px 8px;border-radius:var(--radius-full);background:rgba(218,165,32,0.12);color:var(--warning);font-weight:600;margin-top:4px}
.stamp-card-detail{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color)}
.stamp-card.expanded .stamp-card-detail{display:block}
.stamp-card-detail img{width:100%;border-radius:var(--radius-sm);margin-bottom:8px;max-height:200px;object-fit:cover}
.stamp-card-notes{font-size:0.85rem;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap;margin-bottom:8px}
.stamp-card-actions{display:flex;gap:8px}
.stamp-card-actions button{flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.stamp-card-actions button:active{background:var(--bg-tertiary)}
.stamp-card-actions button.danger{color:var(--danger);border-color:rgba(201,75,75,0.2)}
.stamp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.stamp-grid-item{aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;position:relative;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center}
.stamp-grid-item img{width:100%;height:100%;object-fit:cover}
.stamp-grid-item .stamp-grid-label{position:absolute;bottom:0;left:0;right:0;padding:4px;background:rgba(0,0,0,0.5);color:white;font-size:0.6rem;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stamp-plan-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-sm);margin-bottom:8px}
.stamp-plan-check{width:22px;height:22px;accent-color:var(--accent-primary);cursor:pointer;flex-shrink:0}
.stamp-plan-info{flex:1;min-width:0}
.stamp-plan-name{font-size:0.85rem;font-weight:500}
.stamp-plan-notes{font-size:0.75rem;color:var(--text-tertiary)}
.stamp-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.stamp-fab:active{transform:scale(0.93)}
.stamps-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.stamps-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
/* === GOSHUIN === */
.goshuin-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.goshuin-header{margin-bottom:16px}
.goshuin-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.goshuin-header p{font-size:0.8rem;color:var(--text-tertiary)}
.goshuin-gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.goshuin-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);overflow:hidden;cursor:pointer;transition:all var(--transition);backdrop-filter:blur(20px)}
.goshuin-card:active{transform:scale(0.98)}
.goshuin-card-photo{width:100%;aspect-ratio:3/4;object-fit:cover;display:block}
.goshuin-card-body{padding:10px 12px}
.goshuin-card-name{font-family:var(--font-serif);font-size:0.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.goshuin-card-loc{font-size:0.7rem;color:var(--text-tertiary)}
.goshuin-card-price{font-size:0.7rem;color:var(--text-secondary)}
.goshuin-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.goshuin-fab:active{transform:scale(0.93)}
.goshuin-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.goshuin-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
/* === TRANSPORT LOG === */
.transport-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.transport-header{margin-bottom:16px}
.transport-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.transport-header p{font-size:0.8rem;color:var(--text-tertiary)}
.transport-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px);transition:all var(--transition);cursor:pointer}
.transport-card:active{background:var(--bg-card-hover)}
.transport-card-route{font-family:var(--font-serif);font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px}
.transport-card-route .route-arrow{color:var(--accent-primary);font-weight:700}
.transport-card-type{display:inline-flex;align-items:center;gap:4px;font-size:0.7rem;padding:2px 10px;border-radius:var(--radius-full);background:var(--bg-secondary);color:var(--text-secondary);font-weight:500;margin-top:4px}
.transport-card-meta{font-size:0.75rem;color:var(--text-tertiary);margin-top:4px}
.transport-card-detail{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color)}
.transport-card.expanded .transport-card-detail{display:block}
.transport-card-obs{font-size:0.85rem;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap;margin-bottom:8px}
.transport-card-detail img{width:100%;border-radius:var(--radius-sm);margin-bottom:8px;max-height:200px;object-fit:cover}
.transport-card-actions{display:flex;gap:8px}
.transport-card-actions button{flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.transport-card-actions button:active{background:var(--bg-tertiary)}
.transport-card-actions button.danger{color:var(--danger);border-color:rgba(201,75,75,0.2)}
.transport-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.transport-fab:active{transform:scale(0.93)}
.transport-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.transport-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
/* === EDC PLANNER === */
.edc-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.edc-header{margin-bottom:16px}
.edc-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.edc-header p{font-size:0.8rem;color:var(--text-tertiary)}
.edc-tabs{display:flex;gap:0;margin-bottom:16px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);overflow:hidden}
.edc-tab{flex:1;padding:12px;text-align:center;font-family:var(--font-sans);font-size:0.8rem;font-weight:500;cursor:pointer;border:none;background:none;color:var(--text-secondary);transition:all var(--transition-fast)}
.edc-tab.active{background:var(--accent-gradient);color:white}
.edc-date-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:8px}
.edc-date-nav button{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;font-size:1rem;color:var(--text-secondary);transition:all var(--transition-fast);flex-shrink:0}
.edc-date-nav button:active{background:var(--bg-secondary)}
.edc-date-nav button:disabled{opacity:0.3;cursor:default}
.edc-date-label{text-align:center;flex:1}
.edc-date-label-day{font-family:var(--font-serif);font-size:1rem;font-weight:600}
.edc-date-label-sub{font-size:0.7rem;color:var(--text-tertiary)}
.edc-section{margin-bottom:20px}
.edc-section-title{font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);margin-bottom:10px;padding:0 4px;display:flex;align-items:center;justify-content:space-between}
.edc-section-title button{font-size:0.7rem;padding:4px 10px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.edc-section-title button:active{background:var(--bg-secondary)}
.edc-checklist{display:flex;flex-direction:column;gap:6px}
.edc-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-sm);transition:all var(--transition-fast);backdrop-filter:blur(20px)}
.edc-item.checked{opacity:0.55}
.edc-item.checked .edc-item-name{text-decoration:line-through}
.edc-item-check{width:22px;height:22px;accent-color:var(--accent-primary);cursor:pointer;flex-shrink:0}
.edc-item-info{flex:1;min-width:0}
.edc-item-name{font-size:0.9rem;font-weight:500}
.edc-item-weight{font-size:0.7rem;color:var(--text-tertiary)}
.edc-item-actions{display:flex;gap:2px}
.edc-item-actions button{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;font-size:0.8rem;color:var(--text-tertiary);border-radius:var(--radius-sm);transition:all var(--transition-fast)}
.edc-item-actions button:active{background:var(--bg-secondary)}
.edc-add-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:10px;background:none;border:1px dashed var(--border-color);border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-sans);font-size:0.85rem;color:var(--text-secondary);margin-top:8px;transition:all var(--transition-fast)}
.edc-add-btn:active{background:var(--bg-secondary);border-color:var(--accent-primary)}
.edc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.edc-stat{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:12px;text-align:center;backdrop-filter:blur(20px)}
.edc-stat-value{font-size:1.2rem;font-weight:700;line-height:1.2}
.edc-stat-label{font-size:0.65rem;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-tertiary);margin-top:2px}
.edc-templates{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.edc-template-btn{padding:8px 14px;border-radius:var(--radius-full);border:1px solid var(--border-color);background:var(--bg-card);font-family:var(--font-sans);font-size:0.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast)}
.edc-template-btn:active{transform:scale(0.95);background:var(--bg-secondary)}
.edc-template-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
.edc-empty{text-align:center;padding:36px 20px;color:var(--text-tertiary)}
.edc-empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:0.3}
.edc-empty p{font-size:0.85rem;margin-bottom:12px}
.edc-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.edc-fab:active{transform:scale(0.93)}
.edc-calendar-dots{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px}
.edc-cal-day{padding:6px 10px;border-radius:var(--radius-sm);background:var(--bg-card);border:1px solid var(--border-color);font-size:0.7rem;cursor:pointer;text-align:center;transition:all var(--transition-fast);min-width:48px}
.edc-cal-day:active{transform:scale(0.95)}
.edc-cal-day.has-custom{border-color:var(--accent-primary);background:rgba(201,75,75,0.08)}
.edc-cal-day.today{font-weight:700;color:var(--accent-primary)}
.edc-cal-day.selected{background:var(--accent-gradient);color:white;border-color:transparent}
.edc-weight-total{font-size:0.8rem;color:var(--text-secondary);text-align:right;padding:4px 4px 0;display:flex;align-items:center;justify-content:flex-end;gap:6px}
.edc-weight-total span{font-weight:600}
/* === MOMENTS GALLERY === */
.moments-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.moments-header{margin-bottom:16px}
.moments-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.moments-header p{font-size:0.8rem;color:var(--text-tertiary)}
.moments-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.moments-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px}
.moment-thumb{position:relative;aspect-ratio:4/5;overflow:hidden;border-radius:4px;cursor:pointer;background:var(--bg-tertiary)}
.moment-thumb img{width:100%;height:100%;object-fit:cover;transition:transform var(--transition)}
.moment-thumb:active img{transform:scale(1.03)}
.moment-thumb-caption{position:absolute;bottom:0;left:0;right:0;padding:6px 8px;background:linear-gradient(transparent,rgba(0,0,0,0.7));color:white;font-size:0.6rem;line-height:1.2;opacity:0;transition:opacity var(--transition)}
.moment-thumb:active .moment-thumb-caption{opacity:1}
.moment-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.moment-fab:active{transform:scale(0.93)}
.moments-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.moments-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
/* Moment Detail Overlay */
.moment-detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:var(--z-lightbox);display:none;flex-direction:column;align-items:center;justify-content:center;padding:16px}
.moment-detail-overlay.open{display:flex}
.moment-detail-close{position:absolute;top:12px;right:12px;width:44px;height:44px;background:rgba(255,255,255,0.15);border:none;border-radius:50%;color:white;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2}
.moment-detail-img{max-width:100%;max-height:60vh;border-radius:var(--radius-sm);object-fit:contain}
.moment-detail-location{color:rgba(255,255,255,0.7);font-size:0.75rem;margin-top:8px}
.moment-detail-date{color:rgba(255,255,255,0.5);font-size:0.7rem;margin-top:2px}
.moment-detail-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center}
.moment-detail-actions button{padding:10px 16px;border-radius:var(--radius-full);font-size:0.8rem;font-family:var(--font-sans);cursor:pointer;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;transition:all var(--transition-fast);display:flex;align-items:center;gap:6px}
.moment-detail-actions button:active{background:rgba(255,255,255,0.2)}
.moment-detail-actions button.danger{border-color:rgba(201,75,75,0.5);color:#ff8888}
/* === DAILY & TRIP REFLECTIONS === */
.daily-reflection-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:20px;margin-top:20px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-left:3px solid var(--accent-secondary)}
.daily-reflection-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.daily-reflection-title{font-family:var(--font-serif);font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px}
.daily-reflection-actions{display:flex;gap:4px}
.daily-reflection-actions button{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:0.9rem;color:var(--text-tertiary);transition:all var(--transition-fast)}
.daily-reflection-actions button:active{background:var(--bg-secondary)}
.daily-reflection-field{margin-bottom:12px}
.daily-reflection-field:last-child{margin-bottom:0}
.daily-reflection-field-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);margin-bottom:4px}
.daily-reflection-field-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap}
.daily-reflection-empty{display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;margin-top:20px;background:var(--bg-card);border:1px dashed var(--border-color);border-radius:var(--radius-lg);text-align:center}
.daily-reflection-empty-text{font-size:0.85rem;color:var(--text-tertiary)}
.daily-reflection-empty-btn{padding:10px 20px;border:none;border-radius:var(--radius-md);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.85rem;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);display:flex;align-items:center;gap:6px}
.daily-reflection-empty-btn:active{background:var(--bg-tertiary);transform:scale(0.98)}
.trip-reflection-section{margin-bottom:20px}
.trip-reflection-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:20px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);position:relative;overflow:hidden}
.trip-reflection-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent-gradient)}
.trip-reflection-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.trip-reflection-card-title{font-family:var(--font-serif);font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px}
.trip-reflection-card-sub{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.trip-reflection-card-actions button{padding:8px 14px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.75rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.trip-reflection-card-actions button:active{background:var(--bg-tertiary)}
.trip-reflection-empty{text-align:center;padding:24px;color:var(--text-tertiary);font-size:0.85rem}
/* === PEOPLE MET === */
.people-page{padding:20px 16px calc(80px + var(--safe-bottom));max-width:480px;margin:0 auto}
.people-header{margin-bottom:16px}
.people-header h1{font-family:var(--font-serif);font-size:1.5rem;margin-bottom:2px}
.people-header p{font-size:0.8rem;color:var(--text-tertiary)}
.people-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.people-search{margin-bottom:14px}
.people-search input{width:100%;padding:12px 16px;border:1px solid var(--border-color);border-radius:var(--radius-md);background:var(--bg-card);font-family:var(--font-sans);font-size:0.9rem;color:var(--text-primary);transition:border-color var(--transition-fast);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.people-search input:focus{outline:none;border-color:var(--accent-primary)}
.people-search input::placeholder{color:var(--text-tertiary)}
.people-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all var(--transition);cursor:pointer}
.people-card:active{background:var(--bg-card-hover)}
.people-card-top{display:flex;align-items:center;gap:12px}
.people-card-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;border:2px solid var(--border-color)}
.people-card-avatar img{width:100%;height:100%;object-fit:cover}
.people-card-info{flex:1;min-width:0}
.people-card-name{font-family:var(--font-serif);font-size:1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.people-card-where{font-size:0.75rem;color:var(--text-secondary);margin-top:1px;display:flex;align-items:center;gap:4px}
.people-card-date{font-size:0.7rem;color:var(--text-tertiary);margin-top:2px}
.people-card-detail{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
.people-card.expanded .people-card-detail{display:block}
.people-detail-section{margin-bottom:10px}
.people-detail-label{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);margin-bottom:3px}
.people-detail-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap}
.people-contact-link{display:inline-flex;align-items:center;gap:5px;font-size:0.8rem;color:var(--accent-primary);text-decoration:none;padding:4px 0}
.people-card-actions{display:flex;gap:8px;margin-top:10px}
.people-card-actions button{flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary);transition:all var(--transition-fast)}
.people-card-actions button:active{background:var(--bg-tertiary)}
.people-card-actions button.danger{color:var(--danger);border-color:rgba(201,75,75,0.2)}
.people-linked-entry{display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;color:var(--accent-primary);cursor:pointer;padding:4px 0;margin-top:4px}
.people-linked-entry:active{opacity:0.7}
.people-fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent-gradient);color:white;border:none;font-size:1.5rem;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(201,75,75,0.3);z-index:var(--z-nav);transition:all var(--transition)}
.people-fab:active{transform:scale(0.93)}
.people-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary)}
.people-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.3}
.people-bilingual-label{display:flex;flex-direction:column;gap:1px}
.people-bilingual-label .jp{font-size:0.7rem;color:var(--text-tertiary);font-weight:400}
/* === SHARE EDITOR === */
.share-modal{position:fixed;inset:0;background:var(--bg-primary);z-index:var(--z-modal);display:none;flex-direction:column;transition:background var(--transition-slow),color var(--transition-slow)}
.share-modal.open{display:flex}
.share-modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border-color);flex-shrink:0}
.share-modal-header h2{font-family:var(--font-serif);font-size:1.1rem}
.share-modal-close{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-primary);border-radius:var(--radius-sm)}
.share-modal-body{flex:1;overflow-y:auto;padding:16px;padding-bottom:calc(80px + var(--safe-bottom))}
.share-prompt{text-align:center;padding:40px 20px}
.share-prompt-title{font-family:var(--font-serif);font-size:1.2rem;margin-bottom:8px}
.share-prompt-sub{font-size:0.8rem;color:var(--text-tertiary);margin-bottom:24px}
.share-prompt-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.share-prompt-btns button{padding:14px 28px;border-radius:var(--radius-lg);font-family:var(--font-sans);font-size:0.9rem;font-weight:600;cursor:pointer;border:none;transition:all var(--transition-fast);display:flex;align-items:center;gap:8px}
.share-prompt-btns button:active{transform:scale(0.96)}
.share-btn-edit{background:var(--bg-card);border:1px solid var(--border-color)!important;color:var(--text-primary)}
.share-btn-quick{background:var(--accent-gradient);color:white}
/* Canvas Preview */
.share-canvas-wrap{position:relative;margin:0 auto 16px;max-width:340px;border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-lg);touch-action:none}
.share-canvas-wrap canvas{display:block;width:100%;height:auto}
/* Photo Strip */
.share-photos{margin-bottom:16px}
.share-photos-label{font-size:0.75rem;color:var(--text-tertiary);margin-bottom:8px;font-weight:500}
.share-photos-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.share-photos-scroll::-webkit-scrollbar{display:none}
.share-photo-thumb{width:64px;height:64px;border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;flex-shrink:0;border:3px solid transparent;transition:border-color var(--transition-fast);opacity:0.6}
.share-photo-thumb.selected{border-color:var(--accent-primary);opacity:1}
.share-photo-thumb img{width:100%;height:100%;object-fit:cover}
/* Frame Picker */
.share-frames{margin-bottom:16px}
.share-frames-label{font-size:0.75rem;color:var(--text-tertiary);margin-bottom:8px;font-weight:500}
.share-frames-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.share-frames-scroll::-webkit-scrollbar{display:none}
.share-frame-opt{width:60px;height:75px;border-radius:var(--radius-sm);cursor:pointer;flex-shrink:0;border:2px solid transparent;transition:all var(--transition-fast);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:0.55rem;color:var(--text-tertiary);padding:4px;background:var(--bg-card)}
.share-frame-opt.selected{border-color:var(--accent-primary);background:var(--bg-secondary)}
.share-frame-opt-preview{width:36px;height:44px;border-radius:3px;overflow:hidden}
/* Stickers */
.share-stickers{margin-bottom:16px}
.share-stickers-label{font-size:0.75rem;color:var(--text-tertiary);margin-bottom:8px;font-weight:500}
.share-sticker-row{display:flex;gap:10px;flex-wrap:wrap}
.share-sticker-btn{width:48px;height:48px;border-radius:var(--radius-sm);background:var(--bg-card);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;transition:all var(--transition-fast)}
.share-sticker-btn:active{transform:scale(0.9);background:var(--bg-secondary)}
/* Sticker on Canvas */
.canvas-sticker{position:absolute;font-size:2.5rem;cursor:grab;user-select:none;-webkit-user-select:none;touch-action:none;z-index:10;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.canvas-sticker.dragging{opacity:0.8;transform:scale(1.15)}
.canvas-sticker.selected{outline:2px dashed rgba(255,255,255,0.7);outline-offset:4px;border-radius:4px}
.canvas-sticker-delete{position:absolute;top:-12px;right:-12px;width:24px;height:24px;background:var(--danger);color:white;border:none;border-radius:50%;font-size:0.7rem;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:11}
.canvas-sticker.selected .canvas-sticker-delete{display:flex}
/* Share Action Bar */
.share-action-bar{display:flex;gap:8px;margin-top:16px}
.share-action-bar button{flex:1;padding:12px 8px;border-radius:var(--radius-md);font-family:var(--font-sans);font-size:0.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);transition:all var(--transition-fast);display:flex;flex-direction:column;align-items:center;gap:4px}
.share-action-bar button .sa-icon{font-size:1.2rem}
.share-action-bar button:active{background:var(--bg-card-hover);transform:scale(0.97)}
.share-action-bar button.sa-primary{background:var(--accent-gradient);color:white;border-color:transparent}
/* Share Type Tabs */
.share-type-tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.share-type-tabs::-webkit-scrollbar{display:none}
.share-type-tab{padding:10px 16px;border-radius:var(--radius-full);font-family:var(--font-sans);font-size:0.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-secondary);transition:all var(--transition-fast);white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:5px}
.share-type-tab:active{transform:scale(0.95)}
.share-type-tab.active{background:var(--accent-gradient);color:white;border-color:transparent}
/* Share Text Customization */
.share-text-section{margin-bottom:16px}
.share-text-section label{font-size:0.75rem;color:var(--text-tertiary);margin-bottom:4px;display:block;font-weight:500}
.share-text-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.share-text-input{flex:1;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);font-family:var(--font-sans);font-size:0.85rem;transition:border-color var(--transition-fast)}
.share-text-input:focus{outline:none;border-color:var(--accent-primary)}
.share-color-btn{width:36px;height:36px;border-radius:var(--radius-sm);border:2px solid var(--border-color);cursor:pointer;padding:0;transition:border-color var(--transition-fast);flex-shrink:0}
.share-color-btn:focus{border-color:var(--accent-primary)}
/* Share Sticker Tabs */
.share-sticker-tabs{display:flex;gap:4px;margin-bottom:10px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.share-sticker-tabs::-webkit-scrollbar{display:none}
.share-sticker-tab{padding:6px 12px;border-radius:var(--radius-full);font-size:0.7rem;font-weight:500;cursor:pointer;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-secondary);transition:all var(--transition-fast);white-space:nowrap;flex-shrink:0}
.share-sticker-tab.active{background:var(--accent-primary);color:white;border-color:transparent}
/* Layout Templates */
.share-layouts{margin-bottom:16px}
.share-layouts-label{font-size:0.75rem;color:var(--text-tertiary);margin-bottom:8px;font-weight:500}
.share-layouts-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.share-layouts-scroll::-webkit-scrollbar{display:none}
.share-layout-opt{width:64px;height:80px;border-radius:var(--radius-sm);cursor:pointer;flex-shrink:0;border:2px solid transparent;transition:all var(--transition-fast);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-size:0.55rem;color:var(--text-tertiary);padding:4px;background:var(--bg-card)}
.share-layout-opt.selected{border-color:var(--accent-primary);background:var(--bg-secondary)}
.share-layout-opt-icon{font-size:1.3rem}
/* Share Day Button */
.journal-share-day-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;font-size:1rem;color:var(--text-primary);transition:all var(--transition-fast);flex-shrink:0}
.journal-share-day-btn:active{background:var(--bg-card-hover);transform:scale(0.95)}
/* Hub share button */
.hub-share-btn{background:var(--accent-gradient);color:white;border:none;border-radius:var(--radius-lg);padding:14px 20px;font-family:var(--font-sans);font-weight:600;font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all var(--transition-fast);grid-column:1/-1}
.hub-share-btn:active{transform:scale(0.97);opacity:0.9}
/* Photo upload for share */
.share-photo-upload{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.share-photo-upload-btn{width:64px;height:64px;border-radius:var(--radius-sm);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;background:var(--bg-card);transition:all var(--transition-fast);flex-shrink:0}
.share-photo-upload-btn:active{background:var(--bg-secondary)}
    </style>
</head>
<body data-theme="spring" data-mode="light">
<nav class="top-bar">
    <div class="top-bar-left">
        <button class="nav-btn" id="backBtn" onclick="goBack()" style="display:none" aria-label="Back">â†</button>
        <button class="nav-btn" id="homeBtn" onclick="navigateTo('home')" style="display:none" aria-label="Home">ðŸ </button>
    </div>
    <div class="top-bar-center"><div class="top-bar-logo" onclick="navigateTo('home')">æ—…<span>Tabi</span></div></div>
    <div class="top-bar-right"><button class="nav-btn" onclick="toggleMenu()" aria-label="Menu">ðŸŒ¸</button></div>
</nav>
<div class="menu-overlay" id="menuOverlay" onclick="closeMenuOnOverlay(event)">
    <div class="menu-panel">
        <div class="menu-header"><h2>Menu</h2><button class="nav-btn" onclick="toggleMenu()">âœ•</button></div>
        <div class="menu-items">
            <button class="menu-item" onclick="navigateTo('home');toggleMenu()"><div class="menu-item-icon">ðŸ </div>Home</button>
            <button class="menu-item" onclick="navigateTo('trips');toggleMenu()"><div class="menu-item-icon">âœˆï¸</div>My Trips</button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="navigateTo('settings');toggleMenu()"><div class="menu-item-icon">âš™ï¸</div>Settings</button>
            <button class="menu-item" onclick="openPurchasesPage();toggleMenu()"><div class="menu-item-icon">ðŸ›ï¸</div>Purchases</button>
            <button class="menu-item" onclick="openLanguagePage();toggleMenu()"><div class="menu-item-icon">ðŸ—£ï¸</div>Language</button>
            <button class="menu-item" onclick="openSouvenirsPage();toggleMenu()"><div class="menu-item-icon">ðŸŽ</div>Souvenirs</button>
            <button class="menu-item" onclick="openStampsPage();toggleMenu()"><div class="menu-item-icon">ðŸŽ«</div>Stamps</button>
            <button class="menu-item" onclick="openGoshuinPage();toggleMenu()"><div class="menu-item-icon">â›©ï¸</div>Goshuin</button>
            <button class="menu-item" onclick="openTransportPage();toggleMenu()"><div class="menu-item-icon">ðŸš†</div>Transport</button>
            <button class="menu-item" onclick="openEdcPage();toggleMenu()"><div class="menu-item-icon">ðŸŽ’</div>EDC Planner</button>
            <button class="menu-item" onclick="openMomentsPage();toggleMenu()"><div class="menu-item-icon">âœ¨</div>Moments</button>
            <button class="menu-item" onclick="openPeoplePage();toggleMenu()"><div class="menu-item-icon">ðŸ‘¥</div>People Met</button>
            <button class="menu-item" onclick="openCurrencyCalculator();toggleMenu()"><div class="menu-item-icon">ðŸ’±</div>Currency Converter</button>
            <button class="menu-item" onclick="navigateTo('about');toggleMenu()"><div class="menu-item-icon">â„¹ï¸</div>About</button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="exportAllData();toggleMenu()"><div class="menu-item-icon">ðŸ“¥</div>Export Data</button>
            <button class="menu-item" onclick="importData();toggleMenu()"><div class="menu-item-icon">ðŸ“¤</div>Import Data</button>
        </div>
        <div class="menu-mode-section"><div class="mode-toggle-row"><div class="mode-toggle-label"><span id="modeIcon">ðŸŒ™</span><span id="modeLabel">Dark Mode</span></div><button class="toggle" id="darkModeToggle" onclick="toggleDarkMode()" role="switch"></button></div></div>
        <div class="menu-theme-section"><div class="menu-section-label">Theme</div><div class="theme-grid" id="themeGrid"></div></div>
    </div>
</div>
<div class="app-content">
    <div class="page active" id="page-home">
        <div class="landing-page">
            <div class="greeting-section fade-in stagger-1"><div class="greeting-text" id="greetingText"></div><div class="greeting-sub" id="greetingSub"></div></div>
            <div class="clock-section fade-in stagger-2"><div class="clock-time" id="clockTime"></div><div class="clock-date" id="clockDate"></div><div class="clock-timezone" id="clockTimezone"></div></div>
            <div class="widget-row fade-in stagger-3"><div class="widget-card weather-widget"><div class="widget-label"><span>â˜ï¸</span> Weather</div><div id="weatherContent"><div class="weather-placeholder"><span class="weather-placeholder-icon">ðŸŒ¤ï¸</span><span>Add API key in Settings</span></div></div></div></div>
            <div class="widget-row fade-in stagger-4"><div class="widget-card" onclick="openCurrencyCalculator()" style="cursor:pointer"><div class="widget-label"><span>ðŸ’´</span> AUD â†’ JPY</div><div id="currencyContent"><div class="currency-placeholder">Set rate in Settings</div></div></div><div class="widget-card"><div class="widget-label"><span>ðŸ“…</span> Trip Day</div><div id="tripDayContent"><div class="widget-value" style="font-size:1rem;color:var(--text-tertiary)">No active trip</div></div></div></div>
            <div id="activeTripContainer" class="fade-in stagger-5"></div>
            <div class="landing-actions fade-in stagger-5"><button class="action-btn action-btn-primary" onclick="openNewTripModal()">âœˆï¸ Create New Trip</button><button class="action-btn action-btn-secondary" onclick="navigateTo('trips')">ðŸ“‹ View All Trips</button></div>
        </div>
    </div>
    <div class="page" id="page-trips"><div class="trips-page"><h1 class="page-title">My Trips</h1><div id="tripsList"></div><div style="margin-top:16px"><button class="action-btn action-btn-primary" onclick="openNewTripModal()" style="width:100%">âœˆï¸ Create New Trip</button></div></div></div>
    <div class="page" id="page-hub"><div class="hub-page" id="hubContent"></div></div>
    <div class="page" id="page-journal"><div class="journal-page" id="journalContent"></div><button class="journal-fab" id="journalFab" onclick="openEntryModal()">+</button></div>
    <div class="page" id="page-settings"><div class="settings-page"><h1 class="page-title">Settings</h1>
        <div class="settings-group"><div class="settings-group-title">Currency</div><div class="settings-card"><div class="settings-item" onclick="openCurrencySettings()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ’´</span><span class="settings-item-label">Exchange Rate</span></div><span class="settings-item-value" id="settingsRateDisplay">Not set</span></div></div></div>
        <div class="settings-group"><div class="settings-group-title">Weather</div><div class="settings-card"><div class="settings-item" onclick="openWeatherSettings()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ”‘</span><span class="settings-item-label">API Key</span></div><span class="settings-item-value" id="settingsWeatherDisplay">Not set</span></div><div class="settings-item" onclick="openWeatherLocationSettings()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ“</span><span class="settings-item-label">Location</span></div><span class="settings-item-value" id="settingsLocationDisplay">Auto-detect</span></div></div></div>
        <div class="settings-group"><div class="settings-group-title">Data</div><div class="settings-card"><div class="settings-item" onclick="exportAllData()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ“¥</span><span class="settings-item-label">Export All Data</span></div><span class="settings-item-value">â†’</span></div><div class="settings-item" onclick="importData()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ“¤</span><span class="settings-item-label">Import Data</span></div><span class="settings-item-value">â†’</span></div><div class="settings-item" onclick="clearAllData()"><div class="settings-item-left"><span class="settings-item-icon">ðŸ—‘ï¸</span><span class="settings-item-label" style="color:var(--danger)">Clear All Data</span></div><span class="settings-item-value">â†’</span></div></div></div>
    </div></div>
    <div class="page" id="page-purchases"><div class="purchases-page" id="purchasesContent"></div><button class="purchase-fab" id="purchaseFab" onclick="openPurchaseModal()">+</button></div>
    <div class="page" id="page-language"><div class="language-page" id="languageContent"></div><button class="lang-fab" id="langFab" onclick="openAddPhraseModal()">+</button></div>
    <div class="page" id="page-souvenirs"><div class="souvenirs-page" id="souvenirsContent"></div><button class="souvenir-fab" id="souvenirFab" onclick="openSouvenirModal()">+</button></div>
    <div class="page" id="page-stamps"><div class="stamps-page" id="stampsContent"></div><button class="stamp-fab" id="stampFab" onclick="openStampModal()">+</button></div>
    <div class="page" id="page-goshuin"><div class="goshuin-page" id="goshuinContent"></div><button class="goshuin-fab" id="goshuinFab" onclick="openGoshuinModal()">+</button></div>
    <div class="page" id="page-transport"><div class="transport-page" id="transportContent"></div><button class="transport-fab" id="transportFab" onclick="openTransportModal()">+</button></div>
    <div class="page" id="page-edc"><div class="edc-page" id="edcContent"></div><button class="edc-fab" id="edcFab" onclick="openEdcItemModal()">+</button></div>
    <div class="page" id="page-moments"><div class="moments-page" id="momentsContent"></div></div>
    <div class="page" id="page-people"><div class="people-page" id="peopleContent"></div><button class="people-fab" id="peopleFab" onclick="openPersonModal()">+</button></div>
    <div class="page" id="page-about"><div class="about-page"><div class="about-logo">æ—… Tabi</div><div class="about-subtitle">Travel Companion</div><p class="about-text">A personal travel journal designed for intentional, meaningful journeys.</p><p class="about-text">Built with care for offline-first reliability, refined aesthetics, and the joy of travel.</p><div class="about-version">Version 9.0.0 â€” Daily & Trip Reflections</div></div></div>
</div>
<!-- Modals -->
<div class="modal-overlay" id="newTripModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>New Trip</h2><button class="modal-close-btn" onclick="closeNewTripModal()">âœ•</button></div><div class="modal-body"><form id="newTripForm" onsubmit="createTrip(event)"><div class="form-group"><label class="form-label">Trip Name *</label><input class="form-input" type="text" id="tripName" required placeholder="e.g., Japan 2025"></div><div class="form-group"><label class="form-label">Destination</label><input class="form-input" type="text" id="tripDestination" placeholder="e.g., Osaka, Kyoto, Tokyo"></div><div class="form-row"><div class="form-group"><label class="form-label">Start Date *</label><input class="form-input" type="date" id="tripStartDate" required></div><div class="form-group"><label class="form-label">End Date *</label><input class="form-input" type="date" id="tripEndDate" required></div></div><div class="form-group"><label class="form-label">Notes</label><input class="form-input" type="text" id="tripNotes" placeholder="Any notes"></div><button type="submit" class="form-btn form-btn-primary">Create Trip</button></form></div></div></div>
<div class="modal-overlay" id="currencyModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Exchange Rate</h2><button class="modal-close-btn" onclick="closeCurrencyModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">1 AUD = ? JPY</label><input class="form-input" type="number" id="exchangeRateInput" step="0.01" placeholder="e.g., 97.50"></div><p style="font-size:0.8rem;color:var(--text-tertiary);margin-bottom:16px">Enter manually or fetch current rate.</p><div style="display:flex;gap:8px"><button class="form-btn form-btn-primary" onclick="saveExchangeRate()" style="flex:1">Save</button><button class="form-btn" onclick="fetchExchangeRate()" style="flex:1;background:var(--bg-secondary);color:var(--text-primary)">Fetch Rate</button></div><p id="exchangeRateStatus" style="font-size:0.75rem;color:var(--text-tertiary);margin-top:10px;text-align:center"></p></div></div></div>
<div class="modal-overlay" id="weatherModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Weather Settings</h2><button class="modal-close-btn" onclick="closeWeatherModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">OpenWeatherMap API Key</label><input class="form-input" type="text" id="weatherApiKeyInput" placeholder="Paste your API key"></div><p style="font-size:0.8rem;color:var(--text-tertiary);margin-bottom:16px">Free key from <strong>openweathermap.org</strong></p><button class="form-btn form-btn-primary" onclick="saveWeatherApiKey()">Save</button></div></div></div>
<div class="modal-overlay" id="weatherLocationModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Weather Location</h2><button class="modal-close-btn" onclick="closeWeatherLocationModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">City Name</label><input class="form-input" type="text" id="weatherLocationInput" placeholder="e.g., Osaka, Tokyo, Kyoto"></div><p style="font-size:0.8rem;color:var(--text-tertiary);margin-bottom:16px">Leave empty for auto-detect.</p><button class="form-btn form-btn-primary" onclick="saveWeatherLocation()">Save</button></div></div></div>
<div class="modal-overlay" id="entryModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="entryModalTitle">New Entry</h2><button class="modal-close-btn" onclick="closeEntryModal()">âœ•</button></div><div class="modal-body" id="entryModalBody"></div></div></div>
<div class="modal-overlay" id="reflectionModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Add Reflection</h2><button class="modal-close-btn" onclick="closeReflectionModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Looking back on this experience...</label><textarea class="form-textarea" id="reflectionText" rows="4" placeholder="What stands out now? What would you want to remember?"></textarea></div><button class="form-btn form-btn-primary" onclick="saveReflection()">Save Reflection</button></div></div></div>
<div class="modal-overlay" id="purchaseModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="purchaseModalTitle">Log Purchase</h2><button class="modal-close-btn" onclick="closePurchaseModal()">âœ•</button></div><div class="modal-body" id="purchaseModalBody"></div></div></div>
<div class="modal-overlay" id="currencyCalcModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>ðŸ’± Currency Converter</h2><button class="modal-close-btn" onclick="closeCurrencyCalc()">âœ•</button></div><div class="modal-body" id="currencyCalcBody"></div></div></div>
<div class="modal-overlay" id="addPhraseModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="addPhraseModalTitle">Add Phrase</h2><button class="modal-close-btn" onclick="closeAddPhraseModal()">âœ•</button></div><div class="modal-body" id="addPhraseModalBody"></div></div></div>
<div class="modal-overlay" id="souvenirModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="souvenirModalTitle">Log Souvenir</h2><button class="modal-close-btn" onclick="closeSouvenirModal()">âœ•</button></div><div class="modal-body" id="souvenirModalBody"></div></div></div>
<div class="modal-overlay" id="recipientProfileModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="recipientProfileModalTitle">Edit Profile</h2><button class="modal-close-btn" onclick="closeRecipientProfileModal()">âœ•</button></div><div class="modal-body" id="recipientProfileModalBody"></div></div></div>
<div class="modal-overlay" id="stampModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="stampModalTitle">Log Stamp</h2><button class="modal-close-btn" onclick="closeStampModal()">âœ•</button></div><div class="modal-body" id="stampModalBody"></div></div></div>
<div class="modal-overlay" id="stampPlanModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Plan Stamp Hunt</h2><button class="modal-close-btn" onclick="closeStampPlanModal()">âœ•</button></div><div class="modal-body" id="stampPlanModalBody"></div></div></div>
<div class="modal-overlay" id="goshuinModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="goshuinModalTitle">Log Goshuin</h2><button class="modal-close-btn" onclick="closeGoshuinModal()">âœ•</button></div><div class="modal-body" id="goshuinModalBody"></div></div></div>
<div class="modal-overlay" id="goshuinDetailModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="goshuinDetailTitle">Goshuin</h2><button class="modal-close-btn" onclick="closeGoshuinDetailModal()">âœ•</button></div><div class="modal-body" id="goshuinDetailBody"></div></div></div>
<div class="modal-overlay" id="transportModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="transportModalTitle">Log Journey</h2><button class="modal-close-btn" onclick="closeTransportModal()">âœ•</button></div><div class="modal-body" id="transportModalBody"></div></div></div>
<div class="modal-overlay" id="edcItemModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="edcItemModalTitle">Add Item</h2><button class="modal-close-btn" onclick="closeEdcItemModal()">âœ•</button></div><div class="modal-body" id="edcItemModalBody"></div></div></div>
<div class="modal-overlay" id="edcTemplateModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2>Save as Template</h2><button class="modal-close-btn" onclick="closeEdcTemplateModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Template Name</label><input class="form-input" type="text" id="edcTemplateName" placeholder="e.g., Temple Day, Night Photography"></div><div class="form-group"><label class="form-label">Description (optional)</label><input class="form-input" type="text" id="edcTemplateDesc" placeholder="What kind of day is this for?"></div><p style="font-size:0.8rem;color:var(--text-tertiary);margin-bottom:16px">This will save all current day-specific items as a reusable template.</p><button class="form-btn form-btn-primary" onclick="saveEdcTemplate()">Save Template</button></div></div></div>
<div class="modal-overlay" id="personModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="personModalTitle">Log Person</h2><button class="modal-close-btn" onclick="closePersonModal()">âœ•</button></div><div class="modal-body" id="personModalBody"></div></div></div>
<div class="modal-overlay" id="dailyReflectionModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="dailyReflectionModalTitle">End of Day Reflection</h2><button class="modal-close-btn" onclick="closeDailyReflectionModal()">âœ•</button></div><div class="modal-body" id="dailyReflectionModalBody"></div></div></div>
<div class="modal-overlay" id="tripReflectionModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-sheet-header"><h2 id="tripReflectionModalTitle">Trip Reflection</h2><button class="modal-close-btn" onclick="closeTripReflectionModal()">âœ•</button></div><div class="modal-body" id="tripReflectionModalBody"></div></div></div>
<div class="share-modal" id="shareModal"><div class="share-modal-header"><button class="share-modal-close" onclick="closeShareModal()">â†</button><h2 id="shareModalTitle">Share</h2><div style="width:44px"></div></div><div class="share-modal-body" id="shareModalBody"></div></div>
<div class="moment-detail-overlay" id="momentDetailOverlay"><button class="moment-detail-close" onclick="closeMomentDetail()">âœ•</button><img class="moment-detail-img" id="momentDetailImg" src="" alt=""><div class="moment-detail-location" id="momentDetailLocation"></div><div class="moment-detail-date" id="momentDetailDate"></div><div class="moment-detail-actions" id="momentDetailActions"></div></div>
<div class="quickshow-overlay" id="quickShowOverlay" onclick="closeQuickShow()"><button class="quickshow-close" onclick="closeQuickShow()">âœ•</button><div class="quickshow-text" id="quickShowText"></div><div class="quickshow-hint">Tap anywhere to close</div></div>
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><button class="lightbox-close" onclick="closeLightbox()">âœ•</button><img id="lightboxImg" src="" alt=""></div>
<div class="toast-container" id="toastContainer"></div>


<script>
const APP_KEY='tabi_app_data';
const THEMES=[{id:'spring',name:'Spring',colors:['#fef6f0','#fae8e0','#c94b4b','#8b3a62']},{id:'autumn',name:'Autumn',colors:['#faf3ea','#f0e0c8','#c45d2c','#8b4513']},{id:'winter',name:'Winter',colors:['#f0f4f8','#dce4ec','#4a7c9b','#2c4a6e']},{id:'summer',name:'Summer',colors:['#fefdf5','#fdf0d0','#d4882a','#b85c1a']},{id:'tokyo',name:'Tokyo',colors:['#f2f0f8','#e4e0f0','#d04090','#3090c0']},{id:'edo',name:'Edo',colors:['#f5f0e6','#e8dcc8','#8b2020','#2a4a3a']}];
const ZEN_PROMPTS=[{text:"The journey of a thousand miles begins with a single step.",attr:"Lao Tzu"},{text:"Not all those who wander are lost.",attr:"J.R.R. Tolkien"},{text:"The real voyage of discovery consists not in seeking new landscapes, but in having new eyes.",attr:"Marcel Proust"},{text:"Walk as if you are kissing the earth with your feet.",attr:"Thich Nhat Hanh"},{text:"Wherever you go, go with all your heart.",attr:"Confucius"},{text:"Fall seven times, stand up eight.",attr:"Japanese Proverb"},{text:"The bamboo that bends is stronger than the oak that resists.",attr:"Japanese Proverb"},{text:"Beginning is easy. Continuing is hard.",attr:"Japanese Proverb"},{text:"Wabi-sabi: find beauty in imperfection.",attr:"Japanese Aesthetic"},{text:"Every hundred feet the world changes.",attr:"Roberto BolaÃ±o"},{text:"Travel makes one modest. You see what a tiny place you occupy in the world.",attr:"Gustave Flaubert"},{text:"Attention is the rarest and purest form of generosity.",attr:"Simone Weil"}];
const CATEGORIES=[
{id:'shrine',emoji:'â›©ï¸',label:'Shrine',prompt:'What was the atmosphere like? Did you feel any particular energy or sense of reverence?',tags:['sacred','peaceful','ritual','spiritual','quiet','contemplative']},
{id:'temple',emoji:'ðŸ¯',label:'Temple',prompt:'How did the space make you feel? What details drew your eye?',tags:['historic','beautiful','peaceful','architecture','spiritual','contemplative']},
{id:'museum',emoji:'ðŸ›ï¸',label:'Museum',prompt:'What surprised you? What will you remember?',tags:['art','history','culture','learning','discovery','fascinating']},
{id:'park',emoji:'ðŸŒ³',label:'Park',prompt:'What was the pace like? How did it feel to be there?',tags:['nature','peaceful','spacious','relaxing','green','calm']},
{id:'garden',emoji:'ðŸª´',label:'Garden',prompt:'What caught your attention? How did the space unfold?',tags:['beautiful','serene','designed','nature','peaceful','contemplative']},
{id:'memorial',emoji:'ðŸ•Šï¸',label:'Memorial',prompt:'What emotions came up? What felt important to witness?',tags:['somber','reflective','important','moving','historical','respectful']},
{id:'store',emoji:'ðŸª',label:'Store',prompt:'What drew you in? What did you discover?',tags:['shopping','discovery','unique','interesting','local','browsing']},
{id:'landmark',emoji:'ðŸ“',label:'Landmark',prompt:'What was it like to be here in person?',tags:['iconic','impressive','crowded','photo-worthy','cultural','tourist']},
{id:'restaurant',emoji:'ðŸœ',label:'Restaurant',prompt:'Beyond the food â€” what was the atmosphere?',tags:['delicious','local-cuisine','memorable','atmosphere','experience']},
{id:'cafe',emoji:'â˜•',label:'CafÃ©',prompt:'What was the vibe? How did the space invite you to linger?',tags:['coffee','relaxing','cozy','break','atmosphere','people-watching']},
{id:'accommodation',emoji:'ðŸ¨',label:'Accommodation',prompt:"How does this place feel? What's the energy of arriving here?",tags:['comfortable','rest','base','welcoming','sleep']},
{id:'transport',emoji:'ðŸš†',label:'Transport',prompt:'How did this part of the journey feel?',tags:['journey','observation','transit','movement','efficient','scenic']},
{id:'themepark',emoji:'ðŸŽª',label:'Theme Park',prompt:'What was the highlight? What surprised you?',tags:['fun','exciting','crowded','rides','entertainment','adventure']},
{id:'other',emoji:'âœ¨',label:'Other',prompt:'What made this moment worth noting?',tags:['interesting','memorable','unexpected','unique']}
];

const STICKERS={
places:[
{id:'shrine',emoji:'â›©ï¸',label:'Shrine'},{id:'temple',emoji:'ðŸ¯',label:'Temple'},{id:'museum',emoji:'ðŸ›ï¸',label:'Museum'},
{id:'park',emoji:'ðŸŒ³',label:'Park'},{id:'garden',emoji:'ðŸª´',label:'Garden'},{id:'castle',emoji:'ðŸ°',label:'Castle'},
{id:'market',emoji:'ðŸª',label:'Market'},{id:'cafe-place',emoji:'â˜•',label:'CafÃ©'},{id:'restaurant-place',emoji:'ðŸœ',label:'Restaurant'},
{id:'station',emoji:'ðŸš‰',label:'Station'},{id:'street',emoji:'ðŸ›¤ï¸',label:'Street'},{id:'rooftop',emoji:'ðŸŒ†',label:'Rooftop'}
],
vibes:[
{id:'peaceful',emoji:'ðŸ•Šï¸',label:'Peaceful'},{id:'joyful',emoji:'ðŸ˜Š',label:'Joyful'},{id:'inspired',emoji:'âœ¨',label:'Inspired'},
{id:'contemplative',emoji:'ðŸ§˜',label:'Contemplative'},{id:'excited',emoji:'ðŸŽ‰',label:'Excited'},{id:'cozy',emoji:'ðŸ«–',label:'Cozy'},
{id:'overwhelmed',emoji:'ðŸ˜®â€ðŸ’¨',label:'Overwhelmed'},{id:'grateful',emoji:'ðŸ™',label:'Grateful'},{id:'curious',emoji:'ðŸ”',label:'Curious'},
{id:'nostalgic',emoji:'ðŸ’­',label:'Nostalgic'},{id:'energized',emoji:'âš¡',label:'Energized'},{id:'calm',emoji:'ðŸŒŠ',label:'Calm'}
],
activities:[
{id:'photography',emoji:'ðŸ“·',label:'Photography'},{id:'food',emoji:'ðŸ±',label:'Food'},{id:'walking',emoji:'ðŸš¶',label:'Walking'},
{id:'shopping',emoji:'ðŸ›ï¸',label:'Shopping'},{id:'culture',emoji:'ðŸŽ­',label:'Culture'},{id:'nature',emoji:'ðŸŒ¸',label:'Nature'},
{id:'nightlife',emoji:'ðŸŒ™',label:'Night'},{id:'train',emoji:'ðŸš„',label:'Train'},{id:'art',emoji:'ðŸŽ¨',label:'Art'},
{id:'history',emoji:'ðŸ“œ',label:'History'},{id:'craft',emoji:'ðŸº',label:'Craft'},{id:'gaming',emoji:'ðŸŽ®',label:'Gaming'}
],
weather:[
{id:'sunny',emoji:'â˜€ï¸',label:'Sunny'},{id:'cloudy',emoji:'â˜ï¸',label:'Cloudy'},{id:'rainy',emoji:'ðŸŒ§ï¸',label:'Rainy'},
{id:'snowy',emoji:'â„ï¸',label:'Snowy'},{id:'windy',emoji:'ðŸ’¨',label:'Windy'},{id:'cold',emoji:'ðŸ¥¶',label:'Cold'}
],
custom:[]
};
const STICKER_TAB_LABELS={places:'ðŸ“ Places',vibes:'ðŸ’« Vibes',activities:'ðŸŽ¯ Activities',weather:'ðŸŒ¤ï¸ Weather',custom:'ðŸŽ¨ Custom'};
let selectedStickers=[];

let appData={version:'3.0.0',settings:{theme:'spring',darkMode:false,exchangeRate:null,lastRateUpdate:null,weatherApiKey:null,weatherLocation:null},trips:[],journal:{}};
let currentPage='home',pageHistory=[],clockInterval=null;
let hubTripId=null,calViewDate=null;
let journalDate=null,editingEntryId=null,entryPhotos=[],reflectionEntryId=null;
let nestedEvents=[],mealItems=[];

function init(){loadData();applyTheme(appData.settings.theme,false);applyDarkMode(appData.settings.darkMode,false);renderThemeGrid();startClock();updateGreeting();updateWidgets();renderActiveTrip();renderTripsPage();updateSettingsDisplay();migrateLegacyData()}
function loadData(){try{const s=localStorage.getItem(APP_KEY);if(s){const p=JSON.parse(s);appData={...appData,...p,settings:{...appData.settings,...(p.settings||{})}};if(!Array.isArray(appData.purchases))appData.purchases=[];if(!Array.isArray(appData.budget))appData.budget=[];if(!Array.isArray(appData.souvenirs))appData.souvenirs=[];if(!Array.isArray(appData.stamps))appData.stamps=[];if(!Array.isArray(appData.goshuin))appData.goshuin=[];if(!Array.isArray(appData.transport))appData.transport=[];if(!Array.isArray(appData.moments))appData.moments=[];if(!Array.isArray(appData.people))appData.people=[];if(!appData.recipientProfiles)appData.recipientProfiles={};if(!appData.stampPlans)appData.stampPlans={};if(!appData.edc)appData.edc={standard:[],daily:{},templates:{}};if(!appData.dailyReflections)appData.dailyReflections={};if(!appData.tripReflections)appData.tripReflections={};if(!Array.isArray(appData.customStickers))appData.customStickers=[]}}catch(e){console.error(e)}}
function saveData(){try{localStorage.setItem(APP_KEY,JSON.stringify(appData))}catch(e){showToast('Storage full â€” export backup!')}}
function migrateLegacyData(){const l=localStorage.getItem('japanJourneyData');if(l&&!appData._legacyMigrated){try{const old=JSON.parse(l);if(old&&typeof old==='object'){Object.keys(old).forEach(k=>{if(!appData.journal[k])appData.journal[k]=old[k]});appData._legacyMigrated=true;saveData()}}catch(e){}}}

/* === THEME === */
function applyTheme(id,save=true){document.body.setAttribute('data-theme',id);appData.settings.theme=id;if(save)saveData();document.querySelectorAll('.theme-option').forEach(el=>el.classList.toggle('active',el.dataset.theme===id));requestAnimationFrame(()=>{const m=document.querySelector('meta[name="theme-color"]');const bg=getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();if(m&&bg)m.setAttribute('content',bg)})}
function applyDarkMode(isDark,save=true){document.body.setAttribute('data-mode',isDark?'dark':'light');appData.settings.darkMode=isDark;if(save)saveData();const t=document.getElementById('darkModeToggle'),i=document.getElementById('modeIcon'),l=document.getElementById('modeLabel');if(t)t.classList.toggle('on',isDark);if(i)i.textContent=isDark?'â˜€ï¸':'ðŸŒ™';if(l)l.textContent=isDark?'Light Mode':'Dark Mode';requestAnimationFrame(()=>{const m=document.querySelector('meta[name="theme-color"]');const bg=getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();if(m&&bg)m.setAttribute('content',bg)})}
function toggleDarkMode(){const n=!appData.settings.darkMode;applyDarkMode(n);showToast(n?'Dark mode on':'Light mode on')}
function renderThemeGrid(){document.getElementById('themeGrid').innerHTML=THEMES.map(t=>`<button class="theme-option ${t.id===appData.settings.theme?'active':''}" data-theme="${t.id}" onclick="applyTheme('${t.id}');showToast('${t.name} theme')"><div class="theme-swatch"><div style="background:${t.colors[0]}"></div><div style="background:${t.colors[1]}"></div><div style="background:${t.colors[2]}"></div><div style="background:${t.colors[3]}"></div></div><span class="theme-option-name">${t.name}</span></button>`).join('')}

/* === NAV === */
function navigateTo(p){if(p===currentPage)return;pageHistory.push(currentPage);document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));const t=document.getElementById('page-'+p);if(t)t.classList.add('active');currentPage=p;updateNavButtons();document.getElementById('journalFab').style.display=p==='journal'?'flex':'none';document.getElementById('purchaseFab').style.display=p==='purchases'?'flex':'none';document.getElementById('langFab').style.display=p==='language'?'flex':'none';document.getElementById('souvenirFab').style.display=p==='souvenirs'?'flex':'none';document.getElementById('stampFab').style.display=p==='stamps'?'flex':'none';document.getElementById('goshuinFab').style.display=p==='goshuin'?'flex':'none';document.getElementById('transportFab').style.display=p==='transport'?'flex':'none';document.getElementById('edcFab').style.display=p==='edc'?'flex':'none';document.getElementById('peopleFab').style.display=p==='people'?'flex':'none'}
function goBack(){if(pageHistory.length){const prev=pageHistory.pop();document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));const t=document.getElementById('page-'+prev);if(t)t.classList.add('active');currentPage=prev;updateNavButtons();document.getElementById('journalFab').style.display=prev==='journal'?'flex':'none';document.getElementById('purchaseFab').style.display=prev==='purchases'?'flex':'none';document.getElementById('langFab').style.display=prev==='language'?'flex':'none';document.getElementById('souvenirFab').style.display=prev==='souvenirs'?'flex':'none';document.getElementById('stampFab').style.display=prev==='stamps'?'flex':'none';document.getElementById('goshuinFab').style.display=prev==='goshuin'?'flex':'none';document.getElementById('transportFab').style.display=prev==='transport'?'flex':'none';document.getElementById('edcFab').style.display=prev==='edc'?'flex':'none';document.getElementById('peopleFab').style.display=prev==='people'?'flex':'none'}}
function updateNavButtons(){const h=currentPage==='home';document.getElementById('backBtn').style.display=h?'none':'flex';document.getElementById('homeBtn').style.display=h?'none':'flex'}
function toggleMenu(){document.getElementById('menuOverlay').classList.toggle('open')}
function closeMenuOnOverlay(e){if(e.target===e.currentTarget)toggleMenu()}

/* === CLOCK === */
function startClock(){updateClock();clockInterval=setInterval(updateClock,1000)}
function updateClock(){const n=new Date();document.getElementById('clockTime').textContent=n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0');document.getElementById('clockDate').textContent=n.toLocaleDateString('en-AU',{weekday:'long',month:'long',day:'numeric',year:'numeric'});document.getElementById('clockTimezone').textContent=(Intl.DateTimeFormat().resolvedOptions().timeZone||'').replace(/_/g,' ')}
function updateGreeting(){const h=new Date().getHours();let g,s;if(h<6){g='Good evening';s='Burning the midnight oil?'}else if(h<12){g='Good morning';s='Ready for a new day'}else if(h<17){g='Good afternoon';s='Hope the day is going well'}else if(h<21){g='Good evening';s='Wind down and reflect'}else{g='Good night';s='Rest well'}document.getElementById('greetingText').textContent=g;document.getElementById('greetingSub').textContent=s}

/* === WIDGETS === */
function updateWidgets(){updateWeatherWidget();updateCurrencyWidget();updateTripDayWidget()}
function updateWeatherWidget(){const key=appData.settings.weatherApiKey,el=document.getElementById('weatherContent');if(!key){el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">ðŸŒ¤ï¸</span><span>Add API key in Settings</span></div>';return}const city=appData.settings.weatherLocation;if(city){fetchWeather('https://api.openweathermap.org/data/2.5/weather?q='+encodeURIComponent(city)+'&appid='+key+'&units=metric')}else if(navigator.geolocation){el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">ðŸ“</span><span>Detecting...</span></div>';navigator.geolocation.getCurrentPosition(pos=>fetchWeather('https://api.openweathermap.org/data/2.5/weather?lat='+pos.coords.latitude+'&lon='+pos.coords.longitude+'&appid='+key+'&units=metric'),()=>{el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">ðŸ“</span><span>Set city in Settings</span></div>'},{timeout:8000})}else{el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">ðŸ“</span><span>Set city in Settings</span></div>'}}
function fetchWeather(url){const el=document.getElementById('weatherContent');el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">â³</span><span>Loading...</span></div>';fetch(url).then(r=>{if(!r.ok)throw new Error();return r.json()}).then(d=>{if(!d||!d.main)throw new Error();const icons={'Clear':'â˜€ï¸','Clouds':'â˜ï¸','Rain':'ðŸŒ§ï¸','Drizzle':'ðŸŒ¦ï¸','Thunderstorm':'â›ˆï¸','Snow':'ðŸŒ¨ï¸','Mist':'ðŸŒ«ï¸','Fog':'ðŸŒ«ï¸','Haze':'ðŸŒ«ï¸'};const icon=icons[d.weather[0].main]||'ðŸŒ¤ï¸',temp=Math.round(d.main.temp),hi=Math.round(d.main.temp_max),lo=Math.round(d.main.temp_min);el.innerHTML=`<div class="weather-content"><div class="weather-main"><span class="weather-icon-large">${icon}</span><span class="weather-temp">${temp}Â°</span></div><div class="weather-details"><div class="weather-condition">${d.weather[0].description}</div><div class="weather-hilo">H:${hi}Â° L:${lo}Â°</div><div class="weather-location">${d.name}</div></div></div>`}).catch(()=>{el.innerHTML='<div class="weather-placeholder"><span class="weather-placeholder-icon">âš ï¸</span><span>Weather unavailable</span></div>'})}
function updateCurrencyWidget(){const r=appData.settings.exchangeRate,el=document.getElementById('currencyContent');if(!r){el.innerHTML='<div class="currency-placeholder">Set rate in Settings</div>';return}el.innerHTML=`<div class="currency-content"><div class="currency-rate">Â¥${parseFloat(r).toFixed(2)}</div><div class="currency-pair">1 AUD = ${parseFloat(r).toFixed(2)} JPY</div></div>`}
function updateTripDayWidget(){const el=document.getElementById('tripDayContent'),trip=getActiveTrip();if(!trip){el.innerHTML='<div class="widget-value" style="font-size:1rem;color:var(--text-tertiary)">No active trip</div>';return}const today=new Date();today.setHours(0,0,0,0);const start=new Date(trip.startDate+'T00:00:00'),end=new Date(trip.endDate+'T00:00:00');const total=Math.ceil((end-start)/864e5)+1,day=Math.ceil((today-start)/864e5)+1;el.innerHTML=`<div class="widget-value">Day ${day}</div><div class="widget-sub">of ${total}</div>`;el.closest('.widget-card').onclick=()=>viewTrip(trip.id);el.closest('.widget-card').style.cursor='pointer'}

/* === TRIPS === */
function getActiveTrip(){const t=new Date();t.setHours(0,0,0,0);return appData.trips.find(tr=>{const s=new Date(tr.startDate+'T00:00:00'),e=new Date(tr.endDate+'T00:00:00');return t>=s&&t<=e})||null}
function getTripStatus(tr){const t=new Date();t.setHours(0,0,0,0);const s=new Date(tr.startDate+'T00:00:00'),e=new Date(tr.endDate+'T00:00:00');if(t>=s&&t<=e)return'active';if(t<s)return'upcoming';return'past'}
function getTripById(id){return appData.trips.find(t=>t.id===id)||null}
function renderActiveTrip(){const c=document.getElementById('activeTripContainer'),a=getActiveTrip();const upcoming=appData.trips.filter(t=>new Date(t.startDate+'T00:00:00')>new Date(new Date().setHours(0,0,0,0))).sort((a,b)=>new Date(a.startDate)-new Date(b.startDate));if(a){const start=new Date(a.startDate+'T00:00:00'),end=new Date(a.endDate+'T00:00:00'),today=new Date();today.setHours(0,0,0,0);const total=Math.ceil((end-start)/864e5)+1,elapsed=Math.ceil((today-start)/864e5)+1,remaining=total-elapsed,progress=Math.min(100,Math.max(0,(elapsed/total)*100));c.innerHTML=`<div class="trip-card" onclick="viewTrip('${a.id}')" style="cursor:pointer"><div class="trip-card-header"><div class="trip-card-title accent-glow">${a.name}</div><span class="trip-badge active">Active</span></div><div class="trip-dates">${fmtDate(a.startDate)} â€” ${fmtDate(a.endDate)}${a.destination?' Â· '+a.destination:''}</div><div class="trip-progress"><div class="trip-progress-bar"><div class="trip-progress-fill" style="width:${progress}%"></div></div><div class="trip-progress-text"><span>Day ${elapsed}</span><span>${remaining} days left</span></div></div></div>`}else if(upcoming.length){const n=upcoming[0],today=new Date();today.setHours(0,0,0,0);const days=Math.ceil((new Date(n.startDate+'T00:00:00')-today)/864e5);c.innerHTML=`<div class="trip-card" onclick="viewTrip('${n.id}')" style="cursor:pointer"><div class="trip-card-header"><div class="trip-card-title">${n.name}</div><span class="trip-badge upcoming">Upcoming</span></div><div class="trip-dates">${fmtDate(n.startDate)} â€” ${fmtDate(n.endDate)}${n.destination?' Â· '+n.destination:''}</div><div style="font-size:0.85rem;color:var(--text-secondary);margin-top:8px">${days<=1?'Starts tomorrow!':'Starts in '+days+' days'}</div></div>`}else if(!appData.trips.length){c.innerHTML='<div class="no-trip-card"><div class="no-trip-icon">âœˆï¸</div><div class="no-trip-text">No trips yet. Create one to get started.</div></div>'}else{c.innerHTML='<div class="no-trip-card"><div class="no-trip-icon">ðŸ—¾</div><div class="no-trip-text">No active trips right now.</div></div>'}}
function renderTripsPage(){const c=document.getElementById('tripsList'),trips=appData.trips;if(!trips.length){c.innerHTML='<div class="empty-trips"><div class="empty-trips-icon">âœˆï¸</div><p>No trips created yet</p></div>';return}const sorted=[...trips].sort((a,b)=>{const o={active:0,upcoming:1,past:2};if(o[getTripStatus(a)]!==o[getTripStatus(b)])return o[getTripStatus(a)]-o[getTripStatus(b)];return new Date(b.startDate)-new Date(a.startDate)});c.innerHTML='<div class="trips-list">'+sorted.map(t=>{const s=getTripStatus(t);return`<div class="trip-list-item" onclick="viewTrip('${t.id}')"><div class="trip-list-name">${t.name}</div><div class="trip-list-dates">${fmtDate(t.startDate)} â€” ${fmtDate(t.endDate)}${t.destination?' Â· '+t.destination:''}</div><div class="trip-list-status"><span class="trip-badge ${s}">${s}</span></div></div>`}).join('')+'</div>'}

/* === TRIP HUB === */
function viewTrip(id){hubTripId=id;const trip=getTripById(id);if(!trip){showToast('Trip not found');return}calViewDate=new Date();renderTripHub(trip);navigateTo('hub')}
function renderTripHub(trip){const c=document.getElementById('hubContent');const status=getTripStatus(trip);const start=new Date(trip.startDate+'T00:00:00'),end=new Date(trip.endDate+'T00:00:00');const today=new Date();today.setHours(0,0,0,0);const totalDays=Math.ceil((end-start)/864e5)+1;const elapsed=status==='active'?Math.ceil((today-start)/864e5)+1:status==='past'?totalDays:0;const remaining=status==='active'?totalDays-elapsed:status==='upcoming'?totalDays:0;const stats=computeTripStats(trip);const zen=ZEN_PROMPTS[Math.floor(Math.random()*ZEN_PROMPTS.length)];const todayStr=toDateStr(today);let statusHtml='';if(status==='active'){const progress=Math.min(100,Math.max(0,(elapsed/totalDays)*100));statusHtml=`<span class="trip-badge active">Day ${elapsed} of ${totalDays}</span><div style="margin-top:10px;max-width:240px;margin-left:auto;margin-right:auto"><div class="trip-progress-bar"><div class="trip-progress-fill" style="width:${progress}%"></div></div><div class="trip-progress-text"><span>${elapsed} elapsed</span><span>${remaining} left</span></div></div>`}else if(status==='upcoming'){const du=Math.ceil((start-today)/864e5);statusHtml=`<span class="trip-badge upcoming">${du<=1?'Starts tomorrow':'In '+du+' days'}</span>`}else{statusHtml='<span class="trip-badge past">Completed</span>'}
c.innerHTML=`<div class="hub-header fade-in stagger-1"><div class="hub-trip-name accent-glow">${trip.name}</div><div class="hub-trip-dates">${fmtDate(trip.startDate)} â€” ${fmtDate(trip.endDate)}${trip.destination?' Â· '+trip.destination:''}</div><div class="hub-trip-status">${statusHtml}</div></div><div class="hub-zen fade-in stagger-2"><div class="hub-zen-text">"${zen.text}"</div><div class="hub-zen-attr">â€” ${zen.attr}</div></div><div class="hub-actions fade-in stagger-3"><button class="hub-action-btn primary-action" onclick="openJournal('${todayStr}')"><span class="ha-icon">ðŸ“–</span><span class="ha-label">Today's Journal</span><span class="ha-sub">${todayStr>=trip.startDate&&todayStr<=trip.endDate?'Day '+elapsed:'View journal'}</span></button><button class="hub-action-btn" onclick="openJournal('${todayStr}');setTimeout(openEntryModal,400)"><span class="ha-icon">âœï¸</span><span class="ha-label">New Entry</span><span class="ha-sub">Capture a moment</span></button><button class=\"hub-action-btn\" onclick=\"openPurchasesPage()\"><span class=\"ha-icon\">ðŸ›ï¸</span><span class=\"ha-label\">Purchases</span><span class=\"ha-sub\">${stats.purchaseCount||0} logged</span></button><button class=\"hub-action-btn\" onclick=\"openLanguagePage()\"><span class=\"ha-icon\">ðŸ—£ï¸</span><span class=\"ha-label\">Language</span><span class=\"ha-sub\">Phrases & tools</span></button><button class=\"hub-action-btn\" onclick=\"openSouvenirsPage()\"><span class=\"ha-icon\">ðŸŽ</span><span class=\"ha-label\">Souvenirs</span><span class=\"ha-sub\">${stats.gifts||0} gifts</span></button><button class=\"hub-action-btn\" onclick=\"openStampsPage()\"><span class=\"ha-icon\">ðŸŽ«</span><span class=\"ha-label\">Stamps</span><span class=\"ha-sub\">${stats.stampCount||0} collected</span></button><button class=\"hub-action-btn\" onclick=\"openGoshuinPage()\"><span class=\"ha-icon\">â›©ï¸</span><span class=\"ha-label\">Goshuin</span><span class=\"ha-sub\">${stats.goshuinCount||0} seals</span></button><button class=\"hub-action-btn\" onclick=\"openTransportPage()\"><span class=\"ha-icon\">ðŸš†</span><span class=\"ha-label\">Transport</span><span class=\"ha-sub\">${stats.transportCount||0} journeys</span></button><button class=\"hub-action-btn\" onclick=\"openMomentsPage()\"><span class=\"ha-icon\">âœ¨</span><span class=\"ha-label\">Moments</span><span class=\"ha-sub\">${stats.momentCount||0} graphics</span></button><button class=\"hub-action-btn\" onclick=\"openEdcPage()\"><span class=\"ha-icon\">ðŸŽ’</span><span class=\"ha-label\">EDC</span><span class=\"ha-sub\">Gear planner</span></button><button class=\"hub-action-btn\" onclick=\"openPeoplePage()\"><span class=\"ha-icon\">ðŸ‘¥</span><span class=\"ha-label\">People</span><span class=\"ha-sub\">${stats.peopleCount||0} met</span></button><button class=\"hub-share-btn\" onclick=\"openShareFromTrip()\">ðŸ“¤ Create Share Graphic</button></div><div class="hub-section-title fade-in stagger-3">Trip Stats</div><div class="hub-stats fade-in stagger-3"><div class="hub-stat"><div class="hub-stat-value">${stats.entries}</div><div class="hub-stat-label">Entries</div></div><div class="hub-stat"><div class="hub-stat-value">${stats.meals}</div><div class="hub-stat-label">Meals</div></div><div class="hub-stat"><div class="hub-stat-value">${stats.photos}</div><div class="hub-stat-label">Photos</div></div><div class="hub-stat"><div class="hub-stat-value">${stats.topCategory||'â€”'}</div><div class="hub-stat-label">Top Cat</div></div><div class="hub-stat"><div class="hub-stat-value">${stats.spent}</div><div class="hub-stat-label">Spent</div></div><div class="hub-stat"><div class="hub-stat-value">${stats.gifts}</div><div class="hub-stat-label">Gifts</div></div></div><div class="hub-section-title fade-in stagger-4">Calendar</div><div class="hub-calendar fade-in stagger-4" id="hubCalendar"></div>`;c.innerHTML+=renderTripReflectionSection(trip);renderHubCalendar(trip)}
function computeTripStats(trip){let entries=0,meals=0,photos=0,cats={},spent=0,gifts=0;const j=appData.journal||{};Object.keys(j).forEach(ds=>{if(ds>=trip.startDate&&ds<=trip.endDate){const de=j[ds];if(Array.isArray(de))de.forEach(e=>{entries++;if(e.photos)photos+=e.photos.length;if(e.meals)meals+=e.meals.length;if(e.category)cats[e.category]=(cats[e.category]||0)+1})}});if(Array.isArray(appData.budget))appData.budget.forEach(b=>{if(b.date>=trip.startDate&&b.date<=trip.endDate)spent+=(b.amountAUD||b.amount||0)});if(Array.isArray(appData.souvenirs))appData.souvenirs.forEach(s=>{if(s.date>=trip.startDate&&s.date<=trip.endDate)gifts++});let topCat=null,topCount=0;const ce={shrine:'â›©ï¸',temple:'ðŸ¯',museum:'ðŸ›ï¸',park:'ðŸŒ³',garden:'ðŸª´',memorial:'ðŸ•Šï¸',store:'ðŸª',landmark:'ðŸ“',restaurant:'ðŸœ',cafe:'â˜•',accommodation:'ðŸ¨',transport:'ðŸš†',themepark:'ðŸŽª',other:'âœ¨'};Object.entries(cats).forEach(([k,v])=>{if(v>topCount){topCount=v;topCat=k}});let purchaseCount=0;if(Array.isArray(appData.purchases))appData.purchases.forEach(p=>{if(p.date>=trip.startDate&&p.date<=trip.endDate)purchaseCount++});let stampCount=0;if(Array.isArray(appData.stamps))appData.stamps.forEach(s=>{if(s.date>=trip.startDate&&s.date<=trip.endDate)stampCount++});let goshuinCount=0;if(Array.isArray(appData.goshuin))appData.goshuin.forEach(g=>{if(g.date>=trip.startDate&&g.date<=trip.endDate)goshuinCount++});let transportCount=0;if(Array.isArray(appData.transport))appData.transport.forEach(t=>{if(t.date>=trip.startDate&&t.date<=trip.endDate)transportCount++});let momentCount=0;if(Array.isArray(appData.moments))appData.moments.forEach(m=>{if(m.tripId===trip.id)momentCount++});let peopleCount=0;if(Array.isArray(appData.people))appData.people.forEach(p=>{if(p.dateMet>=trip.startDate&&p.dateMet<=trip.endDate)peopleCount++});return{entries,meals,photos,topCategory:topCat?ce[topCat]||'':null,spent:spent>0?'$'+Math.round(spent):'$0',gifts,purchaseCount,stampCount,goshuinCount,transportCount,momentCount,peopleCount}}

/* === CALENDAR === */
function renderHubCalendar(trip){const container=document.getElementById('hubCalendar');if(!container)return;const start=new Date(trip.startDate+'T00:00:00'),end=new Date(trip.endDate+'T00:00:00');const months=[];let d=new Date(start.getFullYear(),start.getMonth(),1);while(d<=end){months.push({year:d.getFullYear(),month:d.getMonth()});d.setMonth(d.getMonth()+1)}let ci=0;months.forEach((m,i)=>{if(m.year===calViewDate.getFullYear()&&m.month===calViewDate.getMonth())ci=i});ci=Math.max(0,Math.min(ci,months.length-1));const ml=new Date(months[ci].year,months[ci].month).toLocaleDateString('en-AU',{month:'long',year:'numeric'});container.innerHTML=`<div class="cal-nav"><button class="cal-nav-btn" id="calPrev" onclick="calNavigate(-1)" ${ci<=0?'disabled':''}> â€¹ </button><div class="cal-month-label">${ml}</div><button class="cal-nav-btn" id="calNext" onclick="calNavigate(1)" ${ci>=months.length-1?'disabled':''}> â€º </button></div><div class="cal-weekdays">${['M','T','W','T','F','S','S'].map(d=>'<div class="cal-weekday">'+d+'</div>').join('')}</div><div class="cal-swipe-container" id="calSwipeContainer"><div class="cal-swipe-track" id="calSwipeTrack" style="transform:translateX(-${ci*100}%)">${months.map(m=>buildMonthPane(m.year,m.month,trip)).join('')}</div></div><button class="cal-today-btn" onclick="calGoToToday()">ðŸ“ Go to Today</button>`;container._months=months;container._currentIdx=ci;setupCalSwipe(container)}
function buildMonthPane(year,month,trip){const fd=new Date(year,month,1),ld=new Date(year,month+1,0);const sdow=(fd.getDay()+6)%7,dim=ld.getDate();const today=new Date();today.setHours(0,0,0,0);const ts=toDateStr(today);const j=appData.journal||{};let cells='';for(let i=0;i<sdow;i++)cells+='<div class="cal-day"></div>';for(let d=1;d<=dim;d++){const ds=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');const inT=ds>=trip.startDate&&ds<=trip.endDate;const isT=ds===ts;const hasE=j[ds]&&Array.isArray(j[ds])&&j[ds].length>0;let cls='cal-day';if(inT)cls+=' in-trip clickable';if(isT)cls+=' today';if(hasE)cls+=' has-entries';const oc=inT?` onclick="calDayClick('${ds}')"`:'';const dot=hasE&&!isT?'<span class="cal-dot"></span>':'';cells+=`<div class="${cls}"${oc}>${d}${dot}</div>`}return`<div class="cal-month-pane"><div class="cal-days">${cells}</div></div>`}
function calNavigate(dir){const container=document.getElementById('hubCalendar');if(!container||!container._months)return;let idx=container._currentIdx+dir;const months=container._months;if(idx<0||idx>=months.length)return;container._currentIdx=idx;calViewDate=new Date(months[idx].year,months[idx].month,1);document.getElementById('calSwipeTrack').style.transform=`translateX(-${idx*100}%)`;container.querySelector('.cal-month-label').textContent=new Date(months[idx].year,months[idx].month).toLocaleDateString('en-AU',{month:'long',year:'numeric'});document.getElementById('calPrev').disabled=idx<=0;document.getElementById('calNext').disabled=idx>=months.length-1}
function calGoToToday(){const trip=getTripById(hubTripId);if(!trip)return;calViewDate=new Date();renderHubCalendar(trip)}
function calDayClick(ds){openJournal(ds)}
function setupCalSwipe(container){const se=document.getElementById('calSwipeContainer'),tr=document.getElementById('calSwipeTrack');if(!se||!tr)return;let sx=0,cx=0,drag=false;const th=50;se.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;drag=true;tr.classList.add('no-transition')},{passive:true});se.addEventListener('touchmove',e=>{if(!drag)return;cx=e.touches[0].clientX;const diff=cx-sx;tr.style.transform=`translateX(${-(container._currentIdx*100)+(diff/se.offsetWidth)*100}%)`},{passive:true});se.addEventListener('touchend',()=>{if(!drag)return;drag=false;tr.classList.remove('no-transition');const diff=cx-sx;if(Math.abs(diff)>th){if(diff<0)calNavigate(1);else calNavigate(-1)}else{tr.style.transform=`translateX(-${container._currentIdx*100}%)`}cx=0;sx=0},{passive:true})}


/* === JOURNAL === */
function openJournal(ds){const trip=getTripById(hubTripId);if(!trip)return;journalDate=ds||toDateStr(new Date());if(journalDate<trip.startDate)journalDate=trip.startDate;if(journalDate>trip.endDate)journalDate=trip.endDate;renderJournal();navigateTo('journal')}
function renderJournal(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('journalContent');const d=new Date(journalDate+'T00:00:00');const start=new Date(trip.startDate+'T00:00:00');const dayNum=Math.ceil((d-start)/864e5)+1;const totalDays=Math.ceil((new Date(trip.endDate+'T00:00:00')-start)/864e5)+1;const canPrev=journalDate>trip.startDate;const canNext=journalDate<trip.endDate;let entries=getEntriesForDate(journalDate);
let html='<div class="journal-date-nav"><button onclick="journalNav(-1)" '+(canPrev?'':'disabled')+'>\u2039</button><div class="journal-date-center"><div class="journal-date-main">'+d.toLocaleDateString('en-AU',{weekday:'long',month:'long',day:'numeric'})+'</div><div class="journal-date-sub">Day '+dayNum+' of '+totalDays+'</div></div><button onclick="journalNav(1)" '+(canNext?'':'disabled')+'>\u203A</button><button class="journal-share-day-btn" onclick="openShareFromDay()" title="Share this day">ðŸ“¤</button></div>';
html+=renderJournalStickerFilter();
if(journalStickerFilter){entries=entries.filter(e=>e.stickers&&e.stickers.includes(journalStickerFilter))}
if(!entries.length){const isFiltered=journalStickerFilter&&getEntriesForDate(journalDate).length>0;html+='<div class="journal-empty"><div class="journal-empty-icon">'+(isFiltered?'ðŸ·ï¸':'\u270F\uFE0F')+'</div><p>'+(isFiltered?'No entries match this sticker filter.':'No entries yet for this day.')+'</p>'+(isFiltered?'<button class="action-btn action-btn-secondary" onclick="journalStickerFilter=null;renderJournal()" style="display:inline-flex">Show All Entries</button>':'<button class="action-btn action-btn-primary" onclick="openEntryModal()" style="display:inline-flex">\u270F\uFE0F Add First Entry</button>')+'</div>'}else{entries.forEach(function(e){html+=renderEntryCard(e)})}
html+=renderDailyReflection(journalDate);
c.innerHTML=html}

function renderEntryCard(entry){var cat=CATEGORIES.find(function(c){return c.id===entry.category});var catLabel=cat?cat.emoji+' '+cat.label:'';var maxP=6;var photosHtml='';
if(entry.photos&&entry.photos.length){var show=entry.photos.slice(0,maxP);photosHtml='<div class="entry-photos">'+show.map(function(p,i){var more=i===maxP-1&&entry.photos.length>maxP?'<div class="entry-photo-more">+'+(entry.photos.length-maxP)+'</div>':'';return'<div class="entry-photo" onclick="openLightbox(\''+entry.id+'\','+i+')"><img src="'+p+'" alt="">'+more+'</div>'}).join('')+'</div>'}
var mapsHtml='';if(entry.location&&entry.location.mapsLink){mapsHtml='<a class="entry-maps-link" href="'+entry.location.mapsLink+'" target="_blank" rel="noopener">\uD83D\uDCCD Get Directions</a>'}else if(entry.location&&entry.location.address){mapsHtml='<a class="entry-maps-link" href="https://maps.google.com/?q='+encodeURIComponent(entry.location.address)+'" target="_blank" rel="noopener">\uD83D\uDCCD '+escHtml(entry.location.address)+'</a>'}
var sectionsHtml='';var secs=[{key:'notes',icon:'\uD83D\uDCDD',label:'Notes & Observations'},{key:'feelings',icon:'\uD83D\uDCAD',label:'Feelings & Energy'},{key:'people',icon:'\uD83D\uDC65',label:'People & Encounters'},{key:'sensory',icon:'\uD83C\uDF38',label:'Sensory Details'}];
secs.forEach(function(s){if(entry[s.key])sectionsHtml+='<div class="entry-section"><button class="entry-section-toggle" onclick="this.classList.toggle(\'open\')"><span class="arrow">\u203A</span> '+s.icon+' '+s.label+'</button><div class="entry-section-content">'+escHtml(entry[s.key])+'</div></div>'});
var tagsHtml='';if(entry.tags&&entry.tags.length)tagsHtml='<div class="entry-tags">'+entry.tags.map(function(t){return'<span class="entry-tag">'+escHtml(t)+'</span>'}).join('')+'</div>';
var stickersHtml=renderEntryStickers(entry.stickers);
var mealsHtml='';if(entry.meals&&entry.meals.length)mealsHtml='<div class="entry-meals"><button class="entry-section-toggle" onclick="this.classList.toggle(\'open\')"><span class="arrow">\u203A</span> \uD83C\uDF71 Meals & Snacks ('+entry.meals.length+')</button><div class="entry-section-content" style="padding-left:0">'+entry.meals.map(function(m){return'<div class="entry-meal-item">'+(m.photo?'<img src="'+m.photo+'" alt="">':'')+'<div style="flex:1"><div class="entry-meal-name">'+escHtml(m.name)+'</div>'+(m.note?'<div style="font-size:0.8rem;color:var(--text-tertiary)">'+escHtml(m.note)+'</div>':'')+'</div>'+(m.time?'<span style="font-size:0.7rem;color:var(--text-tertiary)">'+m.time+'</span>':'')+'</div>'}).join('')+'</div></div>';
var nestedHtml='';if(entry.nestedEvents&&entry.nestedEvents.length)nestedHtml='<div class="entry-nested"><button class="entry-section-toggle open" onclick="this.classList.toggle(\'open\')"><span class="arrow">\u203A</span> \uD83C\uDFAA Experiences ('+entry.nestedEvents.length+')</button><div class="entry-section-content" style="padding-left:0;display:block">'+entry.nestedEvents.map(function(ne){return'<div class="nested-event">'+(ne.photo?'<img src="'+ne.photo+'" alt="">':'')+'<div class="nested-event-info"><div class="nested-event-name">'+escHtml(ne.name)+'</div>'+(ne.note?'<div class="nested-event-note">'+escHtml(ne.note)+'</div>':'')+'</div>'+(ne.time?'<span class="nested-event-time">'+ne.time+'</span>':'')+'</div>'}).join('')+'</div></div>';
var reflHtml='';if(entry.reflection&&entry.reflection.text)reflHtml='<div class="entry-reflection"><div class="entry-reflection-label">Reflection</div><div class="entry-reflection-text">'+escHtml(entry.reflection.text)+'</div>'+(entry.reflection.date?'<div class="entry-reflection-date">'+new Date(entry.reflection.date).toLocaleDateString('en-AU',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</div>':'')+'</div>';
return'<div class="entry-card" data-entry-id="'+entry.id+'"><div class="entry-card-header"><div class="entry-card-title">'+escHtml(entry.name)+'</div><div class="entry-card-actions"><button onclick="openShareFromEntry(\''+entry.id+'\')" title="Share">\uD83D\uDCE4</button><button onclick="addPurchaseFromJournal(\''+entry.id+'\')" title="Log Purchase">\uD83D\uDECD\uFE0F</button><button onclick="openReflectionModal(\''+entry.id+'\')" title="Reflect">\uD83D\uDCAD</button><button onclick="editEntry(\''+entry.id+'\')" title="Edit">\u270F\uFE0F</button><button onclick="deleteEntry(\''+entry.id+'\')" title="Delete">\uD83D\uDDD1\uFE0F</button></div></div><div class="entry-card-meta">'+(catLabel?'<span class="entry-cat-badge">'+catLabel+'</span>':'')+(entry.time?'<span class="entry-time-badge">'+entry.time+'</span>':'')+'</div>'+mapsHtml+photosHtml+nestedHtml+mealsHtml+sectionsHtml+stickersHtml+tagsHtml+reflHtml+'</div>'}

function getEntriesForDate(ds){return(appData.journal[ds]||[]).sort(function(a,b){return(a.time||'').localeCompare(b.time||'')})}
function journalNav(dir){var trip=getTripById(hubTripId);if(!trip)return;var d=new Date(journalDate+'T00:00:00');d.setDate(d.getDate()+dir);var nd=toDateStr(d);if(nd<trip.startDate||nd>trip.endDate)return;journalDate=nd;renderJournal()}

/* === ENTRY MODAL === */
function openEntryModal(entryId){
editingEntryId=entryId||null;entryPhotos=[];nestedEvents=[];mealItems=[];
var isEdit=!!entryId;var entry={};
if(isEdit){var entries=appData.journal[journalDate]||[];entry=entries.find(function(e){return e.id===entryId})||{};entryPhotos=[].concat(entry.photos||[]);nestedEvents=(entry.nestedEvents||[]).map(function(ne){return Object.assign({},ne)});mealItems=(entry.meals||[]).map(function(m){return Object.assign({},m)})}
document.getElementById('entryModalTitle').textContent=isEdit?'Edit Entry':'New Entry';
var cat=entry.category||'';var catObj=CATEGORIES.find(function(c){return c.id===cat});
var body=document.getElementById('entryModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">Name / Title *</label><input class="form-input" type="text" id="entryName" value="'+escAttr(entry.name||'')+'" placeholder="What are you capturing?"></div>'+
'<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="entryCategory" onchange="onCategoryChange()"><option value="">\u2014 Select \u2014</option>'+CATEGORIES.map(function(c){return'<option value="'+c.id+'" '+(cat===c.id?'selected':'')+'>'+c.emoji+' '+c.label+'</option>'}).join('')+'</select><div id="categoryPrompt" class="form-hint" style="'+(catObj?'':'display:none')+'">'+(catObj?catObj.prompt:'')+'</div></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="entryTime" value="'+(entry.time||'')+'"></div><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="entryDate" value="'+journalDate+'"></div></div>'+
'<div class="form-group"><label class="form-label">Location / Maps</label><input class="form-input" type="text" id="entryAddress" placeholder="Address or place name" value="'+escAttr((entry.location&&entry.location.address)||'')+'" style="margin-bottom:8px"><input class="form-input" type="url" id="entryMapsLink" placeholder="Google Maps URL (optional)" value="'+escAttr((entry.location&&entry.location.mapsLink)||'')+'"></div>'+
'<div class="form-group"><label class="form-label">Photos</label><div class="photo-upload-area" onclick="document.getElementById(\'photoInput\').click()"><div class="photo-upload-area-icon">\uD83D\uDCF7</div><div class="photo-upload-area-text">Tap to add photos</div></div><input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(event)"><div class="photo-preview-grid" id="photoPreviewGrid"></div></div>'+
'<div id="nestedEventsContainer" style="'+(cat==='themepark'?'':'display:none')+'"><div class="form-group"><label class="form-label">\uD83C\uDFAA Theme Park Experiences</label><div id="nestedEventsList"></div><button type="button" class="add-nested-btn" onclick="addNestedEvent()">+ Add Experience</button></div></div>'+
'<div class="form-group"><label class="form-label">\uD83C\uDF71 Meals & Snacks</label><div id="mealItemsList"></div><button type="button" class="add-meal-btn" onclick="addMealItem()">+ Add Meal/Snack</button></div>'+
'<button class="form-section-header" onclick="this.classList.toggle(\'open\')"><span class="chevron">\u203A</span> \uD83D\uDCDD Notes & Observations</button><div class="form-section-body"><div class="form-group"><textarea class="form-textarea" id="entryNotes" rows="3" placeholder="What did you notice?">'+escHtml(entry.notes||'')+'</textarea></div></div>'+
'<button class="form-section-header" onclick="this.classList.toggle(\'open\')"><span class="chevron">\u203A</span> \uD83D\uDCAD Feelings & Energy</button><div class="form-section-body"><div class="form-group"><textarea class="form-textarea" id="entryFeelings" rows="3" placeholder="How did this place feel?">'+escHtml(entry.feelings||'')+'</textarea></div></div>'+
'<button class="form-section-header" onclick="this.classList.toggle(\'open\')"><span class="chevron">\u203A</span> \uD83D\uDC65 People & Encounters</button><div class="form-section-body"><div class="form-group"><textarea class="form-textarea" id="entryPeople" rows="3" placeholder="Who did you meet?">'+escHtml(entry.people||'')+'</textarea></div></div>'+
'<button class="form-section-header" onclick="this.classList.toggle(\'open\')"><span class="chevron">\u203A</span> \uD83C\uDF38 Sensory Details</button><div class="form-section-body"><div class="form-group"><textarea class="form-textarea" id="entrySensory" rows="3" placeholder="Sounds, smells, textures...">'+escHtml(entry.sensory||'')+'</textarea></div></div>'+
'<div class="form-group"><label class="form-label">Tags</label><input class="form-input" type="text" id="entryTags" placeholder="Comma-separated tags" value="'+escAttr((entry.tags||[]).join(', '))+'"><div class="suggested-tags" id="suggestedTags"></div></div>'+
'<div class="form-group"><label class="form-label">ðŸ·ï¸ Stickers</label><div id="stickerPickerContainer"></div></div>'+
'<button class="form-btn form-btn-primary" onclick="saveEntry()">'+(isEdit?'Update Entry':'Save Entry')+'</button>'+
(isEdit?'<button class="form-btn form-btn-danger" onclick="deleteEntry(\''+entry.id+'\');closeEntryModal()">Delete Entry</button>':'');
selectedStickers=[...(entry.stickers||[])];stickerTab='vibes';
renderPhotoPreview();renderNestedEventsList();renderMealItemsList();renderSuggestedTags(cat);renderStickerPicker();
document.getElementById('entryModal').classList.add('open')}

function closeEntryModal(){document.getElementById('entryModal').classList.remove('open')}
function editEntry(id){openEntryModal(id)}
function onCategoryChange(){var cat=document.getElementById('entryCategory').value;var catObj=CATEGORIES.find(function(c){return c.id===cat});var prompt=document.getElementById('categoryPrompt');if(catObj){prompt.textContent=catObj.prompt;prompt.style.display=''}else{prompt.style.display='none'}document.getElementById('nestedEventsContainer').style.display=cat==='themepark'?'':'none';renderSuggestedTags(cat)}
function renderSuggestedTags(catId){var container=document.getElementById('suggestedTags');if(!container)return;var catObj=CATEGORIES.find(function(c){return c.id===catId});if(!catObj){container.innerHTML='';return}var currentTags=(document.getElementById('entryTags').value||'').split(',').map(function(t){return t.trim().toLowerCase()}).filter(Boolean);container.innerHTML=catObj.tags.map(function(t){return'<button type="button" class="suggested-tag '+(currentTags.includes(t)?'selected':'')+'" onclick="toggleSuggestedTag(this,\''+t+'\')">'+t+'</button>'}).join('')}
function toggleSuggestedTag(btn,tag){btn.classList.toggle('selected');var input=document.getElementById('entryTags');var tags=input.value.split(',').map(function(t){return t.trim()}).filter(Boolean);if(btn.classList.contains('selected')){if(tags.indexOf(tag)<0)tags.push(tag)}else{tags=tags.filter(function(t){return t!==tag})}input.value=tags.join(', ')}

/* === TAG STICKERS === */
let stickerTab='vibes';
function getAllStickers(){const all=[];Object.keys(STICKERS).forEach(cat=>{STICKERS[cat].forEach(s=>{all.push({...s,category:cat})})});
// include user custom stickers
if(appData.customStickers&&appData.customStickers.length){appData.customStickers.forEach(s=>{all.push({...s,category:'custom'})})}
return all}

function getStickerById(id){return getAllStickers().find(s=>s.id===id)||null}

function renderStickerPicker(){
const container=document.getElementById('stickerPickerContainer');if(!container)return;
const tabs=Object.keys(STICKERS).filter(k=>k!=='custom'||((appData.customStickers||[]).length>0));
let html='<div class="sticker-picker"><div class="sticker-picker-tabs">'+tabs.map(t=>'<button class="sticker-tab'+(t===stickerTab?' active':'')+'" onclick="switchStickerTab(\''+t+'\')">'+STICKER_TAB_LABELS[t]+'</button>').join('')+'</div>';
html+='<div class="sticker-grid" id="stickerGrid">';
const items=stickerTab==='custom'?(appData.customStickers||[]):STICKERS[stickerTab]||[];
items.forEach(s=>{const sel=selectedStickers.includes(s.id);html+='<button class="sticker-btn'+(sel?' selected':'')+'" onclick="toggleSticker(\''+s.id+'\')" data-sticker="'+s.id+'"><span class="sticker-emoji">'+s.emoji+'</span>'+s.label+'</button>'});
html+='</div></div>';
html+='<div class="sticker-selected-row" id="stickerSelectedRow"></div>';
container.innerHTML=html;
renderSelectedStickersRow()}

function renderSelectedStickersRow(){
const row=document.getElementById('stickerSelectedRow');if(!row)return;
if(!selectedStickers.length){row.innerHTML='';return}
row.innerHTML=selectedStickers.map(id=>{const s=getStickerById(id);if(!s)return'<span class="sticker-badge" onclick="toggleSticker(\''+id+'\')"><span class="sticker-emoji">ðŸ·ï¸</span>'+id+'<span class="sticker-badge-remove">âœ•</span></span>';
return'<span class="sticker-badge" onclick="toggleSticker(\''+id+'\')"><span class="sticker-emoji">'+s.emoji+'</span>'+s.label+'<span class="sticker-badge-remove">âœ•</span></span>'}).join('')}

function switchStickerTab(tab){stickerTab=tab;renderStickerPicker()}

function toggleSticker(id){
const idx=selectedStickers.indexOf(id);
if(idx>=0){selectedStickers.splice(idx,1)}else{selectedStickers.push(id)}
// update grid btn if visible
const btn=document.querySelector('.sticker-btn[data-sticker="'+id+'"]');
if(btn)btn.classList.toggle('selected',selectedStickers.includes(id));
renderSelectedStickersRow();
// sync to tags input too
syncStickersToTags()}

function syncStickersToTags(){
const input=document.getElementById('entryTags');if(!input)return;
// keep any plain text tags that aren't sticker IDs
const existing=input.value.split(',').map(t=>t.trim()).filter(Boolean);
const stickerIds=new Set(getAllStickers().map(s=>s.id));
const plainTags=existing.filter(t=>!stickerIds.has(t));
// sticker labels go in too for searchability
const stickerLabels=selectedStickers.map(id=>{const s=getStickerById(id);return s?s.label.toLowerCase():id});
input.value=[...plainTags,...stickerLabels].join(', ')}

function renderEntryStickers(stickers){
if(!stickers||!stickers.length)return'';
return'<div class="entry-stickers">'+stickers.map(id=>{const s=getStickerById(id);if(!s)return'<span class="entry-sticker"><span class="sticker-emoji">ðŸ·ï¸</span>'+escHtml(id)+'</span>';
return'<span class="entry-sticker"><span class="sticker-emoji">'+s.emoji+'</span>'+s.label+'</span>'}).join('')+'</div>'}

let journalStickerFilter=null;
function toggleJournalStickerFilter(id){
if(journalStickerFilter===id){journalStickerFilter=null}else{journalStickerFilter=id}
renderJournal()}

function getJournalUsedStickers(){
const entries=getEntriesForDate(journalDate);
const used=new Set();
entries.forEach(e=>{if(e.stickers)e.stickers.forEach(s=>used.add(s))});
return Array.from(used)}

function renderJournalStickerFilter(){
const used=getJournalUsedStickers();
if(!used.length)return'';
let html='<div class="journal-sticker-filter">';
html+='<button class="jsf-btn'+(!journalStickerFilter?' active':'')+'" onclick="journalStickerFilter=null;renderJournal()">All</button>';
used.forEach(id=>{const s=getStickerById(id);if(!s)return;
html+='<button class="jsf-btn'+(journalStickerFilter===id?' active':'')+'" onclick="toggleJournalStickerFilter(\''+id+'\')"><span class="sticker-emoji">'+s.emoji+'</span>'+s.label+'</button>'});
html+='</div>';
return html}

/* Photos */
function handlePhotoUpload(e){var files=Array.from(e.target.files);files.forEach(function(file){if(file.size>5*1024*1024){showToast('Photo too large (max 5MB)');return}var reader=new FileReader();reader.onload=function(ev){entryPhotos.push(ev.target.result);renderPhotoPreview()};reader.readAsDataURL(file)});e.target.value=''}
function renderPhotoPreview(){var grid=document.getElementById('photoPreviewGrid');if(!grid)return;grid.innerHTML=entryPhotos.map(function(p,i){return'<div class="photo-preview-item"><img src="'+p+'" alt=""><button class="photo-preview-remove" onclick="removePhoto('+i+')">\u2715</button></div>'}).join('')}
function removePhoto(i){entryPhotos.splice(i,1);renderPhotoPreview()}

/* Nested Events */
function addNestedEvent(){nestedEvents.push({name:'',time:'',note:'',photo:null});renderNestedEventsList()}
function removeNestedEvent(i){nestedEvents.splice(i,1);renderNestedEventsList()}

/* Nested Events continued */
function renderNestedEventsList(){const el=document.getElementById('nestedEventsList');if(!el)return;el.innerHTML=nestedEvents.map((ne,i)=>`<div style="padding:10px 0;border-bottom:1px solid var(--border-color)"><div class="form-row"><div class="form-group" style="margin-bottom:8px"><input class="form-input" type="text" placeholder="Experience name" value="${escAttr(ne.name)}" onchange="nestedEvents[${i}].name=this.value"></div><div class="form-group" style="margin-bottom:8px"><input class="form-input" type="time" value="${ne.time||''}" onchange="nestedEvents[${i}].time=this.value"></div></div><textarea class="form-textarea" rows="2" placeholder="Quick note..." style="min-height:50px" onchange="nestedEvents[${i}].note=this.value">${escHtml(ne.note||'')}</textarea><button type="button" style="font-size:0.75rem;color:var(--danger);background:none;border:none;cursor:pointer;margin-top:4px;font-family:var(--font-sans)" onclick="removeNestedEvent(${i})">Remove</button></div>`).join('')}

/* Meal Items */
function addMealItem(){mealItems.push({name:'',time:'',note:'',photo:null});renderMealItemsList()}
function removeMealItem(i){mealItems.splice(i,1);renderMealItemsList()}
function renderMealItemsList(){const el=document.getElementById('mealItemsList');if(!el)return;el.innerHTML=mealItems.map((m,i)=>`<div style="padding:10px 0;border-bottom:1px solid var(--border-color)"><div class="form-row"><div class="form-group" style="margin-bottom:8px"><input class="form-input" type="text" placeholder="Meal/snack name" value="${escAttr(m.name)}" onchange="mealItems[${i}].name=this.value"></div><div class="form-group" style="margin-bottom:8px"><input class="form-input" type="time" value="${m.time||''}" onchange="mealItems[${i}].time=this.value"></div></div><textarea class="form-textarea" rows="2" placeholder="Quick note..." style="min-height:50px" onchange="mealItems[${i}].note=this.value">${escHtml(m.note||'')}</textarea><div style="margin-top:6px"><button type="button" class="add-meal-btn" style="margin-top:0;padding:8px;font-size:0.75rem" onclick="document.getElementById('mealPhoto${i}').click()">ðŸ“· ${m.photo?'Change':'Add'} Photo</button><input type="file" id="mealPhoto${i}" accept="image/*" style="display:none" onchange="handleMealPhoto(event,${i})"></div><button type="button" style="font-size:0.75rem;color:var(--danger);background:none;border:none;cursor:pointer;margin-top:4px;font-family:var(--font-sans)" onclick="removeMealItem(${i})">Remove</button></div>`).join('')}
function handleMealPhoto(e,i){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large (max 5MB)');return}const reader=new FileReader();reader.onload=ev=>{mealItems[i].photo=ev.target.result;renderMealItemsList()};reader.readAsDataURL(file)}

/* Save Entry */
function saveEntry(){const name=document.getElementById('entryName').value.trim();if(!name){showToast('Please enter a name');return}
const date=document.getElementById('entryDate').value||journalDate;const entry={id:editingEntryId||generateId(),name,category:document.getElementById('entryCategory').value,time:document.getElementById('entryTime').value,location:{address:document.getElementById('entryAddress').value.trim(),mapsLink:document.getElementById('entryMapsLink').value.trim()},photos:[...entryPhotos],notes:document.getElementById('entryNotes').value.trim(),feelings:document.getElementById('entryFeelings').value.trim(),people:document.getElementById('entryPeople').value.trim(),sensory:document.getElementById('entrySensory').value.trim(),tags:document.getElementById('entryTags').value.split(',').map(t=>t.trim()).filter(Boolean),stickers:[...selectedStickers],meals:mealItems.filter(m=>m.name.trim()),nestedEvents:nestedEvents.filter(ne=>ne.name.trim()),createdAt:editingEntryId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!appData.journal[date])appData.journal[date]=[];
if(editingEntryId){const origDate=journalDate;if(origDate!==date){appData.journal[origDate]=(appData.journal[origDate]||[]).filter(e=>e.id!==editingEntryId);if(!appData.journal[date])appData.journal[date]=[]}const idx=appData.journal[date].findIndex(e=>e.id===editingEntryId);if(idx>=0){const existing=appData.journal[date][idx];entry.createdAt=existing.createdAt;appData.journal[date][idx]=entry}else{appData.journal[date].push(entry)}}else{appData.journal[date].push(entry)}
saveData();closeEntryModal();journalDate=date;renderJournal();showToast(editingEntryId?'Entry updated':'Entry saved')}

/* Delete Entry */
function deleteEntry(id){if(!confirm('Delete this entry?'))return;const entries=appData.journal[journalDate]||[];appData.journal[journalDate]=entries.filter(e=>e.id!==id);if(!appData.journal[journalDate].length)delete appData.journal[journalDate];saveData();renderJournal();showToast('Entry deleted')}

/* Reflection */
function openReflectionModal(entryId){reflectionEntryId=entryId;const entries=appData.journal[journalDate]||[];const entry=entries.find(e=>e.id===entryId);document.getElementById('reflectionText').value=(entry&&entry.reflection&&entry.reflection.text)||'';document.getElementById('reflectionModal').classList.add('open')}
function closeReflectionModal(){document.getElementById('reflectionModal').classList.remove('open')}
function saveReflection(){const text=document.getElementById('reflectionText').value.trim();if(!text){showToast('Please write a reflection');return}const entries=appData.journal[journalDate]||[];const entry=entries.find(e=>e.id===reflectionEntryId);if(entry){entry.reflection={text,date:new Date().toISOString()};saveData();closeReflectionModal();renderJournal();showToast('Reflection saved')}}

/* Lightbox */
function openLightbox(entryId,photoIdx){const entries=appData.journal[journalDate]||[];const entry=entries.find(e=>e.id===entryId);if(!entry||!entry.photos||!entry.photos[photoIdx])return;document.getElementById('lightboxImg').src=entry.photos[photoIdx];document.getElementById('lightbox').classList.add('open')}
function closeLightbox(){document.getElementById('lightbox').classList.remove('open')}

/* === SETTINGS === */
function updateSettingsDisplay(){const r=appData.settings.exchangeRate;document.getElementById('settingsRateDisplay').textContent=r?'Â¥'+parseFloat(r).toFixed(2):'Not set';document.getElementById('settingsWeatherDisplay').textContent=appData.settings.weatherApiKey?'Configured':'Not set';document.getElementById('settingsLocationDisplay').textContent=appData.settings.weatherLocation||'Auto-detect'}
function openCurrencySettings(){document.getElementById('exchangeRateInput').value=appData.settings.exchangeRate||'';document.getElementById('exchangeRateStatus').textContent=appData.settings.lastRateUpdate?'Last updated: '+new Date(appData.settings.lastRateUpdate).toLocaleDateString():'';document.getElementById('currencyModal').classList.add('open')}
function closeCurrencyModal(){document.getElementById('currencyModal').classList.remove('open')}
function saveExchangeRate(){const v=parseFloat(document.getElementById('exchangeRateInput').value);if(!v||v<=0){showToast('Enter a valid rate');return}appData.settings.exchangeRate=v;appData.settings.lastRateUpdate=new Date().toISOString();saveData();updateSettingsDisplay();updateCurrencyWidget();closeCurrencyModal();showToast('Rate saved: Â¥'+v.toFixed(2))}
function fetchExchangeRate(){const s=document.getElementById('exchangeRateStatus');s.textContent='Fetching...';fetch('https://open.er-api.com/v6/latest/AUD').then(r=>r.json()).then(d=>{if(d&&d.rates&&d.rates.JPY){document.getElementById('exchangeRateInput').value=d.rates.JPY.toFixed(2);s.textContent='Rate fetched. Click Save to apply.'}else{s.textContent='Could not fetch rate'}}).catch(()=>{s.textContent='Network error â€” enter manually'})}
function openWeatherSettings(){document.getElementById('weatherApiKeyInput').value=appData.settings.weatherApiKey||'';document.getElementById('weatherModal').classList.add('open')}
function closeWeatherModal(){document.getElementById('weatherModal').classList.remove('open')}
function saveWeatherApiKey(){const k=document.getElementById('weatherApiKeyInput').value.trim();appData.settings.weatherApiKey=k||null;saveData();updateSettingsDisplay();updateWeatherWidget();closeWeatherModal();showToast(k?'API key saved':'API key cleared')}
function openWeatherLocationSettings(){document.getElementById('weatherLocationInput').value=appData.settings.weatherLocation||'';document.getElementById('weatherLocationModal').classList.add('open')}
function closeWeatherLocationModal(){document.getElementById('weatherLocationModal').classList.remove('open')}
function saveWeatherLocation(){const loc=document.getElementById('weatherLocationInput').value.trim();appData.settings.weatherLocation=loc||null;saveData();updateSettingsDisplay();updateWeatherWidget();closeWeatherLocationModal();showToast(loc?'Location set: '+loc:'Using auto-detect')}

/* === DATA MANAGEMENT === */
function exportAllData(){const blob=new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='tabi-backup-'+toDateStr(new Date())+'.json';a.click();URL.revokeObjectURL(url);showToast('Data exported')}
function importData(){const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(!data.version){showToast('Invalid file format');return}if(!confirm('This will replace all data. Continue?'))return;appData=data;saveData();init();navigateTo('home');showToast('Data imported successfully')}catch{showToast('Invalid JSON file')}};reader.readAsText(file)};input.click()}
function clearAllData(){if(!confirm('Delete ALL data? This cannot be undone.'))return;if(!confirm('Are you really sure? All trips, entries, and photos will be lost.'))return;localStorage.removeItem(APP_KEY);appData={version:'3.0.0',settings:{theme:'spring',darkMode:false,exchangeRate:null,lastRateUpdate:null,weatherApiKey:null,weatherLocation:null},trips:[],journal:{}};saveData();init();navigateTo('home');showToast('All data cleared')}

/* === TRIP CRUD === */
function openNewTripModal(){document.getElementById('tripName').value='';document.getElementById('tripDestination').value='';document.getElementById('tripStartDate').value='';document.getElementById('tripEndDate').value='';document.getElementById('tripNotes').value='';document.getElementById('newTripModal').classList.add('open')}
function closeNewTripModal(){document.getElementById('newTripModal').classList.remove('open')}
function createTrip(e){e.preventDefault();const name=document.getElementById('tripName').value.trim();const dest=document.getElementById('tripDestination').value.trim();const start=document.getElementById('tripStartDate').value;const end=document.getElementById('tripEndDate').value;if(!name||!start||!end){showToast('Fill required fields');return}if(end<start){showToast('End must be after start');return}const trip={id:generateId(),name,destination:dest,startDate:start,endDate:end,notes:document.getElementById('tripNotes').value.trim(),createdAt:new Date().toISOString()};appData.trips.push(trip);saveData();closeNewTripModal();renderActiveTrip();renderTripsPage();updateTripDayWidget();showToast('Trip created');viewTrip(trip.id)}

/* === UTILITIES === */
function generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,6)}
function toDateStr(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function fmtDate(ds){const d=new Date(ds+'T00:00:00');return d.toLocaleDateString('en-AU',{month:'short',day:'numeric',year:'numeric'})}
function escHtml(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function escAttr(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function showToast(msg){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className='toast';t.textContent=msg;c.appendChild(t);setTimeout(()=>{t.classList.add('out');setTimeout(()=>t.remove(),200)},2500)}

/* === PURCHASES === */
let purchasePhoto=null,editingPurchaseId=null,purchaseSearchQuery='',purchaseSortOrder='newest';
function openPurchasesPage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}renderPurchases();navigateTo('purchases')}
function renderPurchases(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('purchasesContent');if(!Array.isArray(appData.purchases))appData.purchases=[];
let items=appData.purchases.filter(p=>p.date>=trip.startDate&&p.date<=trip.endDate);
const q=purchaseSearchQuery.toLowerCase().trim();if(q)items=items.filter(p=>(p.item||'').toLowerCase().includes(q)||(p.store||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q));
items.sort((a,b)=>{if(purchaseSortOrder==='oldest')return(a.date+a.time).localeCompare(b.date+b.time);return(b.date+b.time).localeCompare(a.date+a.time)});
let totalAUD=0,totalJPY=0;items.forEach(p=>{if(p.currency==='JPY')totalJPY+=p.price||0;else totalAUD+=p.price||0});
const rate=appData.settings.exchangeRate||0;const grandAUD=totalAUD+(rate>0?totalJPY/rate:0);
let html=`<div class="purchases-header"><h1>ðŸ›ï¸ Purchases</h1><p>Things you picked up along the way</p></div>`;
html+=`<div class="purchases-search"><span class="purchases-search-icon">ðŸ”</span><input type="text" placeholder="Search items or stores..." value="${escAttr(purchaseSearchQuery)}" oninput="purchaseSearchQuery=this.value;renderPurchases()"></div>`;
html+=`<div class="purchases-filters"><button class="pf-btn ${purchaseSortOrder==='newest'?'active':''}" onclick="purchaseSortOrder='newest';renderPurchases()">Newest</button><button class="pf-btn ${purchaseSortOrder==='oldest'?'active':''}" onclick="purchaseSortOrder='oldest';renderPurchases()">Oldest</button></div>`;
html+=`<div class="purchases-summary"><div class="ps-card"><div class="ps-card-value">${items.length}</div><div class="ps-card-label">Items</div></div><div class="ps-card"><div class="ps-card-value">$${Math.round(grandAUD)}</div><div class="ps-card-label">Total AUD</div></div><div class="ps-card"><div class="ps-card-value">Â¥${Math.round(totalJPY)}</div><div class="ps-card-label">Total JPY</div></div></div>`;
if(!items.length){html+=`<div class="purchases-empty"><div class="purchases-empty-icon">ðŸ›ï¸</div><p>${q?'No matches found':'No purchases logged yet'}</p>${!q?'<button class="action-btn action-btn-primary" onclick="openPurchaseModal()" style="display:inline-flex">ðŸ›ï¸ Log First Purchase</button>':''}</div>`}else{items.forEach(p=>{html+=renderPurchaseCard(p)})}
c.innerHTML=html}

function renderPurchaseCard(p){const rate=appData.settings.exchangeRate||0;let amtDisplay,convertedDisplay;
if(p.currency==='JPY'){amtDisplay='Â¥'+Number(p.price||0).toLocaleString();convertedDisplay=rate>0?'â‰ˆ $'+(p.price/rate).toFixed(2)+' AUD':''}else{amtDisplay='$'+Number(p.price||0).toFixed(2);convertedDisplay=rate>0?'â‰ˆ Â¥'+Math.round(p.price*rate)+' JPY':''}
let linkedName='';if(p.linkedJournalEntry){const j=appData.journal||{};Object.keys(j).forEach(ds=>{(j[ds]||[]).forEach(e=>{if(e.id===p.linkedJournalEntry)linkedName=e.name})})}
return`<div class="purchase-card" onclick="togglePurchaseExpand(this)"><div class="purchase-card-top"><div class="purchase-card-info"><div class="purchase-card-name">${escHtml(p.item)}</div>${p.store?'<div class="purchase-card-store">'+escHtml(p.store)+'</div>':''}<div class="purchase-card-date">${fmtDate(p.date)}${p.time?' Â· '+p.time:''}</div></div><div class="purchase-card-price"><div class="purchase-card-amount">${amtDisplay}</div>${convertedDisplay?'<div class="purchase-card-converted">'+convertedDisplay+'</div>':''}</div></div><div class="purchase-card-detail">${p.photo?'<img class="purchase-card-photo" src="'+p.photo+'" alt="">':''}${p.notes?'<div class="purchase-card-notes">'+escHtml(p.notes)+'</div>':''}${linkedName?'<button class="purchase-card-link" onclick="event.stopPropagation();goToLinkedJournalEntry(\''+p.linkedJournalEntry+'\',\''+p.date+'\')">ðŸ“– '+escHtml(linkedName)+'</button>':''}<div class="purchase-card-actions"><button onclick="event.stopPropagation();editPurchase(\'${p.id}\')">âœï¸ Edit</button><button class="danger" onclick="event.stopPropagation();deletePurchase(\'${p.id}\')">ðŸ—‘ï¸ Delete</button></div></div></div>`}

function togglePurchaseExpand(el){el.classList.toggle('expanded')}

function openPurchaseModal(purchaseId,prefill){editingPurchaseId=purchaseId||null;purchasePhoto=null;
let p={};if(purchaseId){p=appData.purchases.find(x=>x.id===purchaseId)||{};purchasePhoto=p.photo||null}
const pf=prefill||{};const trip=getTripById(hubTripId);
const journalEntries=getJournalEntriesForTrip();
let linkedVal=p.linkedJournalEntry||pf.linkedJournalEntry||'';
document.getElementById('purchaseModalTitle').textContent=purchaseId?'Edit Purchase':'Log Purchase';
const body=document.getElementById('purchaseModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">Item Name *</label><input class="form-input" type="text" id="purchaseItem" value="'+escAttr(p.item||pf.item||'')+'" placeholder="What did you get?"></div>'+
'<div class="form-group"><label class="form-label">Store / Location</label><input class="form-input" type="text" id="purchaseStore" value="'+escAttr(p.store||pf.store||'')+'" placeholder="Where did you get it?"></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Price *</label><input class="form-input" type="number" id="purchasePrice" step="0.01" value="'+(p.price||pf.price||'')+'" placeholder="Amount"></div><div class="form-group"><label class="form-label">Currency</label><select class="form-select" id="purchaseCurrency"><option value="JPY" '+((p.currency||pf.currency||'JPY')==='JPY'?'selected':'')+'>Â¥ JPY</option><option value="AUD" '+((p.currency||pf.currency)==='AUD'?'selected':'')+'>$ AUD</option></select></div></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="purchaseDate" value="'+(p.date||pf.date||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="purchaseTime" value="'+(p.time||pf.time||'')+'"></div></div>'+
'<div class="form-group"><label class="form-label">Photo</label><div class="photo-upload-area" onclick="document.getElementById(\'purchasePhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(purchasePhoto?'Tap to change photo':'Tap to add photo')+'</div></div><input type="file" id="purchasePhotoInput" accept="image/*" style="display:none" onchange="handlePurchasePhoto(event)"><div id="purchasePhotoPreview">'+(purchasePhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+purchasePhoto+'" alt=""><button class="photo-preview-remove" onclick="purchasePhoto=null;document.getElementById(\'purchasePhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="purchaseNotes" rows="3" placeholder="Any details worth remembering?">'+escHtml(p.notes||pf.notes||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">Link to Journal Entry</label><select class="form-select" id="purchaseLinkedEntry"><option value="">â€” None â€”</option>'+journalEntries.map(je=>'<option value="'+je.id+'" '+(je.id===linkedVal?'selected':'')+'>'+escHtml(je.label)+'</option>').join('')+'</select></div>'+
'<button class="form-btn form-btn-primary" onclick="savePurchase()">'+(purchaseId?'Update Purchase':'Save Purchase')+'</button>'+
(purchaseId?'<button class="form-btn form-btn-danger" onclick="deletePurchase(\''+p.id+'\');closePurchaseModal()">Delete Purchase</button>':'');
document.getElementById('purchaseModal').classList.add('open')}

function closePurchaseModal(){document.getElementById('purchaseModal').classList.remove('open')}
function handlePurchasePhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large (max 5MB)');return}const reader=new FileReader();reader.onload=ev=>{purchasePhoto=ev.target.result;document.getElementById('purchasePhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+purchasePhoto+'" alt=""><button class="photo-preview-remove" onclick="purchasePhoto=null;document.getElementById(\'purchasePhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}

function savePurchase(){const item=document.getElementById('purchaseItem').value.trim();const price=parseFloat(document.getElementById('purchasePrice').value);if(!item){showToast('Enter an item name');return}if(!price||price<=0){showToast('Enter a valid price');return}
const currency=document.getElementById('purchaseCurrency').value;const date=document.getElementById('purchaseDate').value||toDateStr(new Date());const time=document.getElementById('purchaseTime').value||'';const store=document.getElementById('purchaseStore').value.trim();const notes=document.getElementById('purchaseNotes').value.trim();const linked=document.getElementById('purchaseLinkedEntry').value||null;
const rate=appData.settings.exchangeRate||0;let amountAUD=currency==='AUD'?price:(rate>0?price/rate:0);
const purchase={id:editingPurchaseId||generateId(),item,store,date,time,price,currency,photo:purchasePhoto,notes,linkedJournalEntry:linked,createdAt:editingPurchaseId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!Array.isArray(appData.purchases))appData.purchases=[];
if(editingPurchaseId){const idx=appData.purchases.findIndex(p=>p.id===editingPurchaseId);if(idx>=0){purchase.createdAt=appData.purchases[idx].createdAt;appData.purchases[idx]=purchase}else{appData.purchases.push(purchase)}
// update linked budget entry
if(Array.isArray(appData.budget)){const bi=appData.budget.findIndex(b=>b.linkedPurchase===editingPurchaseId);if(bi>=0){appData.budget[bi].amount=price;appData.budget[bi].currency=currency;appData.budget[bi].amountAUD=amountAUD;appData.budget[bi].description=item+(store?' @ '+store:'');appData.budget[bi].date=date;appData.budget[bi].time=time;appData.budget[bi].updatedAt=new Date().toISOString()}}}else{appData.purchases.push(purchase);
// auto-create budget entry
if(!Array.isArray(appData.budget))appData.budget=[];
appData.budget.push({id:generateId(),amount:price,currency,amountAUD,category:'shopping',description:item+(store?' @ '+store:''),date,time,linkedEntry:linked,linkedPurchase:purchase.id,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}
saveData();closePurchaseModal();renderPurchases();showToast(editingPurchaseId?'Purchase updated':'Purchase saved')}

function editPurchase(id){openPurchaseModal(id)}
function deletePurchase(id){if(!confirm('Delete this purchase?'))return;appData.purchases=appData.purchases.filter(p=>p.id!==id);
if(Array.isArray(appData.budget))appData.budget=appData.budget.filter(b=>b.linkedPurchase!==id);
saveData();closePurchaseModal();if(currentPage==='purchases')renderPurchases();showToast('Purchase deleted')}

function addPurchaseFromJournal(entryId){const entries=appData.journal[journalDate]||[];const entry=entries.find(e=>e.id===entryId);if(!entry)return;
const catMap={store:'shopping',restaurant:'food',cafe:'food'};const prefill={date:journalDate,time:entry.time||'',store:entry.name||'',linkedJournalEntry:entryId,notes:'From: '+entry.name};
openPurchaseModal(null,prefill)}

function goToLinkedJournalEntry(entryId,date){const j=appData.journal||{};let found=false;Object.keys(j).forEach(ds=>{(j[ds]||[]).forEach(e=>{if(e.id===entryId){journalDate=ds;found=true}})});if(found){renderJournal();navigateTo('journal')}else{showToast('Entry not found')}}

function getJournalEntriesForTrip(){const trip=getTripById(hubTripId);if(!trip)return[];const results=[];const j=appData.journal||{};Object.keys(j).sort().forEach(ds=>{if(ds>=trip.startDate&&ds<=trip.endDate){(j[ds]||[]).forEach(e=>{results.push({id:e.id,label:fmtDate(ds)+' â€” '+e.name})})}});return results}

/* === CURRENCY CALCULATOR === */
let ccDirection='aud'; // 'aud' means top field is AUD, 'jpy' means top field is JPY
function openCurrencyCalculator(){
const rate=appData.settings.exchangeRate;
const body=document.getElementById('currencyCalcBody');
if(!rate){
body.innerHTML='<div class="cc-no-rate"><div class="cc-no-rate-icon">ðŸ’±</div><p>Set an exchange rate first to use the converter.</p><button class="cc-action-btn primary" onclick="closeCurrencyCalc();openCurrencySettings()">âš™ï¸ Set Exchange Rate</button></div>';
document.getElementById('currencyCalcModal').classList.add('open');return}
const lastUp=appData.settings.lastRateUpdate?new Date(appData.settings.lastRateUpdate).toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'}):'Unknown';
const topCur=ccDirection==='aud'?{code:'AUD',flag:'ðŸ‡¦ðŸ‡º',symbol:'$',name:'Australian Dollar'}:{code:'JPY',flag:'ðŸ‡¯ðŸ‡µ',symbol:'Â¥',name:'Japanese Yen'};
const botCur=ccDirection==='aud'?{code:'JPY',flag:'ðŸ‡¯ðŸ‡µ',symbol:'Â¥',name:'Japanese Yen'}:{code:'AUD',flag:'ðŸ‡¦ðŸ‡º',symbol:'$',name:'Australian Dollar'};
body.innerHTML=
'<div class="cc-header"><div class="cc-rate-display">Current Rate</div><div class="cc-rate-value">1 AUD = Â¥'+parseFloat(rate).toFixed(2)+'</div><div class="cc-rate-updated">Updated '+lastUp+'</div></div>'+
'<div class="cc-fields">'+
'<div class="cc-field"><div class="cc-field-label"><span class="cc-flag">'+topCur.flag+'</span>'+topCur.code+' â€” '+topCur.name+'</div><div style="position:relative"><span class="cc-field-symbol">'+topCur.symbol+'</span><input type="number" id="ccTopInput" inputmode="decimal" step="any" placeholder="0.00" oninput="ccConvert(\'top\')"></div></div>'+
'<div class="cc-swap-row"><button class="cc-swap-btn" onclick="ccSwap()" title="Swap currencies">â‡…</button></div>'+
'<div class="cc-field"><div class="cc-field-label"><span class="cc-flag">'+botCur.flag+'</span>'+botCur.code+' â€” '+botCur.name+'</div><div style="position:relative"><span class="cc-field-symbol">'+botCur.symbol+'</span><input type="number" id="ccBotInput" inputmode="decimal" step="any" placeholder="0.00" oninput="ccConvert(\'bot\')"></div></div>'+
'</div>'+
'<div class="cc-actions">'+
'<button class="cc-action-btn primary" onclick="ccAddToExpense()">ðŸ“ Add as Expense</button>'+
'<button class="cc-action-btn secondary" onclick="ccRefreshRate()">ðŸ”„ Refresh Rate</button>'+
'</div>';
document.getElementById('currencyCalcModal').classList.add('open');
setTimeout(()=>{const inp=document.getElementById('ccTopInput');if(inp)inp.focus()},350)}

function closeCurrencyCalc(){document.getElementById('currencyCalcModal').classList.remove('open')}

function ccConvert(from){
const rate=appData.settings.exchangeRate;if(!rate)return;
const topEl=document.getElementById('ccTopInput'),botEl=document.getElementById('ccBotInput');
if(!topEl||!botEl)return;
if(from==='top'){
const val=parseFloat(topEl.value);if(isNaN(val)||val===0){botEl.value='';return}
if(ccDirection==='aud'){botEl.value=(val*rate).toFixed(0)}
else{botEl.value=(val/rate).toFixed(2)}
}else{
const val=parseFloat(botEl.value);if(isNaN(val)||val===0){topEl.value='';return}
if(ccDirection==='aud'){topEl.value=(val/rate).toFixed(2)}
else{topEl.value=(val*rate).toFixed(0)}
}}

function ccSwap(){
const topEl=document.getElementById('ccTopInput'),botEl=document.getElementById('ccBotInput');
const topVal=topEl?topEl.value:'',botVal=botEl?botEl.value:'';
ccDirection=ccDirection==='aud'?'jpy':'aud';
openCurrencyCalculator();
setTimeout(()=>{const newTop=document.getElementById('ccTopInput'),newBot=document.getElementById('ccBotInput');
if(newTop&&newBot){newTop.value=botVal;newBot.value=topVal}},100);}

function ccRefreshRate(){
const btn=document.querySelector('.cc-action-btn.secondary');
if(btn){btn.textContent='â³ Fetching...';btn.disabled=true}
fetch('https://open.er-api.com/v6/latest/AUD').then(r=>r.json()).then(d=>{
if(d&&d.rates&&d.rates.JPY){
appData.settings.exchangeRate=parseFloat(d.rates.JPY.toFixed(2));
appData.settings.lastRateUpdate=new Date().toISOString();
saveData();updateSettingsDisplay();updateCurrencyWidget();
openCurrencyCalculator();showToast('Rate updated: Â¥'+appData.settings.exchangeRate.toFixed(2))}
else{showToast('Could not fetch rate');if(btn){btn.textContent='ðŸ”„ Refresh Rate';btn.disabled=false}}
}).catch(()=>{showToast('Network error');if(btn){btn.textContent='ðŸ”„ Refresh Rate';btn.disabled=false}})}

function ccAddToExpense(){
const topEl=document.getElementById('ccTopInput'),botEl=document.getElementById('ccBotInput');
const topVal=parseFloat(topEl?topEl.value:''),botVal=parseFloat(botEl?botEl.value:'');
if(isNaN(topVal)&&isNaN(botVal)){showToast('Enter an amount first');return}
let amount,currency;
if(ccDirection==='aud'){amount=!isNaN(topVal)?topVal:0;currency='AUD';if(!amount&&!isNaN(botVal)){amount=botVal;currency='JPY'}}
else{amount=!isNaN(topVal)?topVal:0;currency='JPY';if(!amount&&!isNaN(botVal)){amount=botVal;currency='AUD'}}
closeCurrencyCalc();
// Pre-fill a budget expense
const rate=appData.settings.exchangeRate||0;
let amountAUD=currency==='AUD'?amount:(rate>0?amount/rate:0);
if(!Array.isArray(appData.budget))appData.budget=[];
const expense={id:generateId(),amount,currency,amountAUD,category:'other',description:'',date:toDateStr(new Date()),time:'',linkedEntry:null,linkedPurchase:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
appData.budget.push(expense);saveData();
const sym=currency==='JPY'?'Â¥':'$';
showToast(sym+amount+' added as expense')}

/* === LANGUAGE NOTES === */
const LANG_TAGS=['greeting','food','direction','shopping','emergency','transport','accommodation','photo','gratitude','question','statement'];

const DEFAULT_PHRASES=[
// Greetings
{english:"Hello",romaji:"Konnichiwa",japanese:"ã“ã‚“ã«ã¡ã¯",tags:["greeting"],custom:false},
{english:"Good morning",romaji:"Ohayou gozaimasu",japanese:"ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™",tags:["greeting"],custom:false},
{english:"Good evening",romaji:"Konbanwa",japanese:"ã“ã‚“ã°ã‚“ã¯",tags:["greeting"],custom:false},
{english:"Thank you",romaji:"Arigatou gozaimasu",japanese:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™",tags:["greeting","gratitude"],custom:false},
{english:"Thank you very much",romaji:"Domo arigatou gozaimasu",japanese:"ã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™",tags:["gratitude"],custom:false},
{english:"Excuse me / Sorry",romaji:"Sumimasen",japanese:"ã™ã¿ã¾ã›ã‚“",tags:["greeting","question"],custom:false},
{english:"Sorry (apology)",romaji:"Gomen nasai",japanese:"ã”ã‚ã‚“ãªã•ã„",tags:["greeting"],custom:false},
{english:"Goodbye",romaji:"Sayounara",japanese:"ã•ã‚ˆã†ãªã‚‰",tags:["greeting"],custom:false},
{english:"See you later",romaji:"Mata ne",japanese:"ã¾ãŸã­",tags:["greeting"],custom:false},
{english:"Please",romaji:"Onegaishimasu",japanese:"ãŠé¡˜ã„ã—ã¾ã™",tags:["greeting","statement"],custom:false},
{english:"Yes",romaji:"Hai",japanese:"ã¯ã„",tags:["greeting","statement"],custom:false},
{english:"No",romaji:"Iie",japanese:"ã„ã„ãˆ",tags:["greeting","statement"],custom:false},
// Photo Requests
{english:"May I take your photo?",romaji:"Shashin wo totte mo ii desu ka?",japanese:"å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ",tags:["photo","question"],custom:false},
{english:"Would you like me to take a photo of you?",romaji:"Shashin wo torimashou ka?",japanese:"å†™çœŸã‚’æ’®ã‚Šã¾ã—ã‚‡ã†ã‹ï¼Ÿ",tags:["photo","question"],custom:false},
{english:"Could we take a photo together?",romaji:"Issho ni shashin wo totte mo ii desu ka?",japanese:"ä¸€ç·’ã«å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ",tags:["photo","question"],custom:false},
{english:"Thank you for letting me photograph you",romaji:"Shashin wo torasete kurete arigatou gozaimasu",japanese:"å†™çœŸã‚’æ’®ã‚‰ã›ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™",tags:["photo","gratitude"],custom:false},
// Food & Dining
{english:"I'd like to order this",romaji:"Kore wo onegaishimasu",japanese:"ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™",tags:["food","statement"],custom:false},
{english:"What do you recommend?",romaji:"Osusume wa nan desu ka?",japanese:"ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹ï¼Ÿ",tags:["food","question"],custom:false},
{english:"Delicious!",romaji:"Oishii!",japanese:"ãŠã„ã—ã„ï¼",tags:["food","statement"],custom:false},
{english:"It was very good",romaji:"Totemo oishikatta desu",japanese:"ã¨ã¦ã‚‚ãŠã„ã—ã‹ã£ãŸã§ã™",tags:["food","gratitude"],custom:false},
{english:"The check, please",romaji:"Okaikei onegaishimasu",japanese:"ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™",tags:["food","statement"],custom:false},
{english:"Do you have vegetarian options?",romaji:"Bejitarian no mono wa arimasu ka?",japanese:"ãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³ã®ã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",tags:["food","question"],custom:false},
{english:"I have a food allergy",romaji:"Shokubutsu arerugi ga arimasu",japanese:"é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã™",tags:["food","emergency"],custom:false},
{english:"Water, please",romaji:"Omizu onegaishimasu",japanese:"ãŠæ°´ãŠé¡˜ã„ã—ã¾ã™",tags:["food","statement"],custom:false},
// Directions
{english:"Where is...?",romaji:"...wa doko desu ka?",japanese:"â€¦ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",tags:["direction","question"],custom:false},
{english:"How do I get to...?",romaji:"...e wa dou ikeba ii desu ka?",japanese:"â€¦ã¸ã¯ã©ã†è¡Œã‘ã°ã„ã„ã§ã™ã‹ï¼Ÿ",tags:["direction","question"],custom:false},
{english:"Is it far?",romaji:"Tooi desu ka?",japanese:"é ã„ã§ã™ã‹ï¼Ÿ",tags:["direction","question"],custom:false},
{english:"I'm lost",romaji:"Michi ni mayoimashita",japanese:"é“ã«è¿·ã„ã¾ã—ãŸ",tags:["direction","emergency"],custom:false},
{english:"Can you show me on a map?",romaji:"Chizu de misete moraemasu ka?",japanese:"åœ°å›³ã§è¦‹ã›ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ",tags:["direction","question"],custom:false},
{english:"Left / Right / Straight",romaji:"Hidari / Migi / Massugu",japanese:"å·¦ / å³ / ã¾ã£ã™ã",tags:["direction","statement"],custom:false},
// Shopping
{english:"How much is this?",romaji:"Kore wa ikura desu ka?",japanese:"ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ",tags:["shopping","question"],custom:false},
{english:"Too expensive",romaji:"Takasugi masu",japanese:"é«˜ã™ãŽã¾ã™",tags:["shopping","statement"],custom:false},
{english:"I'll take this",romaji:"Kore wo kudasai",japanese:"ã“ã‚Œã‚’ãã ã•ã„",tags:["shopping","statement"],custom:false},
{english:"Just looking, thank you",romaji:"Mite iru dake desu, arigatou",japanese:"è¦‹ã¦ã„ã‚‹ã ã‘ã§ã™ã€ã‚ã‚ŠãŒã¨ã†",tags:["shopping","statement"],custom:false},
{english:"Do you have this in a different size?",romaji:"Betsu no saizu wa arimasu ka?",japanese:"åˆ¥ã®ã‚µã‚¤ã‚ºã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",tags:["shopping","question"],custom:false},
{english:"Can I try this on?",romaji:"Shichaku shite mo ii desu ka?",japanese:"è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ",tags:["shopping","question"],custom:false},
{english:"Do you accept credit cards?",romaji:"Kurejitto kaado wa tsukaemasu ka?",japanese:"ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ",tags:["shopping","question"],custom:false},
// Emergency
{english:"Help!",romaji:"Tasukete!",japanese:"åŠ©ã‘ã¦ï¼",tags:["emergency"],custom:false},
{english:"I need a doctor",romaji:"Isha ga hitsuyou desu",japanese:"åŒ»è€…ãŒå¿…è¦ã§ã™",tags:["emergency"],custom:false},
{english:"Where is the hospital?",romaji:"Byouin wa doko desu ka?",japanese:"ç—…é™¢ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",tags:["emergency","direction","question"],custom:false},
{english:"I don't understand",romaji:"Wakarimasen",japanese:"ã‚ã‹ã‚Šã¾ã›ã‚“",tags:["emergency","statement"],custom:false},
{english:"Do you speak English?",romaji:"Eigo wo hanasemasu ka?",japanese:"è‹±èªžã‚’è©±ã›ã¾ã™ã‹ï¼Ÿ",tags:["emergency","question"],custom:false},
{english:"Please call the police",romaji:"Keisatsu wo yonde kudasai",japanese:"è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„",tags:["emergency"],custom:false},
// Transport
{english:"Where is the station?",romaji:"Eki wa doko desu ka?",japanese:"é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",tags:["transport","direction","question"],custom:false},
{english:"One ticket to..., please",romaji:"...made kippu wo ichimai onegaishimasu",japanese:"â€¦ã¾ã§åˆ‡ç¬¦ã‚’ä¸€æžšãŠé¡˜ã„ã—ã¾ã™",tags:["transport","statement"],custom:false},
{english:"Is this the right platform?",romaji:"Kono hoomu de ii desu ka?",japanese:"ã“ã®ãƒ›ãƒ¼ãƒ ã§ã„ã„ã§ã™ã‹ï¼Ÿ",tags:["transport","question"],custom:false}
];

let langSearchQuery='',langActiveTag='',langSort='alpha',langEditingId=null;

function initLanguageData(){
if(!Array.isArray(appData.language)||!appData.language.length){
appData.language=DEFAULT_PHRASES.map(p=>({id:generateId(),english:p.english,romaji:p.romaji,japanese:p.japanese,tags:p.tags,favorite:false,custom:p.custom,usageCount:0,lastUsed:null}));
saveData()}}

function openLanguagePage(){initLanguageData();renderLanguagePage();navigateTo('language')}

function renderLanguagePage(){
const c=document.getElementById('languageContent');
if(!Array.isArray(appData.language))appData.language=[];
let phrases=[...appData.language];

// Filter
const q=langSearchQuery.toLowerCase().trim();
if(q)phrases=phrases.filter(p=>p.english.toLowerCase().includes(q)||p.romaji.toLowerCase().includes(q)||p.japanese.includes(q));
if(langActiveTag)phrases=phrases.filter(p=>p.tags&&p.tags.includes(langActiveTag));

// Sort
if(langSort==='alpha')phrases.sort((a,b)=>a.english.localeCompare(b.english));
else if(langSort==='used')phrases.sort((a,b)=>(b.usageCount||0)-(a.usageCount||0));
else if(langSort==='recent')phrases.sort((a,b)=>{if(!b.lastUsed&&!a.lastUsed)return 0;if(!b.lastUsed)return -1;if(!a.lastUsed)return 1;return b.lastUsed.localeCompare(a.lastUsed)});
else if(langSort==='favs')phrases.sort((a,b)=>(b.favorite?1:0)-(a.favorite?1:0)||a.english.localeCompare(b.english));

let html='<div class="language-header"><h1>ðŸ—£ï¸ Language Notes</h1><p>Essential phrases for your journey</p></div>';
html+='<div class="language-search"><span class="language-search-icon">ðŸ”</span><input type="text" placeholder="Search phrases..." value="'+escAttr(langSearchQuery)+'" oninput="langSearchQuery=this.value;renderLanguagePage()"></div>';

// Tags
html+='<div class="lang-tags-bar">';
html+='<button class="lang-tag-btn '+(langActiveTag===''?'active':'')+'" onclick="langActiveTag=\'\';renderLanguagePage()">All</button>';
LANG_TAGS.forEach(t=>{html+='<button class="lang-tag-btn '+(langActiveTag===t?'active':'')+'" onclick="langActiveTag=\''+t+'\';renderLanguagePage()">'+t+'</button>'});
html+='</div>';

// Sort
html+='<div class="lang-sort-bar">';
[{id:'alpha',label:'Aâ€“Z'},{id:'used',label:'Most Used'},{id:'recent',label:'Recent'},{id:'favs',label:'â˜… Favs'}].forEach(s=>{
html+='<button class="lang-sort-btn '+(langSort===s.id?'active':'')+'" onclick="langSort=\''+s.id+'\';renderLanguagePage()">'+s.label+'</button>'});
html+='</div>';

if(!phrases.length){
html+='<div class="language-empty"><div class="language-empty-icon">ðŸ—£ï¸</div><p>'+(q||langActiveTag?'No phrases match your search':'No phrases yet')+'</p></div>';
}else{
phrases.forEach(p=>{html+=renderPhraseCard(p)});
html+='<div class="phrase-count">'+phrases.length+' phrase'+(phrases.length===1?'':'s')+'</div>';
}
c.innerHTML=html}

function renderPhraseCard(p){
const favCls=p.favorite?'fav':'';
const favIcon=p.favorite?'â˜…':'â˜†';
return'<div class="phrase-card">'+
'<div class="phrase-card-top"><div class="phrase-english">'+escHtml(p.english)+'</div><button class="phrase-fav-btn '+favCls+'" onclick="togglePhraseFav(\''+p.id+'\')">'+favIcon+'</button></div>'+
'<div class="phrase-romaji">'+escHtml(p.romaji)+'</div>'+
'<div class="phrase-japanese">'+escHtml(p.japanese)+'</div>'+
(p.tags&&p.tags.length?'<div class="phrase-tags">'+p.tags.map(t=>'<span class="phrase-tag">'+t+'</span>').join('')+'</div>':'')+
'<div class="phrase-actions">'+
'<button class="phrase-action-btn show-btn" onclick="openQuickShow(\''+p.id+'\')">ðŸ‘ï¸ Show</button>'+
'<button class="phrase-action-btn" onclick="copyJapanese(\''+p.id+'\')">ðŸ“‹ Copy</button>'+
'<button class="phrase-action-btn" onclick="openInTranslate(\''+p.id+'\')">ðŸŒ Translate</button>'+
(p.custom?'<button class="phrase-action-btn" onclick="editPhrase(\''+p.id+'\')">âœï¸</button><button class="phrase-action-btn" onclick="deletePhrase(\''+p.id+'\')">ðŸ—‘ï¸</button>':'')+
'</div></div>'}

function togglePhraseFav(id){
const p=appData.language.find(x=>x.id===id);
if(p){p.favorite=!p.favorite;saveData();renderLanguagePage()}}

/* Quick Show */
function openQuickShow(id){
const p=appData.language.find(x=>x.id===id);
if(!p)return;
p.usageCount=(p.usageCount||0)+1;
p.lastUsed=new Date().toISOString();
saveData();
document.getElementById('quickShowText').textContent=p.japanese;
document.getElementById('quickShowOverlay').classList.add('open')}

function closeQuickShow(){document.getElementById('quickShowOverlay').classList.remove('open')}

/* Copy */
function copyJapanese(id){
const p=appData.language.find(x=>x.id===id);
if(!p)return;
p.usageCount=(p.usageCount||0)+1;
p.lastUsed=new Date().toISOString();
saveData();
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(p.japanese).then(()=>showToast('Copied: '+p.japanese)).catch(()=>fallbackCopy(p.japanese));
}else{fallbackCopy(p.japanese)}}

function fallbackCopy(text){
const ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.opacity='0';
document.body.appendChild(ta);ta.select();
try{document.execCommand('copy');showToast('Copied: '+text)}catch(e){showToast('Copy failed')}
document.body.removeChild(ta)}

/* Google Translate */
function openInTranslate(id){
const p=appData.language.find(x=>x.id===id);
if(!p)return;
p.usageCount=(p.usageCount||0)+1;
p.lastUsed=new Date().toISOString();
saveData();
const encoded=encodeURIComponent(p.english);
const webUrl='https://translate.google.com/?sl=en&tl=ja&text='+encoded;
// On mobile, try the app intent first, fall back to web
const isAndroid=/android/i.test(navigator.userAgent);
if(isAndroid){
const intentUrl='intent://translate?sl=en&tl=ja&text='+encoded+'#Intent;scheme=googletranslate;package=com.google.android.apps.translate;S.browser_fallback_url='+encodeURIComponent(webUrl)+';end';
window.location.href=intentUrl;
}else{
window.location.href=webUrl}}

/* Add/Edit Phrase */
function openAddPhraseModal(phraseId){
langEditingId=phraseId||null;
let p={};
if(phraseId){p=appData.language.find(x=>x.id===phraseId)||{}}
document.getElementById('addPhraseModalTitle').textContent=phraseId?'Edit Phrase':'Add Phrase';
const body=document.getElementById('addPhraseModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">English *</label><input class="form-input" type="text" id="phraseEnglish" value="'+escAttr(p.english||'')+'" placeholder="English phrase"></div>'+
'<div class="form-group"><label class="form-label">Romaji (pronunciation)</label><input class="form-input" type="text" id="phraseRomaji" value="'+escAttr(p.romaji||'')+'" placeholder="How to pronounce it"></div>'+
'<div class="form-group"><label class="form-label">Japanese *</label><input class="form-input" type="text" id="phraseJapanese" value="'+escAttr(p.japanese||'')+'" placeholder="Japanese characters"></div>'+
'<div class="form-group"><label class="form-label">Tags</label><div class="suggested-tags" id="phraseTags">'+
LANG_TAGS.map(t=>'<button type="button" class="suggested-tag '+((p.tags||[]).includes(t)?'selected':'')+'" onclick="this.classList.toggle(\'selected\')">'+t+'</button>').join('')+
'</div></div>'+
'<button class="form-btn form-btn-primary" onclick="savePhrase()">'+(phraseId?'Update Phrase':'Add Phrase')+'</button>'+
(phraseId?'<button class="form-btn form-btn-danger" onclick="deletePhrase(\''+phraseId+'\');closeAddPhraseModal()">Delete Phrase</button>':'');
document.getElementById('addPhraseModal').classList.add('open')}

function closeAddPhraseModal(){document.getElementById('addPhraseModal').classList.remove('open')}

function savePhrase(){
const english=document.getElementById('phraseEnglish').value.trim();
const romaji=document.getElementById('phraseRomaji').value.trim();
const japanese=document.getElementById('phraseJapanese').value.trim();
if(!english||!japanese){showToast('English and Japanese are required');return}
const tagBtns=document.querySelectorAll('#phraseTags .suggested-tag.selected');
const tags=Array.from(tagBtns).map(b=>b.textContent);
if(langEditingId){
const p=appData.language.find(x=>x.id===langEditingId);
if(p){p.english=english;p.romaji=romaji;p.japanese=japanese;p.tags=tags}
}else{
appData.language.push({id:generateId(),english,romaji,japanese,tags,favorite:false,custom:true,usageCount:0,lastUsed:null});
}
saveData();closeAddPhraseModal();renderLanguagePage();
showToast(langEditingId?'Phrase updated':'Phrase added')}

function editPhrase(id){openAddPhraseModal(id)}

function deletePhrase(id){
if(!confirm('Delete this phrase?'))return;
appData.language=appData.language.filter(p=>p.id!==id);
saveData();closeAddPhraseModal();
if(currentPage==='language')renderLanguagePage();
showToast('Phrase deleted')}

/* === SOUVENIRS === */
let souvenirPhoto=null,editingSouvenirId=null,souvenirSearchQuery='',souvenirFilterRecipient='',souvenirFilterStatus='all',souvenirSortOrder='newest';

function openSouvenirsPage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}renderSouvenirs();navigateTo('souvenirs')}

function getUniqueRecipients(){if(!Array.isArray(appData.souvenirs))return[];const set=new Set();appData.souvenirs.forEach(s=>{if(s.recipient)set.add(s.recipient)});return[...set].sort()}

function renderSouvenirs(){
const trip=getTripById(hubTripId);if(!trip)return;
const c=document.getElementById('souvenirsContent');
if(!Array.isArray(appData.souvenirs))appData.souvenirs=[];
let items=appData.souvenirs.filter(s=>s.date>=trip.startDate&&s.date<=trip.endDate);

// Exclude "for myself" items
items=items.filter(s=>!s.forMyself);

const q=souvenirSearchQuery.toLowerCase().trim();
if(q)items=items.filter(s=>(s.item||'').toLowerCase().includes(q)||(s.recipient||'').toLowerCase().includes(q)||(s.store||'').toLowerCase().includes(q)||(s.notes||'').toLowerCase().includes(q));
if(souvenirFilterRecipient)items=items.filter(s=>s.recipient===souvenirFilterRecipient);
if(souvenirFilterStatus==='purchased')items=items.filter(s=>s.status==='purchased');
else if(souvenirFilterStatus==='planned')items=items.filter(s=>s.status==='planned');

items.sort((a,b)=>{if(souvenirSortOrder==='oldest')return(a.date+(a.time||'')).localeCompare(b.date+(b.time||''));return(b.date+(b.time||'')).localeCompare(a.date+(a.time||''))});

const recipients=getUniqueRecipients();
let totalAUD=0,totalJPY=0,purchasedCount=0,plannedCount=0;
items.forEach(s=>{
if(s.status==='purchased'){purchasedCount++;if(s.currency==='JPY')totalJPY+=(s.price||0);else totalAUD+=(s.price||0)}
else{plannedCount++}
});
const rate=appData.settings.exchangeRate||0;
const grandAUD=totalAUD+(rate>0?totalJPY/rate:0);

let html='<div class="souvenirs-header"><h1>ðŸŽ Souvenirs</h1><p>Gifts for the people you love</p></div>';
html+='<div class="souvenirs-search"><span class="souvenirs-search-icon">ðŸ”</span><input type="text" placeholder="Search souvenirs..." value="'+escAttr(souvenirSearchQuery)+'" oninput="souvenirSearchQuery=this.value;renderSouvenirs()"></div>';

// Recipient filter
html+='<div class="souvenirs-filters">';
html+='<button class="sf-btn '+(souvenirFilterRecipient===''?'active':'')+'" onclick="souvenirFilterRecipient=\'\';renderSouvenirs()">All</button>';
recipients.forEach(r=>{const prof=getRecipientProfile(r);const avatarHtml=prof&&prof.photo?'<img class="recipient-avatar-sm" src="'+prof.photo+'" alt="">':'';html+='<button class="sf-btn sf-btn-with-avatar '+(souvenirFilterRecipient===r?'active':'')+'" onclick="souvenirFilterRecipient=\''+escAttr(r)+'\';renderSouvenirs()">'+avatarHtml+escHtml(r)+'</button>'});
html+='</div>';

// Status + sort filters
html+='<div class="souvenirs-filters">';
[{id:'all',label:'All'},{id:'purchased',label:'âœ… Purchased'},{id:'planned',label:'ðŸ“‹ Planned'}].forEach(f=>{
html+='<button class="sf-btn '+(souvenirFilterStatus===f.id?'active':'')+'" onclick="souvenirFilterStatus=\''+f.id+'\';renderSouvenirs()">'+f.label+'</button>'});
html+='<button class="sf-btn '+(souvenirSortOrder==='newest'?'active':'')+'" onclick="souvenirSortOrder=\'newest\';renderSouvenirs()">Newest</button>';
html+='<button class="sf-btn '+(souvenirSortOrder==='oldest'?'active':'')+'" onclick="souvenirSortOrder=\'oldest\';renderSouvenirs()">Oldest</button>';
html+='</div>';

// Summary
html+='<div class="souvenirs-summary"><div class="ss-card"><div class="ss-card-value">'+purchasedCount+'</div><div class="ss-card-label">Purchased</div></div><div class="ss-card"><div class="ss-card-value">'+plannedCount+'</div><div class="ss-card-label">Planned</div></div><div class="ss-card"><div class="ss-card-value">$'+Math.round(grandAUD)+'</div><div class="ss-card-label">Total AUD</div></div></div>';

if(!items.length){
html+='<div class="souvenirs-empty"><div class="souvenirs-empty-icon">ðŸŽ</div><p>'+(q||souvenirFilterRecipient||souvenirFilterStatus!=='all'?'No matches found':'No souvenirs logged yet')+'</p>'+(!q&&!souvenirFilterRecipient?'<button class="action-btn action-btn-primary" onclick="openSouvenirModal()" style="display:inline-flex">ðŸŽ Log First Souvenir</button>':'')+'</div>';
}else{
// Group by recipient if no specific filter
if(!souvenirFilterRecipient){
const grouped={};items.forEach(s=>{const r=s.recipient||'Unassigned';if(!grouped[r])grouped[r]=[];grouped[r].push(s)});
Object.keys(grouped).sort().forEach(r=>{
const prof=getRecipientProfile(r);const trip=getTripById(hubTripId);const spent=getRecipientSpent(r,trip);const budget=prof&&prof.budget?prof.budget:0;
let profileHtml='';
if(souvenirFilterRecipient===''&&prof){
const pctUsed=budget>0?Math.min(100,Math.round(spent/budget*100)):0;
profileHtml='<div class="recipient-profile-card"><div class="recipient-profile-top">'+(prof.photo?'<img class="recipient-avatar-lg" src="'+prof.photo+'" alt="">':'<div class="recipient-avatar-placeholder lg">'+r.charAt(0).toUpperCase()+'</div>')+'<div class="recipient-profile-name">'+escHtml(r)+'</div>'+(prof.bio?'<div class="recipient-profile-bio">'+escHtml(prof.bio)+'</div>':'')+'</div>'+(budget>0?'<div class="recipient-budget-bar"><div class="recipient-budget-fill'+(pctUsed>100?' over':'')+'" style="width:'+Math.min(100,pctUsed)+'%"></div></div><div class="recipient-budget-text"><span>$'+Math.round(spent)+' spent</span><span>$'+budget+' budget</span></div>':'<div style="font-size:0.7rem;color:var(--text-tertiary);margin-top:4px">$'+Math.round(spent)+' spent</div>')+'<div class="recipient-profile-actions"><button onclick="event.stopPropagation();openRecipientProfileModal(\''+escAttr(r)+'\')">âœï¸ Edit Profile</button></div></div>'}
html+='<div class="souvenirs-recipient-section">'+(profileHtml||'')+'<div class="souvenirs-recipient-header"><div class="souvenirs-recipient-name">'+getRecipientAvatar(r)+' '+escHtml(r)+' <span style="font-weight:400;font-size:0.8rem;color:var(--text-tertiary)">('+grouped[r].length+')</span></div><button style="background:none;border:none;cursor:pointer;font-size:0.8rem;color:var(--accent-primary);font-family:var(--font-sans)" onclick="openRecipientProfileModal(\''+escAttr(r)+'\')">ðŸ‘¤</button></div>';
grouped[r].forEach(s=>{html+=renderSouvenirCard(s)});
html+='</div>'});
}else{
// Show profile card for filtered recipient
const prof=getRecipientProfile(souvenirFilterRecipient);const trip=getTripById(hubTripId);const spent=getRecipientSpent(souvenirFilterRecipient,trip);const budget=prof&&prof.budget?prof.budget:0;
const pctUsed=budget>0?Math.min(100,Math.round(spent/budget*100)):0;
html+='<div class="recipient-profile-card"><div class="recipient-profile-top">'+(prof&&prof.photo?'<img class="recipient-avatar-lg" src="'+prof.photo+'" alt="">':'<div class="recipient-avatar-placeholder lg">'+souvenirFilterRecipient.charAt(0).toUpperCase()+'</div>')+'<div class="recipient-profile-name">'+escHtml(souvenirFilterRecipient)+'</div>'+(prof&&prof.bio?'<div class="recipient-profile-bio">'+escHtml(prof.bio)+'</div>':'')+'</div>'+(budget>0?'<div class="recipient-budget-bar"><div class="recipient-budget-fill'+(pctUsed>100?' over':'')+'" style="width:'+Math.min(100,pctUsed)+'%"></div></div><div class="recipient-budget-text"><span>$'+Math.round(spent)+' spent</span><span>$'+budget+' budget</span></div>':'<div style="font-size:0.7rem;color:var(--text-tertiary);margin-top:4px">$'+Math.round(spent)+' spent</div>')+'<div class="recipient-profile-actions"><button onclick="openRecipientProfileModal(\''+escAttr(souvenirFilterRecipient)+'\')">âœï¸ Edit Profile</button></div></div>';
items.forEach(s=>{html+=renderSouvenirCard(s)});
}
}
c.innerHTML=html}

function renderSouvenirCard(s){
const rate=appData.settings.exchangeRate||0;
let amtDisplay='',convertedDisplay='';
if(s.status==='purchased'&&s.price){
if(s.currency==='JPY'){amtDisplay='Â¥'+Number(s.price).toLocaleString();convertedDisplay=rate>0?'â‰ˆ $'+(s.price/rate).toFixed(2)+' AUD':''}
else{amtDisplay='$'+Number(s.price).toFixed(2);convertedDisplay=rate>0?'â‰ˆ Â¥'+Math.round(s.price*rate)+' JPY':''}
}
const statusCls=s.status==='purchased'?'purchased':'planned';
const statusLabel=s.status==='purchased'?'âœ… Purchased':'ðŸ“‹ Planned';

return'<div class="souvenir-card" onclick="toggleSouvenirExpand(this)">'+
'<div class="souvenir-card-top"><div class="souvenir-card-info">'+
'<div class="souvenir-card-name">'+escHtml(s.item)+'</div>'+
(s.recipient?'<div class="souvenir-card-recipient">For: '+escHtml(s.recipient)+'</div>':'')+
(s.store?'<div class="souvenir-card-store">'+escHtml(s.store)+'</div>':'')+
'<div class="souvenir-card-date">'+fmtDate(s.date)+'</div>'+
'<div class="souvenir-card-status '+statusCls+'">'+statusLabel+'</div>'+
'</div>'+
(amtDisplay?'<div class="souvenir-card-price"><div class="souvenir-card-amount">'+amtDisplay+'</div>'+(convertedDisplay?'<div class="souvenir-card-converted">'+convertedDisplay+'</div>':'')+'</div>':'')+
'</div>'+
'<div class="souvenir-card-detail">'+
(s.photo?'<img class="souvenir-card-photo" src="'+s.photo+'" alt="">':'')+
(s.notes?'<div class="souvenir-card-notes">'+escHtml(s.notes)+'</div>':'')+
'<div class="souvenir-card-actions">'+
'<button onclick="event.stopPropagation();editSouvenir(\''+s.id+'\')">âœï¸ Edit</button>'+
(s.status==='planned'?'<button onclick="event.stopPropagation();markSouvenirPurchased(\''+s.id+'\')">âœ… Mark Purchased</button>':'')+
'<button class="danger" onclick="event.stopPropagation();deleteSouvenir(\''+s.id+'\')">ðŸ—‘ï¸ Delete</button>'+
'</div></div></div>'}

function toggleSouvenirExpand(el){el.classList.toggle('expanded')}

function openSouvenirModal(souvenirId,prefill){
editingSouvenirId=souvenirId||null;souvenirPhoto=null;
let s={};if(souvenirId){s=appData.souvenirs.find(x=>x.id===souvenirId)||{};souvenirPhoto=s.photo||null}
const pf=prefill||{};
const recipients=getUniqueRecipients();
document.getElementById('souvenirModalTitle').textContent=souvenirId?'Edit Souvenir':'Log Souvenir';
const body=document.getElementById('souvenirModalBody');
const currentRecipient=s.recipient||pf.recipient||'';
const statusVal=s.status||pf.status||'purchased';
const forMyselfVal=s.forMyself||false;

body.innerHTML=
'<div class="form-group"><label class="form-label">Item Name *</label><input class="form-input" type="text" id="souvenirItem" value="'+escAttr(s.item||pf.item||'')+'" placeholder="What did you get?"></div>'+
'<div class="form-group"><label class="form-label">Recipient *</label><input class="form-input" type="text" id="souvenirRecipient" value="'+escAttr(currentRecipient)+'" placeholder="Who is this for?" list="recipientList"><datalist id="recipientList">'+recipients.map(r=>'<option value="'+escAttr(r)+'">').join('')+'</datalist></div>'+
'<div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><input type="checkbox" id="souvenirForMyself" '+(forMyselfVal?'checked':'')+' style="width:20px;height:20px;accent-color:var(--accent-primary)"><label for="souvenirForMyself" style="font-size:0.85rem;color:var(--text-secondary);cursor:pointer">This is for myself (exclude from souvenirs view)</label></div>'+
'<div class="form-group"><label class="form-label">Store / Location</label><input class="form-input" type="text" id="souvenirStore" value="'+escAttr(s.store||pf.store||'')+'" placeholder="Where did you get it?"></div>'+
'<div class="form-group"><label class="form-label">Status</label><select class="form-select" id="souvenirStatus"><option value="purchased" '+(statusVal==='purchased'?'selected':'')+'>âœ… Purchased</option><option value="planned" '+(statusVal==='planned'?'selected':'')+'>ðŸ“‹ Planned</option></select></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Price</label><input class="form-input" type="number" id="souvenirPrice" step="0.01" value="'+(s.price||pf.price||'')+'" placeholder="Amount"></div><div class="form-group"><label class="form-label">Currency</label><select class="form-select" id="souvenirCurrency"><option value="JPY" '+((s.currency||pf.currency||'JPY')==='JPY'?'selected':'')+'>Â¥ JPY</option><option value="AUD" '+((s.currency||pf.currency)==='AUD'?'selected':'')+'>$ AUD</option></select></div></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="souvenirDate" value="'+(s.date||pf.date||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="souvenirTime" value="'+(s.time||pf.time||'')+'"></div></div>'+
'<div class="form-group"><label class="form-label">Photo</label><div class="photo-upload-area" onclick="document.getElementById(\'souvenirPhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(souvenirPhoto?'Tap to change photo':'Tap to add photo')+'</div></div><input type="file" id="souvenirPhotoInput" accept="image/*" style="display:none" onchange="handleSouvenirPhoto(event)"><div id="souvenirPhotoPreview">'+(souvenirPhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+souvenirPhoto+'" alt=""><button class="photo-preview-remove" onclick="souvenirPhoto=null;document.getElementById(\'souvenirPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="souvenirNotes" rows="3" placeholder="Any details worth remembering?">'+escHtml(s.notes||pf.notes||'')+'</textarea></div>'+
'<button class="form-btn form-btn-primary" onclick="saveSouvenir()">'+(souvenirId?'Update Souvenir':'Save Souvenir')+'</button>'+
(souvenirId?'<button class="form-btn form-btn-danger" onclick="deleteSouvenir(\''+s.id+'\');closeSouvenirModal()">Delete Souvenir</button>':'');
document.getElementById('souvenirModal').classList.add('open')}

function closeSouvenirModal(){document.getElementById('souvenirModal').classList.remove('open')}

function handleSouvenirPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large (max 5MB)');return}const reader=new FileReader();reader.onload=ev=>{souvenirPhoto=ev.target.result;document.getElementById('souvenirPhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+souvenirPhoto+'" alt=""><button class="photo-preview-remove" onclick="souvenirPhoto=null;document.getElementById(\'souvenirPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}

function saveSouvenir(){
const item=document.getElementById('souvenirItem').value.trim();
const recipient=document.getElementById('souvenirRecipient').value.trim();
if(!item){showToast('Enter an item name');return}
const price=parseFloat(document.getElementById('souvenirPrice').value)||0;
const currency=document.getElementById('souvenirCurrency').value;
const date=document.getElementById('souvenirDate').value||toDateStr(new Date());
const time=document.getElementById('souvenirTime').value||'';
const store=document.getElementById('souvenirStore').value.trim();
const notes=document.getElementById('souvenirNotes').value.trim();
const status=document.getElementById('souvenirStatus').value;
const forMyself=document.getElementById('souvenirForMyself').checked;
const rate=appData.settings.exchangeRate||0;
let amountAUD=currency==='AUD'?price:(rate>0?price/rate:0);

const souvenir={id:editingSouvenirId||generateId(),item,recipient:recipient||'Unassigned',store,date,time,price,currency,photo:souvenirPhoto,notes,status,forMyself,createdAt:editingSouvenirId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};

if(!Array.isArray(appData.souvenirs))appData.souvenirs=[];
if(!Array.isArray(appData.budget))appData.budget=[];

if(editingSouvenirId){
const idx=appData.souvenirs.findIndex(x=>x.id===editingSouvenirId);
if(idx>=0){souvenir.createdAt=appData.souvenirs[idx].createdAt;appData.souvenirs[idx]=souvenir}else{appData.souvenirs.push(souvenir)}
// Update linked budget entry
if(status==='purchased'&&price>0){
const bi=appData.budget.findIndex(b=>b.linkedSouvenir===editingSouvenirId);
if(bi>=0){appData.budget[bi].amount=price;appData.budget[bi].currency=currency;appData.budget[bi].amountAUD=amountAUD;appData.budget[bi].description='ðŸŽ '+item+(recipient?' for '+recipient:'');appData.budget[bi].date=date;appData.budget[bi].time=time;appData.budget[bi].updatedAt=new Date().toISOString()}
else{appData.budget.push({id:generateId(),amount:price,currency,amountAUD,category:'souvenirs',description:'ðŸŽ '+item+(recipient?' for '+recipient:''),date,time,linkedEntry:null,linkedPurchase:null,linkedSouvenir:souvenir.id,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}}
else{appData.budget=appData.budget.filter(b=>b.linkedSouvenir!==editingSouvenirId)}
}else{
appData.souvenirs.push(souvenir);
// Auto-create budget entry for purchased items
if(status==='purchased'&&price>0){
appData.budget.push({id:generateId(),amount:price,currency,amountAUD,category:'souvenirs',description:'ðŸŽ '+item+(recipient?' for '+recipient:''),date,time,linkedEntry:null,linkedPurchase:null,linkedSouvenir:souvenir.id,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}}

saveData();closeSouvenirModal();renderSouvenirs();showToast(editingSouvenirId?'Souvenir updated':'Souvenir saved')}

function editSouvenir(id){openSouvenirModal(id)}

function deleteSouvenir(id){if(!confirm('Delete this souvenir?'))return;
appData.souvenirs=appData.souvenirs.filter(s=>s.id!==id);
if(Array.isArray(appData.budget))appData.budget=appData.budget.filter(b=>b.linkedSouvenir!==id);
saveData();closeSouvenirModal();if(currentPage==='souvenirs')renderSouvenirs();showToast('Souvenir deleted')}

function markSouvenirPurchased(id){
const s=appData.souvenirs.find(x=>x.id===id);
if(!s)return;
s.status='purchased';
s.updatedAt=new Date().toISOString();
// If it has a price, add to budget
if(s.price&&s.price>0){
const rate=appData.settings.exchangeRate||0;
const amountAUD=s.currency==='AUD'?s.price:(rate>0?s.price/rate:0);
if(!Array.isArray(appData.budget))appData.budget=[];
const existing=appData.budget.find(b=>b.linkedSouvenir===id);
if(!existing){
appData.budget.push({id:generateId(),amount:s.price,currency:s.currency,amountAUD,category:'souvenirs',description:'ðŸŽ '+s.item+(s.recipient?' for '+s.recipient:''),date:s.date,time:s.time||'',linkedEntry:null,linkedPurchase:null,linkedSouvenir:s.id,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}}
saveData();renderSouvenirs();showToast('Marked as purchased')}

/* === RECIPIENT PROFILES === */
function getRecipientProfile(name){if(!appData.recipientProfiles)appData.recipientProfiles={};return appData.recipientProfiles[name]||null}
function getRecipientAvatar(name,size){const p=getRecipientProfile(name);if(p&&p.photo)return'<img class="recipient-avatar'+(size==='sm'?'-sm':'')+'" src="'+p.photo+'" alt="">';const initial=name?name.charAt(0).toUpperCase():'?';return'<div class="recipient-avatar-placeholder'+(size==='lg'?' lg':'')+'">'+initial+'</div>'}
let recipientProfilePhoto=null,currentProfileName='';
function openRecipientProfileModal(name){
currentProfileName=name;
const prof=getRecipientProfile(name)||{};
recipientProfilePhoto=prof.photo||null;
document.getElementById('recipientProfileModalTitle').textContent='Profile: '+name;
const body=document.getElementById('recipientProfileModalBody');
const avatarHtml=recipientProfilePhoto?'<img class="recipient-avatar-lg" src="'+recipientProfilePhoto+'" alt="" style="margin:0 auto;display:block">':'<div class="recipient-avatar-placeholder lg" style="margin:0 auto">'+escHtml(name.charAt(0).toUpperCase())+'</div>';
body.innerHTML=
'<div style="text-align:center;margin-bottom:16px">'+avatarHtml+'<div style="margin-top:8px"><button class="phrase-action-btn" id="recipientPhotoBtnTrigger">ðŸ“· '+(recipientProfilePhoto?'Change':'Add')+' Photo</button><input type="file" id="recipientPhotoInput" accept="image/*" style="display:none"></div></div>'+
'<div class="form-group"><label class="form-label">Bio / Notes</label><textarea class="form-textarea" id="recipientBio" rows="3" placeholder="Relationship, interests, gift ideas...">'+(escHtml(prof.bio||''))+'</textarea></div>'+
'<div class="form-group"><label class="form-label">Budget (AUD)</label><input class="form-input" type="number" id="recipientBudget" step="1" value="'+(prof.budget||'')+'" placeholder="e.g., 100"></div>'+
'<button class="form-btn form-btn-primary" id="recipientSaveBtn">Save Profile</button>';
document.getElementById('recipientPhotoBtnTrigger').addEventListener('click',function(){document.getElementById('recipientPhotoInput').click()});
document.getElementById('recipientPhotoInput').addEventListener('change',handleRecipientPhoto);
document.getElementById('recipientSaveBtn').addEventListener('click',function(){saveRecipientProfile(currentProfileName)});
document.getElementById('recipientProfileModal').classList.add('open')}
function closeRecipientProfileModal(){document.getElementById('recipientProfileModal').classList.remove('open')}
function handleRecipientPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large (max 5MB)');return}const reader=new FileReader();reader.onload=ev=>{recipientProfilePhoto=ev.target.result;openRecipientProfileModal(currentProfileName)};reader.readAsDataURL(file);e.target.value=''}
function saveRecipientProfile(name){if(!appData.recipientProfiles)appData.recipientProfiles={};
appData.recipientProfiles[name]={photo:recipientProfilePhoto,bio:document.getElementById('recipientBio').value.trim(),budget:parseFloat(document.getElementById('recipientBudget').value)||0};
saveData();closeRecipientProfileModal();if(currentPage==='souvenirs')renderSouvenirs();showToast('Profile saved')}
function getRecipientSpent(name,trip){if(!Array.isArray(appData.souvenirs)||!trip)return 0;const rate=appData.settings.exchangeRate||0;let total=0;appData.souvenirs.forEach(s=>{if(s.recipient===name&&s.status==='purchased'&&s.date>=trip.startDate&&s.date<=trip.endDate){if(s.currency==='AUD')total+=(s.price||0);else if(rate>0)total+=(s.price||0)/rate}});return total}

/* === STAMPS === */
let stampPhoto=null,editingStampId=null,stampsTab='collection',stampsView='list',stampPlanDate='';
function openStampsPage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}if(!Array.isArray(appData.stamps))appData.stamps=[];if(!appData.stampPlans)appData.stampPlans={};renderStamps();navigateTo('stamps')}
function renderStamps(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('stampsContent');
const collected=(appData.stamps||[]).filter(s=>s.date>=trip.startDate&&s.date<=trip.endDate);
const questCount=collected.filter(s=>s.stampQuest).length;
let html='<div class="stamps-header"><h1>ðŸŽ« Stamp Rally</h1><p>Collect memories at every station</p></div>';
html+='<div class="stamps-tabs"><button class="stamps-tab '+(stampsTab==='collection'?'active':'')+'" onclick="stampsTab=\'collection\';renderStamps()">Collection ('+collected.length+')</button><button class="stamps-tab '+(stampsTab==='plan'?'active':'')+'" onclick="stampsTab=\'plan\';renderStamps()">Daily Plan</button></div>';
html+='<div class="stamps-stats"><div class="ps-card"><div class="ps-card-value">'+collected.length+'</div><div class="ps-card-label">Collected</div></div><div class="ps-card"><div class="ps-card-value">'+questCount+'</div><div class="ps-card-label">Quest</div></div><div class="ps-card"><div class="ps-card-value">'+(collected.length>0?new Set(collected.map(s=>s.date)).size:0)+'</div><div class="ps-card-label">Days Active</div></div></div>';
if(stampsTab==='collection'){
if(!collected.length){html+='<div class="stamps-empty"><div class="stamps-empty-icon">ðŸŽ«</div><p>No stamps collected yet</p><button class="action-btn action-btn-primary" onclick="openStampModal()" style="display:inline-flex">ðŸŽ« Log First Stamp</button></div>'}
else{
html+='<div class="stamps-tabs" style="margin-bottom:12px"><button class="stamps-tab '+(stampsView==='list'?'active':'')+'" onclick="stampsView=\'list\';renderStamps()">List</button><button class="stamps-tab '+(stampsView==='grid'?'active':'')+'" onclick="stampsView=\'grid\';renderStamps()">Grid</button></div>';
if(stampsView==='grid'){html+='<div class="stamp-grid">';collected.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).forEach(s=>{html+='<div class="stamp-grid-item" onclick="openStampModal(\''+s.id+'\')">'+(s.photo?'<img src="'+s.photo+'" alt="">':'<span style="font-size:2rem;opacity:0.3">ðŸŽ«</span>')+'<span class="stamp-grid-label">'+escHtml(s.location||s.name||'')+'</span></div>'});html+='</div>'}
else{collected.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).forEach(s=>{html+=renderStampCard(s)})}
}}else{
// Daily Plan tab
html+='<div class="form-group"><label class="form-label">Plan date</label><input class="form-input" type="date" value="'+(stampPlanDate||toDateStr(new Date()))+'" onchange="stampPlanDate=this.value;renderStamps()" min="'+trip.startDate+'" max="'+trip.endDate+'"></div>';
const pd=stampPlanDate||toDateStr(new Date());
const plans=(appData.stampPlans||{})[pd]||[];
if(!plans.length){html+='<div class="stamps-empty" style="padding:24px"><p>No stamps planned for this day</p></div>'}
else{plans.forEach((p,i)=>{html+='<div class="stamp-plan-item"><input type="checkbox" class="stamp-plan-check" '+(p.collected?'checked':'')+' onchange="toggleStampPlan(\''+pd+'\','+i+',this.checked)"><div class="stamp-plan-info"><div class="stamp-plan-name"'+(p.collected?' style="text-decoration:line-through;opacity:0.5"':'')+'>'+escHtml(p.name)+'</div>'+(p.notes?'<div class="stamp-plan-notes">'+escHtml(p.notes)+'</div>':'')+'</div><button style="background:none;border:none;color:var(--danger);font-size:0.8rem;cursor:pointer" onclick="removeStampPlan(\''+pd+'\','+i+')">âœ•</button></div>'})}
html+='<button class="add-nested-btn" onclick="openStampPlanModal(\''+pd+'\')">+ Plan a stamp</button>';
}
c.innerHTML=html}
function renderStampCard(s){
return'<div class="stamp-card" onclick="this.classList.toggle(\'expanded\')"><div class="stamp-card-top">'+(s.photo?'<img class="stamp-card-photo" src="'+s.photo+'" alt="">':'')+'<div class="stamp-card-info"><div class="stamp-card-name">'+escHtml(s.name||s.location||'Stamp')+'</div>'+(s.location?'<div class="stamp-card-location">'+escHtml(s.location)+'</div>':'')+'<div class="stamp-card-date">'+fmtDate(s.date)+(s.time?' Â· '+s.time:'')+'</div>'+(s.stampQuest?'<div class="stamp-card-quest">â­ Stamp Quest'+(s.questId?' #'+escHtml(s.questId):'')+'</div>':'')+'</div></div><div class="stamp-card-detail">'+(s.photo?'<img src="'+s.photo+'" alt="" style="width:100%;border-radius:var(--radius-sm);margin-bottom:8px;max-height:250px;object-fit:cover">':'')+(s.notes?'<div class="stamp-card-notes">'+escHtml(s.notes)+'</div>':'')+'<div class="stamp-card-actions"><button onclick="event.stopPropagation();openStampModal(\''+s.id+'\')">âœï¸ Edit</button><button class="danger" onclick="event.stopPropagation();deleteStamp(\''+s.id+'\')">ðŸ—‘ï¸ Delete</button></div></div></div>'}
function openStampModal(stampId){editingStampId=stampId||null;stampPhoto=null;
let s={};if(stampId){s=appData.stamps.find(x=>x.id===stampId)||{};stampPhoto=s.photo||null}
const trip=getTripById(hubTripId);
const journalEntries=getJournalEntriesForTrip();
document.getElementById('stampModalTitle').textContent=stampId?'Edit Stamp':'Log Stamp';
const body=document.getElementById('stampModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">Location / Name *</label><input class="form-input" type="text" id="stampName" value="'+escAttr(s.name||s.location||'')+'" placeholder="Where did you get this stamp?"></div>'+
'<div class="form-group"><label class="form-label">Location Detail</label><input class="form-input" type="text" id="stampLocation" value="'+escAttr(s.location||'')+'" placeholder="City or area"></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="stampDate" value="'+(s.date||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="stampTime" value="'+(s.time||'')+'"></div></div>'+
'<div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><input type="checkbox" id="stampQuest" '+(s.stampQuest?'checked':'')+' style="width:20px;height:20px;accent-color:var(--accent-primary)"><label for="stampQuest" style="font-size:0.85rem;color:var(--text-secondary);cursor:pointer">Stamp Quest station</label></div>'+
'<div class="form-group" id="stampQuestIdGroup" style="'+(s.stampQuest?'':'display:none')+'"><label class="form-label">Quest ID</label><input class="form-input" type="text" id="stampQuestId" value="'+escAttr(s.questId||'')+'" placeholder="Station ID"></div>'+
'<div class="form-group"><label class="form-label">Photo</label><div class="photo-upload-area" onclick="document.getElementById(\'stampPhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(stampPhoto?'Tap to change':'Tap to add photo')+'</div></div><input type="file" id="stampPhotoInput" accept="image/*" style="display:none" onchange="handleStampPhoto(event)"><div id="stampPhotoPreview">'+(stampPhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+stampPhoto+'" alt=""><button class="photo-preview-remove" onclick="stampPhoto=null;document.getElementById(\'stampPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="stampNotes" rows="3" placeholder="Any details...">'+escHtml(s.notes||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">Link to Journal Entry</label><select class="form-select" id="stampLinkedEntry"><option value="">â€” None â€”</option>'+journalEntries.map(je=>'<option value="'+je.id+'" '+(je.id===(s.linkedJournalEntry||'')?'selected':'')+'>'+escHtml(je.label)+'</option>').join('')+'</select></div>'+
'<button class="form-btn form-btn-primary" onclick="saveStamp()">'+(stampId?'Update':'Save Stamp')+'</button>'+
(stampId?'<button class="form-btn form-btn-danger" onclick="deleteStamp(\''+s.id+'\');closeStampModal()">Delete</button>':'');
document.getElementById('stampQuest').onchange=function(){document.getElementById('stampQuestIdGroup').style.display=this.checked?'':'none'};
document.getElementById('stampModal').classList.add('open')}
function closeStampModal(){document.getElementById('stampModal').classList.remove('open')}
function handleStampPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large');return}const reader=new FileReader();reader.onload=ev=>{stampPhoto=ev.target.result;document.getElementById('stampPhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+stampPhoto+'" alt=""><button class="photo-preview-remove" onclick="stampPhoto=null;document.getElementById(\'stampPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}
function saveStamp(){const name=document.getElementById('stampName').value.trim();if(!name){showToast('Enter a name');return}
const stamp={id:editingStampId||generateId(),name,location:document.getElementById('stampLocation').value.trim(),date:document.getElementById('stampDate').value||toDateStr(new Date()),time:document.getElementById('stampTime').value||'',stampQuest:document.getElementById('stampQuest').checked,questId:document.getElementById('stampQuestId').value.trim(),photo:stampPhoto,notes:document.getElementById('stampNotes').value.trim(),linkedJournalEntry:document.getElementById('stampLinkedEntry').value||null,createdAt:editingStampId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!Array.isArray(appData.stamps))appData.stamps=[];
if(editingStampId){const idx=appData.stamps.findIndex(x=>x.id===editingStampId);if(idx>=0){stamp.createdAt=appData.stamps[idx].createdAt;appData.stamps[idx]=stamp}else{appData.stamps.push(stamp)}}else{appData.stamps.push(stamp)}
saveData();closeStampModal();renderStamps();showToast(editingStampId?'Stamp updated':'Stamp collected!')}
function deleteStamp(id){if(!confirm('Delete this stamp?'))return;appData.stamps=appData.stamps.filter(s=>s.id!==id);saveData();closeStampModal();if(currentPage==='stamps')renderStamps();showToast('Stamp deleted')}
// Stamp Plans
function openStampPlanModal(date){stampPlanDate=date;
document.getElementById('stampPlanModalBody').innerHTML=
'<div class="form-group"><label class="form-label">Stamp to hunt</label><input class="form-input" type="text" id="planStampName" placeholder="Station or location name"></div>'+
'<div class="form-group"><label class="form-label">Notes</label><input class="form-input" type="text" id="planStampNotes" placeholder="Where to find it, hints"></div>'+
'<button class="form-btn form-btn-primary" onclick="addStampPlan()">Add to Plan</button>';
document.getElementById('stampPlanModal').classList.add('open')}
function closeStampPlanModal(){document.getElementById('stampPlanModal').classList.remove('open')}
function addStampPlan(){const name=document.getElementById('planStampName').value.trim();if(!name){showToast('Enter a name');return}if(!appData.stampPlans)appData.stampPlans={};if(!appData.stampPlans[stampPlanDate])appData.stampPlans[stampPlanDate]=[];appData.stampPlans[stampPlanDate].push({name,notes:document.getElementById('planStampNotes').value.trim(),collected:false});saveData();closeStampPlanModal();renderStamps();showToast('Added to plan')}
function toggleStampPlan(date,idx,checked){if(!appData.stampPlans||!appData.stampPlans[date])return;appData.stampPlans[date][idx].collected=checked;saveData();renderStamps()}
function removeStampPlan(date,idx){if(!appData.stampPlans||!appData.stampPlans[date])return;appData.stampPlans[date].splice(idx,1);saveData();renderStamps()}

/* === GOSHUIN === */
let goshuinPhoto=null,editingGoshuinId=null;
function openGoshuinPage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}if(!Array.isArray(appData.goshuin))appData.goshuin=[];renderGoshuin();navigateTo('goshuin')}
function renderGoshuin(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('goshuinContent');
const items=(appData.goshuin||[]).filter(g=>g.date>=trip.startDate&&g.date<=trip.endDate).sort((a,b)=>(b.date).localeCompare(a.date));
let html='<div class="goshuin-header"><h1>â›©ï¸ Goshuin Collection</h1><p>Sacred seals from shrines & temples</p></div>';
html+='<div class="stamps-stats"><div class="ps-card"><div class="ps-card-value">'+items.length+'</div><div class="ps-card-label">Collected</div></div><div class="ps-card"><div class="ps-card-value">Â¥'+items.reduce((sum,g)=>sum+(g.price||0),0)+'</div><div class="ps-card-label">Total</div></div><div class="ps-card"><div class="ps-card-value">'+new Set(items.map(g=>g.location)).size+'</div><div class="ps-card-label">Locations</div></div></div>';
if(!items.length){html+='<div class="goshuin-empty"><div class="goshuin-empty-icon">â›©ï¸</div><p>No goshuin collected yet</p><button class="action-btn action-btn-primary" onclick="openGoshuinModal()" style="display:inline-flex">â›©ï¸ Log First Goshuin</button></div>'}
else{html+='<div class="goshuin-gallery">';items.forEach(g=>{
html+='<div class="goshuin-card" onclick="openGoshuinDetail(\''+g.id+'\')">'+(g.photo?'<img class="goshuin-card-photo" src="'+g.photo+'" alt="">':'<div style="width:100%;aspect-ratio:3/4;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:2.5rem;opacity:0.3">â›©ï¸</div>')+'<div class="goshuin-card-body"><div class="goshuin-card-name">'+escHtml(g.shrineName||'')+'</div><div class="goshuin-card-loc">'+escHtml(g.location||'')+'</div>'+(g.price?'<div class="goshuin-card-price">Â¥'+g.price+'</div>':'')+'</div></div>'});
html+='</div>'}
c.innerHTML=html}
function openGoshuinDetail(id){const g=appData.goshuin.find(x=>x.id===id);if(!g)return;
document.getElementById('goshuinDetailTitle').textContent=g.shrineName||'Goshuin';
const body=document.getElementById('goshuinDetailBody');
body.innerHTML=(g.photo?'<img src="'+g.photo+'" alt="" style="width:100%;border-radius:var(--radius-md);margin-bottom:16px">':'')+
'<div style="text-align:center;margin-bottom:16px"><div style="font-family:var(--font-serif);font-size:1.2rem;font-weight:700">'+escHtml(g.shrineName||'')+'</div><div style="font-size:0.85rem;color:var(--text-secondary)">'+escHtml(g.location||'')+'</div><div style="font-size:0.8rem;color:var(--text-tertiary);margin-top:4px">'+fmtDate(g.date)+(g.price?' Â· Â¥'+g.price:'')+'</div></div>'+
(g.significance?'<div style="padding:14px;background:var(--bg-secondary);border-radius:var(--radius-sm);margin-bottom:16px;font-size:0.85rem;color:var(--text-secondary);line-height:1.6;border-left:3px solid var(--accent-primary)">'+escHtml(g.significance)+'</div>':'')+
'<div style="display:flex;gap:8px"><button class="form-btn" style="flex:1;background:var(--bg-secondary);color:var(--text-primary)" onclick="closeGoshuinDetailModal();openGoshuinModal(\''+g.id+'\')">âœï¸ Edit</button><button class="form-btn form-btn-danger" style="flex:1" onclick="deleteGoshuin(\''+g.id+'\');closeGoshuinDetailModal()">ðŸ—‘ï¸ Delete</button></div>';
document.getElementById('goshuinDetailModal').classList.add('open')}
function closeGoshuinDetailModal(){document.getElementById('goshuinDetailModal').classList.remove('open')}
function openGoshuinModal(goshuinId){editingGoshuinId=goshuinId||null;goshuinPhoto=null;
let g={};if(goshuinId){g=appData.goshuin.find(x=>x.id===goshuinId)||{};goshuinPhoto=g.photo||null}
const journalEntries=getJournalEntriesForTrip();
document.getElementById('goshuinModalTitle').textContent=goshuinId?'Edit Goshuin':'Log Goshuin';
const body=document.getElementById('goshuinModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">Shrine / Temple Name *</label><input class="form-input" type="text" id="goshuinShrine" value="'+escAttr(g.shrineName||'')+'" placeholder="e.g., Fushimi Inari Taisha"></div>'+
'<div class="form-group"><label class="form-label">Location</label><input class="form-input" type="text" id="goshuinLocation" value="'+escAttr(g.location||'')+'" placeholder="City or area"></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="goshuinDate" value="'+(g.date||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Price (Â¥)</label><input class="form-input" type="number" id="goshuinPrice" value="'+(g.price||300)+'" placeholder="300-500"></div></div>'+
'<div class="form-group"><label class="form-label">Photo *</label><div class="photo-upload-area" onclick="document.getElementById(\'goshuinPhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(goshuinPhoto?'Tap to change':'Tap to photograph goshuin')+'</div></div><input type="file" id="goshuinPhotoInput" accept="image/*" style="display:none" onchange="handleGoshuinPhoto(event)"><div id="goshuinPhotoPreview">'+(goshuinPhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+goshuinPhoto+'" alt=""><button class="photo-preview-remove" onclick="goshuinPhoto=null;document.getElementById(\'goshuinPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Significance / Notes</label><textarea class="form-textarea" id="goshuinSignificance" rows="3" placeholder="What makes this one special?">'+escHtml(g.significance||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">Link to Journal Entry</label><select class="form-select" id="goshuinLinkedEntry"><option value="">â€” None â€”</option>'+journalEntries.map(je=>'<option value="'+je.id+'" '+(je.id===(g.linkedJournalEntry||'')?'selected':'')+'>'+escHtml(je.label)+'</option>').join('')+'</select></div>'+
'<button class="form-btn form-btn-primary" onclick="saveGoshuin()">'+(goshuinId?'Update':'Save Goshuin')+'</button>'+
(goshuinId?'<button class="form-btn form-btn-danger" onclick="deleteGoshuin(\''+g.id+'\');closeGoshuinModal()">Delete</button>':'');
document.getElementById('goshuinModal').classList.add('open')}
function closeGoshuinModal(){document.getElementById('goshuinModal').classList.remove('open')}
function handleGoshuinPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large');return}const reader=new FileReader();reader.onload=ev=>{goshuinPhoto=ev.target.result;document.getElementById('goshuinPhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+goshuinPhoto+'" alt=""><button class="photo-preview-remove" onclick="goshuinPhoto=null;document.getElementById(\'goshuinPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}
function saveGoshuin(){const shrine=document.getElementById('goshuinShrine').value.trim();if(!shrine){showToast('Enter shrine/temple name');return}
const g={id:editingGoshuinId||generateId(),shrineName:shrine,location:document.getElementById('goshuinLocation').value.trim(),date:document.getElementById('goshuinDate').value||toDateStr(new Date()),price:parseInt(document.getElementById('goshuinPrice').value)||0,photo:goshuinPhoto,significance:document.getElementById('goshuinSignificance').value.trim(),linkedJournalEntry:document.getElementById('goshuinLinkedEntry').value||null,createdAt:editingGoshuinId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!Array.isArray(appData.goshuin))appData.goshuin=[];
if(editingGoshuinId){const idx=appData.goshuin.findIndex(x=>x.id===editingGoshuinId);if(idx>=0){g.createdAt=appData.goshuin[idx].createdAt;appData.goshuin[idx]=g}else{appData.goshuin.push(g)}}else{appData.goshuin.push(g)}
saveData();closeGoshuinModal();renderGoshuin();showToast(editingGoshuinId?'Goshuin updated':'Goshuin saved!')}
function deleteGoshuin(id){if(!confirm('Delete this goshuin?'))return;appData.goshuin=appData.goshuin.filter(g=>g.id!==id);saveData();closeGoshuinModal();closeGoshuinDetailModal();if(currentPage==='goshuin')renderGoshuin();showToast('Goshuin deleted')}

/* === TRANSPORT LOG === */
let transportPhoto=null,editingTransportId=null;
const TRAIN_TYPES=['Shinkansen','JR Local','JR Rapid','Private Railway','Metro/Subway','Tram','Bus','Ferry','Other'];
function openTransportPage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}if(!Array.isArray(appData.transport))appData.transport=[];renderTransport();navigateTo('transport')}
function renderTransport(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('transportContent');
const items=(appData.transport||[]).filter(t=>t.date>=trip.startDate&&t.date<=trip.endDate).sort((a,b)=>(b.date+(b.time||'')).localeCompare(a.date+(a.time||'')));
let html='<div class="transport-header"><h1>ðŸš† Transport Log</h1><p>Memorable journeys along the way</p></div>';
html+='<div class="stamps-stats"><div class="ps-card"><div class="ps-card-value">'+items.length+'</div><div class="ps-card-label">Journeys</div></div><div class="ps-card"><div class="ps-card-value">'+items.filter(t=>t.trainType==='Shinkansen').length+'</div><div class="ps-card-label">Shinkansen</div></div><div class="ps-card"><div class="ps-card-value">'+new Set(items.map(t=>t.date)).size+'</div><div class="ps-card-label">Travel Days</div></div></div>';
if(!items.length){html+='<div class="transport-empty"><div class="transport-empty-icon">ðŸš†</div><p>No journeys logged yet</p><button class="action-btn action-btn-primary" onclick="openTransportModal()" style="display:inline-flex">ðŸš† Log First Journey</button></div>'}
else{items.forEach(t=>{html+=renderTransportCard(t)})}
c.innerHTML=html}
function renderTransportCard(t){
const parts=(t.route||'').split(/\s*(?:to|â†’|->|â€”)\s*/i);const from=parts[0]||t.route||'';const to=parts[1]||'';
return'<div class="transport-card" onclick="this.classList.toggle(\'expanded\')"><div class="transport-card-route">'+(to?escHtml(from)+' <span class="route-arrow">â†’</span> '+escHtml(to):escHtml(t.route||'Journey'))+'</div>'+(t.trainType?'<div class="transport-card-type">ðŸš„ '+escHtml(t.trainType)+(t.trainNumber?' Â· '+escHtml(t.trainNumber):'')+'</div>':'')+'<div class="transport-card-meta">'+fmtDate(t.date)+(t.time?' Â· '+t.time:'')+(t.duration?' Â· '+escHtml(t.duration):'')+'</div><div class="transport-card-detail">'+(t.photo?'<img src="'+t.photo+'" alt="" style="width:100%;border-radius:var(--radius-sm);margin-bottom:8px;max-height:200px;object-fit:cover">':'')+(t.observations?'<div class="transport-card-obs">'+escHtml(t.observations)+'</div>':'')+'<div class="transport-card-actions"><button onclick="event.stopPropagation();openTransportModal(\''+t.id+'\')">âœï¸ Edit</button><button class="danger" onclick="event.stopPropagation();deleteTransport(\''+t.id+'\')">ðŸ—‘ï¸ Delete</button></div></div></div>'}
function openTransportModal(transportId){editingTransportId=transportId||null;transportPhoto=null;
let t={};if(transportId){t=appData.transport.find(x=>x.id===transportId)||{};transportPhoto=t.photo||null}
const journalEntries=getJournalEntriesForTrip();
document.getElementById('transportModalTitle').textContent=transportId?'Edit Journey':'Log Journey';
const body=document.getElementById('transportModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label">Route *</label><input class="form-input" type="text" id="transportRoute" value="'+escAttr(t.route||'')+'" placeholder="e.g., Kyoto to Tokyo"></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Train Type</label><select class="form-select" id="transportType"><option value="">â€” Select â€”</option>'+TRAIN_TYPES.map(tt=>'<option value="'+tt+'" '+(t.trainType===tt?'selected':'')+'>'+tt+'</option>').join('')+'</select></div><div class="form-group"><label class="form-label">Train Name/Number</label><input class="form-input" type="text" id="transportNumber" value="'+escAttr(t.trainNumber||'')+'" placeholder="e.g., Nozomi 123"></div></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="transportDate" value="'+(t.date||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="transportTime" value="'+(t.time||'')+'"></div></div>'+
'<div class="form-group"><label class="form-label">Duration</label><input class="form-input" type="text" id="transportDuration" value="'+escAttr(t.duration||'')+'" placeholder="e.g., 2h 15m"></div>'+
'<div class="form-group"><label class="form-label">Observations</label><textarea class="form-textarea" id="transportObs" rows="3" placeholder="What made this journey memorable?">'+escHtml(t.observations||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">Photo</label><div class="photo-upload-area" onclick="document.getElementById(\'transportPhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(transportPhoto?'Tap to change':'Tap to add photo')+'</div></div><input type="file" id="transportPhotoInput" accept="image/*" style="display:none" onchange="handleTransportPhoto(event)"><div id="transportPhotoPreview">'+(transportPhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+transportPhoto+'" alt=""><button class="photo-preview-remove" onclick="transportPhoto=null;document.getElementById(\'transportPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Link to Journal Entry</label><select class="form-select" id="transportLinkedEntry"><option value="">â€” None â€”</option>'+journalEntries.map(je=>'<option value="'+je.id+'" '+(je.id===(t.linkedJournalEntry||'')?'selected':'')+'>'+escHtml(je.label)+'</option>').join('')+'</select></div>'+
'<button class="form-btn form-btn-primary" onclick="saveTransport()">'+(transportId?'Update':'Save Journey')+'</button>'+
(transportId?'<button class="form-btn form-btn-danger" onclick="deleteTransport(\''+t.id+'\');closeTransportModal()">Delete</button>':'');
document.getElementById('transportModal').classList.add('open')}
function closeTransportModal(){document.getElementById('transportModal').classList.remove('open')}
function handleTransportPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large');return}const reader=new FileReader();reader.onload=ev=>{transportPhoto=ev.target.result;document.getElementById('transportPhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+transportPhoto+'" alt=""><button class="photo-preview-remove" onclick="transportPhoto=null;document.getElementById(\'transportPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}
function saveTransport(){const route=document.getElementById('transportRoute').value.trim();if(!route){showToast('Enter a route');return}
const t={id:editingTransportId||generateId(),route,trainType:document.getElementById('transportType').value,trainNumber:document.getElementById('transportNumber').value.trim(),date:document.getElementById('transportDate').value||toDateStr(new Date()),time:document.getElementById('transportTime').value||'',duration:document.getElementById('transportDuration').value.trim(),observations:document.getElementById('transportObs').value.trim(),photo:transportPhoto,linkedJournalEntry:document.getElementById('transportLinkedEntry').value||null,createdAt:editingTransportId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!Array.isArray(appData.transport))appData.transport=[];
if(editingTransportId){const idx=appData.transport.findIndex(x=>x.id===editingTransportId);if(idx>=0){t.createdAt=appData.transport[idx].createdAt;appData.transport[idx]=t}else{appData.transport.push(t)}}else{appData.transport.push(t)}
saveData();closeTransportModal();renderTransport();showToast(editingTransportId?'Journey updated':'Journey logged!')}
function deleteTransport(id){if(!confirm('Delete this journey?'))return;appData.transport=appData.transport.filter(t=>t.id!==id);saveData();closeTransportModal();if(currentPage==='transport')renderTransport();showToast('Journey deleted')}

/* === SHARE GRAPHICS === */
const SHARE_FRAMES=[
{id:'polaroid-black',name:'Polaroid Dark',group:'classic'},
{id:'polaroid-white',name:'Polaroid Light',group:'classic'},
{id:'minimalist',name:'Minimal',group:'classic'},
{id:'minimalist-white',name:'Min. White',group:'classic'},
{id:'grunge',name:'Grunge',group:'artistic'},
{id:'kawaii',name:'Kawaii',group:'playful'},
{id:'cyberpunk',name:'Cyberpunk',group:'modern'},
{id:'vintage',name:'Vintage',group:'artistic'},
{id:'washi',name:'Washi Tape',group:'playful'},
{id:'shadow',name:'Shadow Box',group:'classic'},
{id:'film-strip',name:'Film Strip',group:'artistic'},
{id:'postcard',name:'Postcard',group:'classic'},
{id:'neon',name:'Neon',group:'modern'},
{id:'scrapbook',name:'Scrapbook',group:'playful'}
];
const SHARE_LAYOUTS=[
{id:'photo-card',name:'Photo Card',icon:'\U0001f5bc\ufe0f',desc:'Single photo with caption'},
{id:'stats-grid',name:'Stats Grid',icon:'\U0001f4ca',desc:'Trip stats layout'},
{id:'collage',name:'Collage',icon:'\U0001f39e\ufe0f',desc:'Multi-photo grid'},
{id:'text-poster',name:'Text Poster',icon:'\U0001f4dd',desc:'Typography focused'},
{id:'wrapped',name:'Wrapped',icon:'\U0001f381',desc:'Spotify Wrapped style'}
];

let shareType='entry',shareData={},shareEntryId=null,shareEntryDate=null,shareSelectedPhoto=null,shareSelectedFrame='polaroid-black',shareSelectedLayout='photo-card',shareStickers=[],shareSelectedStickerId=null,shareDragSticker=null,shareDragOffset={x:0,y:0};
let shareCustomText={title:'',subtitle:'',titleColor:'#ffffff',subtitleColor:'#cccccc'};
let shareStickerTab='places';
let shareAllPhotos=[];

function openShareFromEntry(entryId){
const entries=appData.journal[journalDate]||[];
const entry=entries.find(e=>e.id===entryId);
if(!entry){showToast('Entry not found');return}
shareType='entry';shareEntryId=entryId;shareEntryDate=journalDate;
shareSelectedPhoto=null;shareStickers=[];shareSelectedStickerId=null;
shareSelectedFrame=appData.settings.defaultShareFrame||'polaroid-black';
shareSelectedLayout='photo-card';
shareCustomText={title:entry.name||'',subtitle:'',titleColor:'#ffffff',subtitleColor:'#cccccc'};
const photos=entry.photos||[];
if(!photos.length){showToast('No photos in this entry to share');return}
shareSelectedPhoto=photos[0];shareAllPhotos=photos;
shareData={entry,date:journalDate};
document.getElementById('shareModalTitle').textContent='Share';
const body=document.getElementById('shareModalBody');
body.innerHTML=`<div class="share-prompt"><div class="share-prompt-title">Share "${escHtml(entry.name)}"</div><div class="share-prompt-sub">${photos.length} photo${photos.length>1?'s':''} available</div><div class="share-prompt-btns"><button class="share-btn-edit" onclick="openShareEditor()">\u270f\ufe0f Edit</button><button class="share-btn-quick" onclick="shareQuickNow()">\U0001f4e4 Share Now</button></div></div>`;
document.getElementById('shareModal').classList.add('open')}

function openShareFromDay(){
const trip=getTripById(hubTripId);if(!trip)return;
shareType='daily';shareEntryDate=journalDate;shareEntryId=null;
const entries=getEntriesForDate(journalDate);
let allPhotos=[];
entries.forEach(e=>{if(e.photos)allPhotos=allPhotos.concat(e.photos);if(e.meals)e.meals.forEach(m=>{if(m.photo)allPhotos.push(m.photo)})});
shareAllPhotos=allPhotos;
shareSelectedPhoto=allPhotos.length?allPhotos[0]:null;
shareStickers=[];shareSelectedStickerId=null;
shareSelectedFrame=appData.settings.defaultShareFrame||'polaroid-black';
shareSelectedLayout=allPhotos.length?'photo-card':'wrapped';
const d=new Date(journalDate+'T00:00:00');
const dayNum=Math.ceil((d-new Date(trip.startDate+'T00:00:00'))/864e5)+1;
shareCustomText={title:'Day '+dayNum,subtitle:d.toLocaleDateString('en-AU',{weekday:'long',month:'long',day:'numeric'}),titleColor:'#ffffff',subtitleColor:'#cccccc'};
shareData={entries,date:journalDate,trip,dayNum};
openShareEditor()}

function openShareFromTrip(){
const trip=getTripById(hubTripId);if(!trip)return;
shareType='trip';shareEntryDate=null;shareEntryId=null;
const stats=computeTripStats(trip);
let allPhotos=[];
const j=appData.journal||{};
Object.keys(j).forEach(ds=>{if(ds>=trip.startDate&&ds<=trip.endDate){const de=j[ds];if(Array.isArray(de))de.forEach(e=>{if(e.photos)allPhotos=allPhotos.concat(e.photos)})}});
shareAllPhotos=allPhotos;
shareSelectedPhoto=allPhotos.length?allPhotos[Math.floor(Math.random()*allPhotos.length)]:null;
shareStickers=[];shareSelectedStickerId=null;
shareSelectedFrame='polaroid-black';
shareSelectedLayout=allPhotos.length?'photo-card':'wrapped';
shareCustomText={title:trip.name||'My Japan Trip',subtitle:trip.destination||'',titleColor:'#ffffff',subtitleColor:'#cccccc'};
shareData={trip,stats,allPhotos};
openShareEditor()}

function closeShareModal(){document.getElementById('shareModal').classList.remove('open');shareStickers=[];shareSelectedStickerId=null}

function getShareEntry(){if(shareType!=='entry')return null;const entries=appData.journal[shareEntryDate]||[];return entries.find(e=>e.id===shareEntryId)||null}
function getShareDayNum(){const trip=getTripById(hubTripId);if(!trip||!shareEntryDate)return'';const start=new Date(trip.startDate+'T00:00:00');const d=new Date(shareEntryDate+'T00:00:00');return'Day '+String(Math.ceil((d-start)/864e5)+1)}

function openShareEditor(){
shareStickers=[];shareSelectedStickerId=null;
const body=document.getElementById('shareModalBody');
document.getElementById('shareModalTitle').textContent='Edit Share';
let html='<div class="share-canvas-wrap" id="shareCanvasWrap"><canvas id="shareCanvas" width="1080" height="1350"></canvas></div>';
if(shareAllPhotos.length>1){
html+='<div class="share-photos"><div class="share-photos-label">Photo</div><div class="share-photos-scroll">';
html+=shareAllPhotos.slice(0,20).map((p,i)=>`<div class="share-photo-thumb ${p===shareSelectedPhoto?'selected':''}" onclick="selectSharePhoto(${i})"><img src="${p}" alt=""></div>`).join('');
html+='<div class="share-photo-upload-btn" onclick="uploadSharePhoto()">+</div>';
html+='</div></div>'}
else if(!shareAllPhotos.length){html+='<div class="share-photo-upload" style="margin-bottom:12px"><div class="share-photo-upload-btn" onclick="uploadSharePhoto()">\U0001f4f7</div><span style="font-size:0.8rem;color:var(--text-tertiary)">Add a photo</span></div>'}
html+='<div class="share-layouts"><div class="share-layouts-label">Layout</div><div class="share-layouts-scroll">'+SHARE_LAYOUTS.map(l=>`<div class="share-layout-opt ${l.id===shareSelectedLayout?'selected':''}" onclick="selectShareLayout('${l.id}')"><div class="share-layout-opt-icon">${l.icon}</div>${l.name}</div>`).join('')+'</div></div>';
html+='<div class="share-frames"><div class="share-frames-label">Frame Style</div><div class="share-frames-scroll">'+SHARE_FRAMES.map(f=>`<div class="share-frame-opt ${f.id===shareSelectedFrame?'selected':''}" onclick="selectShareFrame('${f.id}')"><div class="share-frame-opt-preview" style="background:${f.id.includes('white')?'#fff':f.id==='polaroid-black'||f.id==='cyberpunk'||f.id==='neon'?'#111':f.id==='grunge'?'#a89080':f.id==='kawaii'?'#ffe0f0':f.id==='vintage'?'#d8c8a0':f.id==='washi'||f.id==='scrapbook'?'#f8f0e0':f.id==='film-strip'?'#1a1a1a':f.id==='postcard'?'#faf0e8':'#eee'}"></div>${f.name}</div>`).join('')+'</div></div>';
html+=`<div class="share-text-section"><label>Text Customization</label><div class="share-text-row"><input class="share-text-input" id="shareTitle" value="${escHtml(shareCustomText.title)}" placeholder="Title" oninput="shareCustomText.title=this.value;renderShareCanvas()"><input type="color" class="share-color-btn" id="shareTitleColor" value="${shareCustomText.titleColor}" oninput="shareCustomText.titleColor=this.value;renderShareCanvas()"></div><div class="share-text-row"><input class="share-text-input" id="shareSubtitle" value="${escHtml(shareCustomText.subtitle)}" placeholder="Subtitle" oninput="shareCustomText.subtitle=this.value;renderShareCanvas()"><input type="color" class="share-color-btn" id="shareSubColor" value="${shareCustomText.subtitleColor}" oninput="shareCustomText.subtitleColor=this.value;renderShareCanvas()"></div></div>`;
html+='<div class="share-stickers"><div class="share-stickers-label">Stickers</div>';
html+='<div class="share-sticker-tabs">'+Object.keys(STICKERS).filter(k=>k!=='custom'||STICKERS.custom.length).map(k=>`<div class="share-sticker-tab ${k===shareStickerTab?'active':''}" onclick="shareStickerTab=\'${k}\';renderShareStickerPicker()">${STICKER_TAB_LABELS[k]||k}</div>`).join('')+'</div>';
html+='<div class="share-sticker-row" id="shareStickerGrid"></div></div>';
html+=`<div class="share-action-bar"><button onclick="saveShareToGallery()"><span class="sa-icon">\U0001f4be</span>Save</button><button onclick="shareToInstagram()"><span class="sa-icon">\U0001f4f8</span>Instagram</button><button class="sa-primary" onclick="shareNative()"><span class="sa-icon">\U0001f4e4</span>Share</button></div>`;
body.innerHTML=html;
renderShareStickerPicker();
setTimeout(()=>{renderShareCanvas();setupCanvasStickerDrag()},100)}

function renderShareStickerPicker(){
const grid=document.getElementById('shareStickerGrid');if(!grid)return;
const stickers=STICKERS[shareStickerTab]||[];
grid.innerHTML=stickers.map(s=>`<button class="share-sticker-btn" onclick="addShareSticker('${s.emoji}')">${s.emoji}</button>`).join('');
document.querySelectorAll('.share-sticker-tab').forEach(el=>{const tab=el.getAttribute('onclick').match(/'([^']+)'/);el.classList.toggle('active',tab&&tab[1]===shareStickerTab)})}

function uploadSharePhoto(){
const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.capture='environment';
inp.onchange=function(){if(!this.files||!this.files[0])return;const reader=new FileReader();reader.onload=function(ev){
shareAllPhotos.unshift(ev.target.result);shareSelectedPhoto=ev.target.result;openShareEditor()};reader.readAsDataURL(this.files[0])};inp.click()}

function selectSharePhoto(idx){
shareSelectedPhoto=shareAllPhotos[idx];
document.querySelectorAll('.share-photo-thumb').forEach((el,i)=>el.classList.toggle('selected',i===idx));
renderShareCanvas()}

function selectShareFrame(frameId){
shareSelectedFrame=frameId;
document.querySelectorAll('.share-frame-opt').forEach(el=>el.classList.toggle('selected',el.getAttribute('onclick').includes("'"+frameId+"'")));
renderShareCanvas()}

function selectShareLayout(layoutId){
shareSelectedLayout=layoutId;
document.querySelectorAll('.share-layout-opt').forEach(el=>el.classList.toggle('selected',el.getAttribute('onclick').includes("'"+layoutId+"'")));
renderShareCanvas()}

function addShareSticker(emoji){
shareStickers.push({id:generateId(),emoji,x:Math.random()*0.5+0.25,y:Math.random()*0.3+0.3});
renderShareCanvas()}

function removeShareSticker(id){
shareStickers=shareStickers.filter(s=>s.id!==id);
if(shareSelectedStickerId===id)shareSelectedStickerId=null;
renderShareCanvas()}

function renderShareCanvas(){
const canvas=document.getElementById('shareCanvas');if(!canvas)return;
const ctx=canvas.getContext('2d');
const W=1080,H=1350;
canvas.width=W;canvas.height=H;
ctx.clearRect(0,0,W,H);
if(shareSelectedLayout==='wrapped'||shareSelectedLayout==='stats-grid'){
drawWrappedCard(ctx,W,H);drawStickersOnCanvas(ctx,W,H);return}
if(shareSelectedLayout==='text-poster'){
drawTextPoster(ctx,W,H);drawStickersOnCanvas(ctx,W,H);return}
if(shareSelectedLayout==='collage'&&shareAllPhotos.length>1){
drawCollageCard(ctx,W,H);return}
if(!shareSelectedPhoto){
drawWrappedCard(ctx,W,H);drawStickersOnCanvas(ctx,W,H);return}
const img=new Image();
img.onload=function(){
const frame=shareSelectedFrame;
const title=shareCustomText.title;
const subtitle=shareCustomText.subtitle;
const dayNum=getShareDayNum();
const dateStr=shareEntryDate?new Date(shareEntryDate+'T00:00:00').toLocaleDateString('en-AU',{month:'long',day:'numeric',year:'numeric'}):'';
const caption=title||(shareType==='entry'?(getShareEntry()||{}).name||'':'');
const dateLine=subtitle||dateStr;
drawFrame(ctx,img,W,H,frame,caption,dayNum,dateLine);
drawStickersOnCanvas(ctx,W,H)};
img.src=shareSelectedPhoto}

function drawWrappedCard(ctx,W,H){
const trip=shareData.trip||getTripById(hubTripId);
const stats=shareData.stats||computeTripStats(trip||{startDate:'',endDate:''});
const grd=ctx.createLinearGradient(0,0,W,H);
grd.addColorStop(0,'#1a0a2e');grd.addColorStop(0.3,'#2d1458');grd.addColorStop(0.6,'#4a1942');grd.addColorStop(1,'#0f0c29');
ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
ctx.globalAlpha=0.08;
for(let i=0;i<6;i++){ctx.beginPath();ctx.arc(Math.random()*W,Math.random()*H,100+Math.random()*200,0,Math.PI*2);ctx.fillStyle=i%2?'#ff6b9d':'#c44dff';ctx.fill()}
ctx.globalAlpha=1;
const pad=80;let y=120;
ctx.fillStyle='#ff6b9d';ctx.font='300 28px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText('YOUR JOURNEY',W/2,y);y+=60;
ctx.fillStyle='#fff';ctx.font='700 56px "Noto Serif JP",serif';
const tripName=shareCustomText.title||(trip?trip.name:'My Trip');
ctx.fillText(tripName,W/2,y,W-pad*2);y+=50;
if(shareCustomText.subtitle||(trip&&trip.destination)){
ctx.fillStyle='#c8a8ff';ctx.font='400 30px "Noto Sans JP",sans-serif';
ctx.fillText(shareCustomText.subtitle||(trip?trip.destination:''),W/2,y,W-pad*2)}
y+=80;
const statItems=[];
if(stats.entries)statItems.push({val:stats.entries,label:'Entries'});
if(stats.photos)statItems.push({val:stats.photos,label:'Photos'});
if(stats.meals)statItems.push({val:stats.meals,label:'Meals'});
if(stats.stampCount)statItems.push({val:stats.stampCount,label:'Stamps'});
if(stats.goshuinCount)statItems.push({val:stats.goshuinCount,label:'Goshuin'});
if(stats.transportCount)statItems.push({val:stats.transportCount,label:'Journeys'});
if(stats.gifts)statItems.push({val:stats.gifts,label:'Gifts'});
if(stats.peopleCount)statItems.push({val:stats.peopleCount,label:'People Met'});
if(!statItems.length){statItems.push({val:'\u2014',label:'No data yet'})}
const cols=2,cellW=(W-pad*2)/cols;
statItems.slice(0,8).forEach((s,i)=>{
const col=i%cols,row=Math.floor(i/cols);
const cx=pad+col*cellW+cellW/2;const cy=y+row*140;
ctx.fillStyle='#fff';ctx.font='700 64px "Noto Sans JP",sans-serif';
ctx.fillText(String(s.val),cx,cy);
ctx.fillStyle='#c8a8ff';ctx.font='400 24px "Noto Sans JP",sans-serif';
ctx.fillText(s.label,cx,cy+36)});
y+=Math.ceil(statItems.length/cols)*140+40;
if(trip){
ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='300 24px "Noto Sans JP",sans-serif';
ctx.fillText(fmtDate(trip.startDate)+' \u2014 '+fmtDate(trip.endDate),W/2,H-80)}
ctx.fillStyle='rgba(255,255,255,0.15)';ctx.font='700 24px "Noto Serif JP",serif';
ctx.fillText('\u65C5 Tabi',W/2,H-40)}

function drawTextPoster(ctx,W,H){
const grd=ctx.createLinearGradient(0,0,0,H);
grd.addColorStop(0,'#0f0f0f');grd.addColorStop(1,'#1a1a2e');
ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
const pad=80;let y=H/2-80;
ctx.textAlign='center';
ctx.fillStyle=shareCustomText.titleColor||'#fff';
ctx.font='700 72px "Noto Serif JP",serif';
wrapText(ctx,shareCustomText.title||'Untitled',W/2,y,W-pad*2,84);
y+=100;
ctx.fillStyle=shareCustomText.subtitleColor||'#aaa';
ctx.font='300 36px "Noto Sans JP",sans-serif';
wrapText(ctx,shareCustomText.subtitle||'',W/2,y,W-pad*2,44);
ctx.fillStyle='rgba(255,255,255,0.1)';ctx.font='700 24px "Noto Serif JP",serif';
ctx.fillText('\u65C5 Tabi',W/2,H-50);
drawStickersOnCanvas(ctx,W,H)}

function drawCollageCard(ctx,W,H){
ctx.fillStyle='#111';ctx.fillRect(0,0,W,H);
const photos=shareAllPhotos.slice(0,4);const gap=8;
const positions=photos.length<=2?[
[0,0,W/2-gap/2,H-120],[W/2+gap/2,0,W/2-gap/2,H-120]
]:photos.length===3?[
[0,0,W/2-gap/2,(H-120)/2-gap/2],[W/2+gap/2,0,W/2-gap/2,(H-120)/2-gap/2],
[0,(H-120)/2+gap/2,W,((H-120)/2-gap/2)]
]:[
[0,0,W/2-gap/2,(H-120)/2-gap/2],[W/2+gap/2,0,W/2-gap/2,(H-120)/2-gap/2],
[0,(H-120)/2+gap/2,W/2-gap/2,(H-120)/2-gap/2],[W/2+gap/2,(H-120)/2+gap/2,W/2-gap/2,(H-120)/2-gap/2]
];
let loaded=0;
photos.forEach((p,i)=>{if(!positions[i])return;
const img=new Image();img.onload=function(){
const[x,y,w,h]=positions[i];
drawImageCover(ctx,img,x,y,w,h);
loaded++;
if(loaded===Math.min(photos.length,positions.length)){
ctx.fillStyle=shareCustomText.titleColor||'#fff';ctx.font='600 36px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(shareCustomText.title||'',W/2,H-70,W-160);
ctx.fillStyle=shareCustomText.subtitleColor||'#aaa';ctx.font='300 28px "Noto Sans JP",sans-serif';
ctx.fillText(shareCustomText.subtitle||'',W/2,H-30,W-160);
drawStickersOnCanvas(ctx,W,H)}};img.src=p})}

function wrapText(ctx,text,x,y,maxW,lineH){
if(!text)return y;
const words=text.split(' ');let line='';
words.forEach(w=>{const test=line+w+' ';
if(ctx.measureText(test).width>maxW&&line){ctx.fillText(line.trim(),x,y);y+=lineH;line=w+' '}
else{line=test}});
if(line)ctx.fillText(line.trim(),x,y);
return y}

function drawFrame(ctx,img,W,H,frame,locName,dayNum,dateStr){
const caption=shareCustomText.title||locName||(dayNum?locName+' \u00b7 '+dayNum:'');
const dateLine=shareCustomText.subtitle||dateStr||'';
const titleClr=shareCustomText.titleColor;
const subClr=shareCustomText.subtitleColor;
switch(frame){
case 'polaroid-black':{
ctx.fillStyle='#111';ctx.fillRect(0,0,W,H);
const pad=60,botPad=200;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad-botPad);
ctx.fillStyle=titleClr||'#fff';ctx.font='600 36px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-botPad+70,W-pad*4);
ctx.font='300 28px "Noto Sans JP",sans-serif';ctx.fillStyle=subClr||'#aaa';
ctx.fillText(dateLine,W/2,H-botPad+115,W-pad*4);
break}
case 'polaroid-white':{
ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);
const pad=60,botPad=200;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad-botPad);
ctx.fillStyle='#333';ctx.font='600 36px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-botPad+70,W-pad*4);
ctx.font='300 28px "Noto Sans JP",sans-serif';ctx.fillStyle='#999';
ctx.fillText(dateLine,W/2,H-botPad+115,W-pad*4);
break}
case 'minimalist':{
ctx.fillStyle='#fafafa';ctx.fillRect(0,0,W,H);
const pad=40;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-100);
ctx.strokeStyle='#222';ctx.lineWidth=3;ctx.strokeRect(pad,pad,W-pad*2,H-pad*2-100);
ctx.fillStyle='#222';ctx.font='500 32px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-40,W-120);
break}
case 'minimalist-white':{
ctx.clearRect(0,0,W,H);
const pad=40;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-100);
ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.strokeRect(pad-2,pad-2,W-pad*2+4,H-pad*2-100+4);
ctx.fillStyle='#fff';ctx.font='500 32px "Noto Sans JP",sans-serif';ctx.textAlign='center';ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=8;
ctx.fillText(caption,W/2,H-40,W-120);ctx.shadowBlur=0;
break}
case 'grunge':{
ctx.fillStyle='#2a2420';ctx.fillRect(0,0,W,H);
for(let i=0;i<2000;i++){ctx.fillStyle=`rgba(${180+Math.random()*40},${160+Math.random()*40},${140+Math.random()*40},${Math.random()*0.08})`;ctx.fillRect(Math.random()*W,Math.random()*H,Math.random()*3+1,Math.random()*3+1)}
const pad=80;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-120);
for(let i=0;i<500;i++){ctx.fillStyle=`rgba(40,30,20,${Math.random()*0.15})`;ctx.fillRect(pad+Math.random()*(W-pad*2),pad+Math.random()*(H-pad*2-120),Math.random()*8,Math.random()*8)}
ctx.fillStyle=titleClr||'#e8d0b0';ctx.font='600 34px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-80,W-200);
ctx.font='300 26px "Noto Sans JP",sans-serif';ctx.fillStyle=subClr||'#b0a090';
ctx.fillText(dateLine,W/2,H-40,W-200);
break}
case 'kawaii':{
ctx.fillStyle='#fff0f8';ctx.fillRect(0,0,W,H);
const pad=70;
ctx.fillStyle='#ffcce8';
roundRect(ctx,pad-10,pad-10,W-pad*2+20,H-pad*2-140,30);ctx.fill();
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-160);
roundRect(ctx,pad,pad,W-pad*2,H-pad*2-160,20);ctx.save();ctx.clip();drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-160);ctx.restore();
const hearts=['\u2661','\u2727','\u2661','\u22c6','\u2661','\u2727'];hearts.forEach((h,i)=>{ctx.font=(20+Math.random()*16)+'px sans-serif';ctx.fillStyle=`rgba(255,${150+Math.random()*50},${180+Math.random()*50},0.7)`;ctx.fillText(h,60+i*(W-120)/hearts.length+Math.random()*30,30+Math.random()*20)});
ctx.fillStyle='#d060a0';ctx.font='600 34px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-100,W-200);
ctx.font='400 26px "Noto Sans JP",sans-serif';ctx.fillStyle='#e090c0';
ctx.fillText(dateLine,W/2,H-60,W-200);
break}
case 'cyberpunk':{
ctx.fillStyle='#0a0a12';ctx.fillRect(0,0,W,H);
for(let i=0;i<W;i+=60){ctx.strokeStyle='rgba(0,255,200,0.06)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,H);ctx.stroke()}
for(let i=0;i<H;i+=60){ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(W,i);ctx.stroke()}
const pad=50;drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-120);
ctx.strokeStyle='#00ffc8';ctx.lineWidth=3;ctx.shadowColor='#00ffc8';ctx.shadowBlur=15;
const cs=40;
ctx.beginPath();ctx.moveTo(pad,pad+cs);ctx.lineTo(pad,pad);ctx.lineTo(pad+cs,pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(W-pad-cs,pad);ctx.lineTo(W-pad,pad);ctx.lineTo(W-pad,pad+cs);ctx.stroke();
const by=H-pad-120;
ctx.beginPath();ctx.moveTo(pad,by-cs);ctx.lineTo(pad,by);ctx.lineTo(pad+cs,by);ctx.stroke();
ctx.beginPath();ctx.moveTo(W-pad-cs,by);ctx.lineTo(W-pad,by);ctx.lineTo(W-pad,by-cs);ctx.stroke();
ctx.shadowBlur=0;
ctx.fillStyle='#00ffc8';ctx.font='700 34px "Noto Sans JP",sans-serif';ctx.textAlign='center';ctx.shadowColor='#00ffc8';ctx.shadowBlur=20;
ctx.fillText(caption.toUpperCase(),W/2,H-70,W-160);ctx.shadowBlur=0;
ctx.font='300 26px "Noto Sans JP",sans-serif';ctx.fillStyle='#ff50a0';ctx.shadowColor='#ff50a0';ctx.shadowBlur=10;
ctx.fillText(dateLine,W/2,H-30,W-160);ctx.shadowBlur=0;
break}
case 'vintage':{
ctx.fillStyle='#e8d8b8';ctx.fillRect(0,0,W,H);
for(let i=0;i<3000;i++){ctx.fillStyle=`rgba(${140+Math.random()*60},${120+Math.random()*40},${80+Math.random()*40},${Math.random()*0.06})`;ctx.fillRect(Math.random()*W,Math.random()*H,Math.random()*2+1,Math.random()*2+1)}
const pad=80;
ctx.fillStyle='#d0c0a0';ctx.fillRect(pad-8,pad-8,W-pad*2+16,H-pad*2-100);
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-120);
ctx.globalAlpha=0.15;ctx.fillStyle='#a08060';ctx.fillRect(pad,pad,W-pad*2,H-pad*2-120);ctx.globalAlpha=1;
ctx.fillStyle='#5a4030';ctx.font='italic 600 34px Georgia,"Noto Serif JP",serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-60,W-200);
ctx.font='italic 300 26px Georgia,"Noto Serif JP",serif';ctx.fillStyle='#8a7060';
ctx.fillText(dateLine,W/2,H-24,W-200);
break}
case 'washi':{
ctx.fillStyle='#faf5ee';ctx.fillRect(0,0,W,H);
const pad=50;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-120);
const tapeColors=['rgba(255,180,180,0.6)','rgba(180,220,255,0.6)','rgba(200,255,200,0.6)','rgba(255,230,180,0.6)'];
const tapeW=80,tapeH=30;
[[pad-20,pad-10,25],[W-pad-60,pad-10,-25],[pad-20,H-pad-140,25],[W-pad-60,H-pad-140,-25]].forEach(([tx,ty,angle],i)=>{
ctx.save();ctx.translate(tx+tapeW/2,ty+tapeH/2);ctx.rotate(angle*Math.PI/180);
ctx.fillStyle=tapeColors[i%tapeColors.length];ctx.fillRect(-tapeW/2,-tapeH/2,tapeW,tapeH);
for(let s=0;s<tapeW;s+=6){ctx.fillStyle=`rgba(255,255,255,${0.1+Math.random()*0.1})`;ctx.fillRect(-tapeW/2+s,-tapeH/2,3,tapeH)}
ctx.restore()});
ctx.fillStyle='#4a4040';ctx.font='500 32px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-70,W-160);
ctx.font='300 26px "Noto Sans JP",sans-serif';ctx.fillStyle='#9a8a80';
ctx.fillText(dateLine,W/2,H-32,W-160);
break}
case 'shadow':{
ctx.fillStyle='#f0f0f0';ctx.fillRect(0,0,W,H);
const pad=80;
ctx.shadowColor='rgba(0,0,0,0.25)';ctx.shadowBlur=40;ctx.shadowOffsetX=12;ctx.shadowOffsetY=12;
ctx.fillStyle='#fff';ctx.fillRect(pad,pad,W-pad*2,H-pad*2-100);
ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;
drawImageCover(ctx,img,pad+20,pad+20,W-pad*2-40,H-pad*2-180);
ctx.fillStyle='#333';ctx.font='600 34px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-80,W-200);
ctx.font='300 26px "Noto Sans JP",sans-serif';ctx.fillStyle='#999';
ctx.fillText(dateLine,W/2,H-40,W-200);
break}
case 'film-strip':{
ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,W,H);
for(let y=0;y<H;y+=80){
ctx.fillStyle='#333';roundRect(ctx,15,y+25,40,30,6);ctx.fill();
roundRect(ctx,W-55,y+25,40,30,6);ctx.fill()}
const pad=80;
drawImageCover(ctx,img,pad,60,W-pad*2,H-200);
ctx.strokeStyle='#444';ctx.lineWidth=2;
ctx.strokeRect(pad-4,56,W-pad*2+8,H-192);
ctx.fillStyle=titleClr||'#e8e8e8';ctx.font='500 32px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-60,W-200);
ctx.fillStyle=subClr||'#888';ctx.font='300 24px "Noto Sans JP",sans-serif';
ctx.fillText(dateLine,W/2,H-28,W-200);
break}
case 'postcard':{
ctx.fillStyle='#faf0e8';ctx.fillRect(0,0,W,H);
const pad=50;
drawImageCover(ctx,img,pad,pad,W-pad*2,H/2);
ctx.fillStyle='#fff';ctx.fillRect(pad,H/2+pad+10,W-pad*2,H/2-pad*2-10);
ctx.strokeStyle='#ddd';ctx.lineWidth=1;
for(let ly=H/2+pad+80;ly<H-pad-20;ly+=50){ctx.beginPath();ctx.moveTo(W/2+20,ly);ctx.lineTo(W-pad-20,ly);ctx.stroke()}
ctx.strokeStyle='#ccc';ctx.lineWidth=2;ctx.setLineDash([6,4]);
ctx.strokeRect(W-pad-160,H/2+pad+20,140,100);ctx.setLineDash([]);
ctx.fillStyle='#ccc';ctx.font='300 16px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.fillText('STAMP',W-pad-90,H/2+pad+75);
ctx.textAlign='left';
ctx.fillStyle='#333';ctx.font='600 32px "Noto Serif JP",serif';
wrapText(ctx,caption,pad+20,H/2+pad+60,W/2-pad-40,40);
ctx.fillStyle='#999';ctx.font='italic 300 24px "Noto Sans JP",sans-serif';
ctx.fillText(dateLine,pad+20,H-pad-30,W/2-pad);
ctx.textAlign='center';
break}
case 'neon':{
ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,W,H);
const pad=60;
drawImageCover(ctx,img,pad,pad,W-pad*2,H-pad*2-140);
ctx.shadowColor='#ff00ff';ctx.shadowBlur=30;ctx.strokeStyle='#ff00ff';ctx.lineWidth=3;
ctx.strokeRect(pad-5,pad-5,W-pad*2+10,H-pad*2-130);
ctx.shadowColor='#00ffff';ctx.shadowBlur=20;ctx.strokeStyle='#00ffff';ctx.lineWidth=1;
ctx.strokeRect(pad+5,pad+5,W-pad*2-10,H-pad*2-150);
ctx.shadowBlur=0;
ctx.fillStyle='#ff00ff';ctx.font='700 36px "Noto Sans JP",sans-serif';ctx.textAlign='center';
ctx.shadowColor='#ff00ff';ctx.shadowBlur=25;
ctx.fillText(caption,W/2,H-90,W-160);
ctx.fillStyle='#00ffff';ctx.font='300 26px "Noto Sans JP",sans-serif';ctx.shadowColor='#00ffff';ctx.shadowBlur=15;
ctx.fillText(dateLine,W/2,H-50,W-160);ctx.shadowBlur=0;
break}
case 'scrapbook':{
ctx.fillStyle='#f5ede0';ctx.fillRect(0,0,W,H);
ctx.strokeStyle='rgba(180,160,140,0.15)';ctx.lineWidth=1;
for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
const pad=80;
ctx.save();ctx.translate(W/2,H/2-60);ctx.rotate(-0.03);
drawImageCover(ctx,img,-((W-pad*2)/2),-((H-pad*2-200)/2),W-pad*2,H-pad*2-200);
ctx.restore();
ctx.fillStyle='rgba(255,230,180,0.7)';
ctx.save();ctx.translate(W/2-200,pad-5);ctx.rotate(0.1);ctx.fillRect(-50,-15,100,30);ctx.restore();
ctx.save();ctx.translate(W/2+200,pad-5);ctx.rotate(-0.08);ctx.fillRect(-50,-15,100,30);ctx.restore();
ctx.fillStyle='#5a4a3a';ctx.font='italic 600 34px "Noto Serif JP",serif';ctx.textAlign='center';
ctx.fillText(caption,W/2,H-80,W-160);
ctx.fillStyle='#8a7a6a';ctx.font='300 26px "Noto Sans JP",sans-serif';
ctx.fillText(dateLine,W/2,H-40,W-160);
break}
}}

function drawImageCover(ctx,img,dx,dy,dw,dh){
const imgRatio=img.naturalWidth/img.naturalHeight;
const boxRatio=dw/dh;
let sx=0,sy=0,sw=img.naturalWidth,sh=img.naturalHeight;
if(imgRatio>boxRatio){sw=img.naturalHeight*boxRatio;sx=(img.naturalWidth-sw)/2}
else{sh=img.naturalWidth/boxRatio;sy=(img.naturalHeight-sh)/2}
ctx.drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh)}

function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}

function drawStickersOnCanvas(ctx,W,H){
shareStickers.forEach(s=>{
ctx.font='80px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
ctx.fillText(s.emoji,s.x*W,s.y*H)})}

function setupCanvasStickerDrag(){
const wrap=document.getElementById('shareCanvasWrap');if(!wrap)return;
const canvas=document.getElementById('shareCanvas');
let dragging=null,startX=0,startY=0;
function getPos(e){const t=e.touches?e.touches[0]:e;const r=wrap.getBoundingClientRect();return{x:(t.clientX-r.left)/r.width,y:(t.clientY-r.top)/r.height}}
function hitTest(pos){for(let i=shareStickers.length-1;i>=0;i--){const s=shareStickers[i];if(Math.abs(pos.x-s.x)<0.06&&Math.abs(pos.y-s.y)<0.05)return i}return-1}
canvas.addEventListener('pointerdown',e=>{const pos=getPos(e);const idx=hitTest(pos);
if(idx>=0){dragging=idx;shareSelectedStickerId=shareStickers[idx].id;startX=pos.x-shareStickers[idx].x;startY=pos.y-shareStickers[idx].y;e.preventDefault()}else{shareSelectedStickerId=null}
renderShareCanvas()});
canvas.addEventListener('pointermove',e=>{if(dragging===null)return;const pos=getPos(e);
shareStickers[dragging].x=Math.max(0.05,Math.min(0.95,pos.x-startX));
shareStickers[dragging].y=Math.max(0.05,Math.min(0.95,pos.y-startY));
renderShareCanvas();e.preventDefault()});
canvas.addEventListener('pointerup',()=>{dragging=null});
canvas.addEventListener('pointerleave',()=>{dragging=null});
wrap.addEventListener('dblclick',e=>{const pos=getPos(e);const idx=hitTest(pos);if(idx>=0){shareStickers.splice(idx,1);shareSelectedStickerId=null;renderShareCanvas()}})}

async function getCanvasBlob(){
const canvas=document.getElementById('shareCanvas');
return new Promise(r=>canvas.toBlob(b=>r(b),'image/png'))}

function getShareFilename(){
const prefix=shareType==='trip'?'trip-summary':shareType==='daily'?'day-highlight':'entry';
const loc=shareCustomText.title?shareCustomText.title.replace(/[^a-zA-Z0-9]/g,'-').toLowerCase().substring(0,30):'tabi';
const date=shareEntryDate||toDateStr(new Date());
return'tabi-'+prefix+'-'+loc+'-'+date+'.png'}

async function saveShareToGallery(){
const canvas=document.getElementById('shareCanvas');if(!canvas){showToast('No canvas');return}
const blob=await getCanvasBlob();
const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download=getShareFilename();a.click();
URL.revokeObjectURL(url);
saveMomentFromCanvas(canvas);
showToast('Saved to gallery & Moments')}

async function shareToInstagram(){
const canvas=document.getElementById('shareCanvas');if(!canvas)return;
saveMomentFromCanvas(canvas);
const blob=await getCanvasBlob();
const file=new File([blob],getShareFilename(),{type:'image/png'});
if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
try{await navigator.share({files:[file],title:'Tabi Moment'})}catch(e){if(e.name!=='AbortError')downloadFallback(blob)}}
else{downloadFallback(blob);showToast('Share Instagram: image saved \u2014 open Instagram to post')}}

async function shareNative(){
const canvas=document.getElementById('shareCanvas');if(!canvas)return;
saveMomentFromCanvas(canvas);
const blob=await getCanvasBlob();
const file=new File([blob],getShareFilename(),{type:'image/png'});
if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
try{await navigator.share({files:[file],title:'Tabi Moment'})}catch(e){if(e.name!=='AbortError')downloadFallback(blob)}}
else{downloadFallback(blob)}}

function downloadFallback(blob){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download=getShareFilename();a.click();
URL.revokeObjectURL(url);showToast('Image saved')}

async function shareQuickNow(){
const entry=getShareEntry();if(!entry||!entry.photos||!entry.photos.length){showToast('No photos to share');return}
shareSelectedPhoto=entry.photos[0];
shareSelectedFrame=appData.settings.defaultShareFrame||'polaroid-black';
shareStickers=[];shareSelectedLayout='photo-card';
document.getElementById('shareModalTitle').textContent='Quick Share';
const body=document.getElementById('shareModalBody');
body.innerHTML='<div class="share-canvas-wrap" id="shareCanvasWrap"><canvas id="shareCanvas" width="1080" height="1350"></canvas></div>'+
`<div class="share-action-bar"><button onclick="saveShareToGallery()"><span class="sa-icon">\U0001f4be</span>Save</button><button onclick="shareToInstagram()"><span class="sa-icon">\U0001f4f8</span>Instagram</button><button class="sa-primary" onclick="shareNative()"><span class="sa-icon">\U0001f4e4</span>Share</button></div>`;
setTimeout(renderShareCanvas,100)}

function saveMomentFromCanvas(canvas){
const trip=getTripById(hubTripId);
const moment={
id:generateId(),
tripId:trip?trip.id:null,
entryId:shareEntryId,
shareType:shareType,
location:shareCustomText.title||'',
date:shareEntryDate||toDateStr(new Date()),
frame:shareSelectedFrame,
layout:shareSelectedLayout,
imageData:canvas.toDataURL('image/png',0.85),
createdAt:new Date().toISOString()};
if(!Array.isArray(appData.moments))appData.moments=[];
appData.moments.push(moment);
saveData()}

/* === EDC PLANNER === */
let edcViewDate=null,edcTab='daily',edcEditingItem=null,edcEditingTarget='standard';

function openEdcPage(){
const trip=getTripById(hubTripId);
if(!trip){showToast('Select a trip first');return}
if(!appData.edc)appData.edc={standard:[],daily:{},templates:{}};
if(!edcViewDate){const today=toDateStr(new Date());edcViewDate=(today>=trip.startDate&&today<=trip.endDate)?today:trip.startDate}
renderEdc();navigateTo('edc')}

function renderEdc(){
const trip=getTripById(hubTripId);if(!trip)return;
const c=document.getElementById('edcContent');
const edc=appData.edc;
const std=edc.standard||[];
const daily=edc.daily||{};
const dayItems=daily[edcViewDate]||[];
const templates=edc.templates||{};
const todayStr=toDateStr(new Date());

let totalStd=std.length,checkedStd=std.filter(i=>i.checked).length;
let totalDay=dayItems.length,checkedDay=dayItems.filter(i=>i.checked).length;
let totalWeight=0;
std.forEach(i=>{if(i.weight)totalWeight+=parseFloat(i.weight)||0});
dayItems.forEach(i=>{if(i.weight)totalWeight+=parseFloat(i.weight)||0});

const vd=new Date(edcViewDate+'T00:00:00');
const start=new Date(trip.startDate+'T00:00:00');
const dayNum=Math.ceil((vd-start)/864e5)+1;
const isToday=edcViewDate===todayStr;

let html=`<div class="edc-header"><h1>ðŸŽ’ EDC Planner</h1><p>Gear & essentials for each day</p></div>`;

html+=`<div class="edc-tabs">
<button class="edc-tab ${edcTab==='daily'?'active':''}" onclick="edcTab='daily';renderEdc()">ðŸ“‹ Daily</button>
<button class="edc-tab ${edcTab==='templates'?'active':''}" onclick="edcTab='templates';renderEdc()">ðŸ“ Templates</button>
<button class="edc-tab ${edcTab==='calendar'?'active':''}" onclick="edcTab='calendar';renderEdc()">ðŸ“… Calendar</button>
</div>`;

if(edcTab==='daily'){
html+=`<div class="edc-stats">
<div class="edc-stat"><div class="edc-stat-value">${checkedStd+checkedDay}/${totalStd+totalDay}</div><div class="edc-stat-label">Packed</div></div>
<div class="edc-stat"><div class="edc-stat-value">${totalStd}</div><div class="edc-stat-label">Standard</div></div>
<div class="edc-stat"><div class="edc-stat-value">${totalDay}</div><div class="edc-stat-label">Day Extra</div></div>
</div>`;

const prevDate=new Date(vd);prevDate.setDate(prevDate.getDate()-1);
const nextDate=new Date(vd);nextDate.setDate(nextDate.getDate()+1);
const prevStr=toDateStr(prevDate),nextStr=toDateStr(nextDate);
const canPrev=prevStr>=trip.startDate,canNext=nextStr<=trip.endDate;

html+=`<div class="edc-date-nav">
<button ${canPrev?`onclick="edcViewDate='${prevStr}';renderEdc()"`:' disabled'}>â€¹</button>
<div class="edc-date-label" onclick="edcGoToToday()" style="cursor:pointer">
<div class="edc-date-label-day">${isToday?'Today â€” ':''}Day ${dayNum}</div>
<div class="edc-date-label-sub">${vd.toLocaleDateString('en-AU',{weekday:'short',month:'short',day:'numeric'})}</div>
</div>
<button ${canNext?`onclick="edcViewDate='${nextStr}';renderEdc()"`:' disabled'}>â€º</button>
</div>`;

// Standard Kit
html+=`<div class="edc-section">
<div class="edc-section-title"><span>ðŸŽ’ Standard Kit</span>
<div style="display:flex;gap:4px">
<button onclick="edcResetChecks('standard')">â†º Reset</button>
<button onclick="edcCheckAll('standard')">âœ“ All</button>
</div></div>`;
if(std.length){
html+='<div class="edc-checklist">';
std.forEach((item,i)=>{
html+=`<div class="edc-item ${item.checked?'checked':''}">
<input type="checkbox" class="edc-item-check" ${item.checked?'checked':''} onchange="edcToggleCheck('standard',${i})">
<div class="edc-item-info"><div class="edc-item-name">${escHtml(item.item)}</div>
${item.weight?'<div class="edc-item-weight">'+item.weight+'g</div>':''}</div>
<div class="edc-item-actions">
<button onclick="edcEditItem('standard',${i})">âœï¸</button>
<button onclick="edcDeleteItem('standard',${i})">ðŸ—‘ï¸</button>
</div></div>`});
html+='</div>';
}else{
html+='<div class="edc-empty"><div class="edc-empty-icon">ðŸŽ’</div><p>No standard items yet</p></div>'}
html+=`<button class="edc-add-btn" onclick="openEdcItemModal('standard')">+ Add Standard Item</button></div>`;

// Day-Specific
html+=`<div class="edc-section">
<div class="edc-section-title"><span>ðŸ“Œ Day ${dayNum} Extras</span>
<div style="display:flex;gap:4px">
<button onclick="edcResetChecks('daily')">â†º Reset</button>
${dayItems.length?'<button onclick="openEdcTemplateModal()">ðŸ’¾ Save</button>':''}
</div></div>`;

const tKeys=Object.keys(templates);
if(tKeys.length){
html+='<div class="edc-templates">';
tKeys.forEach(k=>{
html+=`<button class="edc-template-btn" onclick="edcApplyTemplate('${escAttr(k)}')">${escHtml(k)}</button>`});
html+='</div>'}

if(dayItems.length){
html+='<div class="edc-checklist">';
dayItems.forEach((item,i)=>{
html+=`<div class="edc-item ${item.checked?'checked':''}">
<input type="checkbox" class="edc-item-check" ${item.checked?'checked':''} onchange="edcToggleCheck('daily',${i})">
<div class="edc-item-info"><div class="edc-item-name">${escHtml(item.item)}</div>
${item.weight?'<div class="edc-item-weight">'+item.weight+'g</div>':''}</div>
<div class="edc-item-actions">
<button onclick="edcEditItem('daily',${i})">âœï¸</button>
<button onclick="edcDeleteItem('daily',${i})">ðŸ—‘ï¸</button>
</div></div>`});
html+='</div>';
}else{
html+='<div class="edc-empty"><div class="edc-empty-icon">ðŸ“Œ</div><p>No extras for this day</p><p style="font-size:0.75rem">Add gear or apply a template</p></div>'}
html+=`<button class="edc-add-btn" onclick="openEdcItemModal('daily')">+ Add Day Item</button></div>`;

if(totalWeight>0){
html+=`<div class="edc-weight-total">âš–ï¸ Total weight: <span>${totalWeight>=1000?(totalWeight/1000).toFixed(1)+' kg':totalWeight+'g'}</span></div>`}

}else if(edcTab==='templates'){
html+=`<div class="edc-section"><div class="edc-section-title"><span>ðŸ“ Saved Templates</span></div>`;
const tKeys=Object.keys(templates);
if(!tKeys.length){
html+='<div class="edc-empty"><div class="edc-empty-icon">ðŸ“</div><p>No templates saved yet</p><p style="font-size:0.75rem">Add day-specific items, then save as a template</p></div>'}
else{
tKeys.forEach(k=>{
const t=templates[k];
const items=t.items||[];
html+=`<div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px;backdrop-filter:blur(20px)">
<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px">
<div><div style="font-family:var(--font-serif);font-size:0.95rem;font-weight:600">${escHtml(k)}</div>
${t.description?'<div style="font-size:0.75rem;color:var(--text-tertiary)">'+escHtml(t.description)+'</div>':''}</div>
<div style="font-size:0.75rem;color:var(--text-tertiary)">${items.length} items</div></div>
<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:10px">${items.map(i=>escHtml(i.item)).join(', ')}</div>
<div style="display:flex;gap:8px">
<button style="flex:1;padding:10px;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);font-family:var(--font-sans);font-size:0.8rem;cursor:pointer;color:var(--text-secondary)" onclick="edcApplyTemplate('${escAttr(k)}');edcTab='daily';renderEdc()">ðŸ“Œ Apply to Day ${dayNum}</button>
<button style="padding:10px;border:1px solid rgba(201,75,75,0.2);border-radius:var(--radius-sm);background:none;font-size:0.8rem;cursor:pointer;color:var(--danger)" onclick="edcDeleteTemplate('${escAttr(k)}')">ðŸ—‘ï¸</button>
</div></div>`})}
html+='</div>';

}else if(edcTab==='calendar'){
html+=`<div class="edc-section"><div class="edc-section-title"><span>ðŸ“… Trip Days Overview</span></div>`;
html+='<div class="edc-calendar-dots">';
let d=new Date(trip.startDate+'T00:00:00');
const endD=new Date(trip.endDate+'T00:00:00');
let dn=1;
while(d<=endD){
const ds=toDateStr(d);
const hasCustom=(daily[ds]||[]).length>0;
const isT=ds===todayStr;
const isSel=ds===edcViewDate;
let cls='edc-cal-day';
if(hasCustom)cls+=' has-custom';
if(isT)cls+=' today';
if(isSel)cls+=' selected';
html+=`<div class="${cls}" onclick="edcViewDate='${ds}';edcTab='daily';renderEdc()">
<div style="font-weight:600">D${dn}</div>
<div style="font-size:0.6rem">${d.toLocaleDateString('en-AU',{month:'short',day:'numeric'})}</div>
${hasCustom?'<div style="font-size:0.6rem;color:var(--accent-primary)">+'+daily[ds].length+'</div>':''}
</div>`;
d.setDate(d.getDate()+1);dn++}
html+='</div></div>'}

c.innerHTML=html}

function edcGoToToday(){
const trip=getTripById(hubTripId);if(!trip)return;
const today=toDateStr(new Date());
if(today>=trip.startDate&&today<=trip.endDate){edcViewDate=today;renderEdc()}
else showToast('Today is outside trip dates')}

function edcToggleCheck(target,idx){
const edc=appData.edc;
if(target==='standard'){if(edc.standard[idx])edc.standard[idx].checked=!edc.standard[idx].checked}
else{if(!edc.daily[edcViewDate])edc.daily[edcViewDate]=[];if(edc.daily[edcViewDate][idx])edc.daily[edcViewDate][idx].checked=!edc.daily[edcViewDate][idx].checked}
saveData();renderEdc()}

function edcResetChecks(target){
const edc=appData.edc;
if(target==='standard'){edc.standard.forEach(i=>i.checked=false)}
else{(edc.daily[edcViewDate]||[]).forEach(i=>i.checked=false)}
saveData();renderEdc();showToast('Checkboxes reset')}

function edcCheckAll(target){
const edc=appData.edc;
if(target==='standard'){edc.standard.forEach(i=>i.checked=true)}
else{(edc.daily[edcViewDate]||[]).forEach(i=>i.checked=true)}
saveData();renderEdc();showToast('All checked')}

function edcDeleteItem(target,idx){
if(!confirm('Remove this item?'))return;
const edc=appData.edc;
if(target==='standard'){edc.standard.splice(idx,1)}
else{if(edc.daily[edcViewDate])edc.daily[edcViewDate].splice(idx,1)}
saveData();renderEdc();showToast('Item removed')}

function openEdcItemModal(target,idx){
edcEditingTarget=target||'standard';edcEditingItem=typeof idx==='number'?idx:null;
const edc=appData.edc;
let item={};
if(edcEditingItem!==null){
if(edcEditingTarget==='standard')item=edc.standard[edcEditingItem]||{};
else item=(edc.daily[edcViewDate]||[])[edcEditingItem]||{}}
document.getElementById('edcItemModalTitle').textContent=edcEditingItem!==null?'Edit Item':'Add Item';
const body=document.getElementById('edcItemModalBody');
body.innerHTML=
`<div class="form-group"><label class="form-label">Item Name *</label><input class="form-input" type="text" id="edcItemName" value="${escAttr(item.item||'')}" placeholder="e.g., Camera body, Wide lens"></div>
<div class="form-group"><label class="form-label">Weight (grams, optional)</label><input class="form-input" type="number" id="edcItemWeight" value="${item.weight||''}" placeholder="e.g., 450"></div>
<div class="form-group"><label class="form-label">Add to</label>
<select class="form-select" id="edcItemTarget">
<option value="standard" ${edcEditingTarget==='standard'?'selected':''}>ðŸŽ’ Standard Kit (every day)</option>
<option value="daily" ${edcEditingTarget==='daily'?'selected':''}>ðŸ“Œ Day-Specific (${new Date(edcViewDate+'T00:00:00').toLocaleDateString('en-AU',{month:'short',day:'numeric'})})</option>
</select></div>
<button class="form-btn form-btn-primary" onclick="saveEdcItem()">Save Item</button>
${edcEditingItem!==null?'<button class="form-btn form-btn-danger" onclick="edcDeleteItem(\''+edcEditingTarget+'\','+edcEditingItem+');closeEdcItemModal()">Delete Item</button>':''}`;
document.getElementById('edcItemModal').classList.add('open')}

function closeEdcItemModal(){document.getElementById('edcItemModal').classList.remove('open')}

function edcEditItem(target,idx){openEdcItemModal(target,idx)}

function saveEdcItem(){
const name=document.getElementById('edcItemName').value.trim();
if(!name){showToast('Enter an item name');return}
const weight=document.getElementById('edcItemWeight').value.trim();
const target=document.getElementById('edcItemTarget').value;
const edc=appData.edc;
const item={item:name,weight:weight?parseFloat(weight):null,checked:false};

if(edcEditingItem!==null){
if(edcEditingTarget===target){
if(target==='standard'){const old=edc.standard[edcEditingItem];item.checked=old?old.checked:false;edc.standard[edcEditingItem]=item}
else{if(!edc.daily[edcViewDate])edc.daily[edcViewDate]=[];const old=(edc.daily[edcViewDate]||[])[edcEditingItem];item.checked=old?old.checked:false;edc.daily[edcViewDate][edcEditingItem]=item}
}else{
if(edcEditingTarget==='standard'){edc.standard.splice(edcEditingItem,1)}
else{if(edc.daily[edcViewDate])edc.daily[edcViewDate].splice(edcEditingItem,1)}
if(target==='standard'){edc.standard.push(item)}
else{if(!edc.daily[edcViewDate])edc.daily[edcViewDate]=[];edc.daily[edcViewDate].push(item)}
}}else{
if(target==='standard'){edc.standard.push(item)}
else{if(!edc.daily[edcViewDate])edc.daily[edcViewDate]=[];edc.daily[edcViewDate].push(item)}}
saveData();closeEdcItemModal();renderEdc();showToast(edcEditingItem!==null?'Item updated':'Item added')}

function openEdcTemplateModal(){document.getElementById('edcTemplateName').value='';document.getElementById('edcTemplateDesc').value='';document.getElementById('edcTemplateModal').classList.add('open')}
function closeEdcTemplateModal(){document.getElementById('edcTemplateModal').classList.remove('open')}

function saveEdcTemplate(){
const name=document.getElementById('edcTemplateName').value.trim();
if(!name){showToast('Enter a template name');return}
const edc=appData.edc;
if(!edc.templates)edc.templates={};
const dayItems=(edc.daily[edcViewDate]||[]).map(i=>({item:i.item,weight:i.weight}));
if(!dayItems.length){showToast('No day items to save');return}
edc.templates[name]={description:document.getElementById('edcTemplateDesc').value.trim(),items:dayItems,createdAt:new Date().toISOString()};
saveData();closeEdcTemplateModal();renderEdc();showToast('Template "'+name+'" saved')}

function edcApplyTemplate(name){
const edc=appData.edc;
const t=(edc.templates||{})[name];
if(!t||!t.items)return;
if(!edc.daily[edcViewDate])edc.daily[edcViewDate]=[];
const existing=edc.daily[edcViewDate].map(i=>i.item.toLowerCase());
let added=0;
t.items.forEach(ti=>{
if(!existing.includes(ti.item.toLowerCase())){
edc.daily[edcViewDate].push({item:ti.item,weight:ti.weight,checked:false});
added++}});
saveData();renderEdc();showToast(added?added+' items added from "'+name+'"':'All items already present')}

function edcDeleteTemplate(name){
if(!confirm('Delete template "'+name+'"?'))return;
delete appData.edc.templates[name];
saveData();renderEdc();showToast('Template deleted')}

/* === DAILY & TRIP REFLECTIONS === */
function renderDailyReflection(dateStr){
if(!appData.dailyReflections)appData.dailyReflections={};
const ref=appData.dailyReflections[dateStr];
if(ref&&(ref.thoughts||ref.highlights||ref.challenges||ref.gratitude)){
let fields='';
if(ref.thoughts)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Overall thoughts</div><div class="daily-reflection-field-text">'+escHtml(ref.thoughts)+'</div></div>';
if(ref.highlights)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Highlights</div><div class="daily-reflection-field-text">'+escHtml(ref.highlights)+'</div></div>';
if(ref.challenges)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Challenges</div><div class="daily-reflection-field-text">'+escHtml(ref.challenges)+'</div></div>';
if(ref.gratitude)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Gratitude</div><div class="daily-reflection-field-text">'+escHtml(ref.gratitude)+'</div></div>';
return'<div class="daily-reflection-card"><div class="daily-reflection-header"><div class="daily-reflection-title">ðŸŒ™ End of Day Reflection</div><div class="daily-reflection-actions"><button onclick="openDailyReflectionModal(\''+dateStr+'\')" title="Edit">âœï¸</button></div></div>'+fields+'</div>'}
return'<div class="daily-reflection-empty"><div class="daily-reflection-empty-text">ðŸŒ™ How was your day?</div><button class="daily-reflection-empty-btn" onclick="openDailyReflectionModal(\''+dateStr+'\')">âœï¸ Add End of Day Reflection</button></div>'}

function openDailyReflectionModal(dateStr){
if(!appData.dailyReflections)appData.dailyReflections={};
const ref=appData.dailyReflections[dateStr]||{};
const d=new Date(dateStr+'T00:00:00');
const trip=getTripById(hubTripId);
const start=trip?new Date(trip.startDate+'T00:00:00'):d;
const dayNum=Math.ceil((d-start)/864e5)+1;
document.getElementById('dailyReflectionModalTitle').textContent='Day '+dayNum+' Reflection';
const body=document.getElementById('dailyReflectionModalBody');
body.innerHTML=
'<p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.5">'+d.toLocaleDateString('en-AU',{weekday:'long',month:'long',day:'numeric',year:'numeric'})+'</p>'+
'<div class="form-group"><label class="form-label">Overall thoughts</label><textarea class="form-textarea" id="drThoughts" rows="3" placeholder="How did today go? What stands out?">'+escHtml(ref.thoughts||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">âœ¨ Highlights</label><textarea class="form-textarea" id="drHighlights" rows="3" placeholder="Best moments, discoveries, things that made you smile...">'+escHtml(ref.highlights||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">ðŸŒ§ï¸ Challenges</label><textarea class="form-textarea" id="drChallenges" rows="2" placeholder="What was hard? What didn\'t go as planned?">'+escHtml(ref.challenges||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">ðŸ™ Gratitude</label><textarea class="form-textarea" id="drGratitude" rows="2" placeholder="What are you grateful for today?">'+escHtml(ref.gratitude||'')+'</textarea></div>'+
'<button class="form-btn form-btn-primary" onclick="saveDailyReflection(\''+dateStr+'\')">Save Reflection</button>'+
(ref.thoughts||ref.highlights||ref.challenges||ref.gratitude?'<button class="form-btn form-btn-danger" onclick="deleteDailyReflection(\''+dateStr+'\')">Delete Reflection</button>':'');
document.getElementById('dailyReflectionModal').classList.add('open')}

function closeDailyReflectionModal(){document.getElementById('dailyReflectionModal').classList.remove('open')}

function saveDailyReflection(dateStr){
const thoughts=document.getElementById('drThoughts').value.trim();
const highlights=document.getElementById('drHighlights').value.trim();
const challenges=document.getElementById('drChallenges').value.trim();
const gratitude=document.getElementById('drGratitude').value.trim();
if(!thoughts&&!highlights&&!challenges&&!gratitude){showToast('Write something first');return}
if(!appData.dailyReflections)appData.dailyReflections={};
appData.dailyReflections[dateStr]={thoughts,highlights,challenges,gratitude,updatedAt:new Date().toISOString()};
saveData();closeDailyReflectionModal();renderJournal();showToast('Reflection saved')}

function deleteDailyReflection(dateStr){
if(!confirm('Delete this day\'s reflection?'))return;
delete appData.dailyReflections[dateStr];
saveData();closeDailyReflectionModal();renderJournal();showToast('Reflection deleted')}

/* Trip Reflection */
function renderTripReflectionSection(trip){
if(!appData.tripReflections)appData.tripReflections={};
const ref=appData.tripReflections[trip.id];
let html='<div class="hub-section-title fade-in stagger-5">Journey Reflection</div><div class="trip-reflection-section fade-in stagger-5">';
if(ref&&(ref.journey||ref.lessons||ref.favorites)){
let fields='';
if(ref.journey)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Overall journey</div><div class="daily-reflection-field-text">'+escHtml(ref.journey)+'</div></div>';
if(ref.lessons)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Lessons learned</div><div class="daily-reflection-field-text">'+escHtml(ref.lessons)+'</div></div>';
if(ref.favorites)fields+='<div class="daily-reflection-field"><div class="daily-reflection-field-label">Favorite moments</div><div class="daily-reflection-field-text">'+escHtml(ref.favorites)+'</div></div>';
if(ref.updatedAt)fields+='<div style="font-size:0.7rem;color:var(--text-tertiary);margin-top:8px">Last updated: '+new Date(ref.updatedAt).toLocaleDateString('en-AU',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</div>';
html+='<div class="trip-reflection-card"><div class="trip-reflection-card-header"><div><div class="trip-reflection-card-title">ðŸª· Trip Reflection</div><div class="trip-reflection-card-sub">Your ongoing journey notes</div></div><div class="trip-reflection-card-actions"><button onclick="openTripReflectionModal(\''+trip.id+'\')">âœï¸ Edit</button></div></div>'+fields+'</div>'}
else{
html+='<div class="trip-reflection-card" style="text-align:center;cursor:pointer" onclick="openTripReflectionModal(\''+trip.id+'\')"><div class="trip-reflection-empty"><div style="font-size:1.5rem;margin-bottom:8px;opacity:0.4">ðŸª·</div><div>Reflect on your journey as it unfolds</div><button class="daily-reflection-empty-btn" style="margin:12px auto 0" onclick="event.stopPropagation();openTripReflectionModal(\''+trip.id+'\')">âœï¸ Start Reflecting</button></div></div>'}
return html+'</div>'}

function openTripReflectionModal(tripId){
if(!appData.tripReflections)appData.tripReflections={};
const ref=appData.tripReflections[tripId]||{};
const trip=getTripById(tripId);
document.getElementById('tripReflectionModalTitle').textContent='Trip Reflection'+(trip?' â€” '+trip.name:'');
const body=document.getElementById('tripReflectionModalBody');
body.innerHTML=
'<p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.5">A living reflection you can update throughout your trip. Come back to this anytime.</p>'+
'<div class="form-group"><label class="form-label">ðŸ—ºï¸ Overall journey notes</label><textarea class="form-textarea" id="trJourney" rows="4" placeholder="How is the trip going? What\'s the overall feel so far?">'+escHtml(ref.journey||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">ðŸ’¡ Lessons learned</label><textarea class="form-textarea" id="trLessons" rows="3" placeholder="Things you\'ve learned â€” about Japan, travel, or yourself...">'+escHtml(ref.lessons||'')+'</textarea></div>'+
'<div class="form-group"><label class="form-label">ðŸ’› Favorite moments</label><textarea class="form-textarea" id="trFavorites" rows="3" placeholder="The moments that will stay with you...">'+escHtml(ref.favorites||'')+'</textarea></div>'+
'<button class="form-btn form-btn-primary" onclick="saveTripReflection(\''+tripId+'\')">Save Reflection</button>'+
(ref.journey||ref.lessons||ref.favorites?'<button class="form-btn form-btn-danger" onclick="deleteTripReflection(\''+tripId+'\')">Delete Reflection</button>':'');
document.getElementById('tripReflectionModal').classList.add('open')}

function closeTripReflectionModal(){document.getElementById('tripReflectionModal').classList.remove('open')}

function saveTripReflection(tripId){
const journey=document.getElementById('trJourney').value.trim();
const lessons=document.getElementById('trLessons').value.trim();
const favorites=document.getElementById('trFavorites').value.trim();
if(!journey&&!lessons&&!favorites){showToast('Write something first');return}
if(!appData.tripReflections)appData.tripReflections={};
appData.tripReflections[tripId]={journey,lessons,favorites,updatedAt:new Date().toISOString()};
saveData();closeTripReflectionModal();const trip=getTripById(tripId);if(trip)renderTripHub(trip);showToast('Trip reflection saved')}

function deleteTripReflection(tripId){
if(!confirm('Delete this trip reflection?'))return;
delete appData.tripReflections[tripId];
saveData();closeTripReflectionModal();const trip=getTripById(tripId);if(trip)renderTripHub(trip);showToast('Trip reflection deleted')}

/* === PEOPLE MET === */
let personPhoto=null,editingPersonId=null,peopleSearchQuery='';

function openPeoplePage(){const trip=getTripById(hubTripId);if(!trip){showToast('Select a trip first');return}if(!Array.isArray(appData.people))appData.people=[];renderPeople();navigateTo('people')}

function renderPeople(){const trip=getTripById(hubTripId);if(!trip)return;const c=document.getElementById('peopleContent');
let items=(appData.people||[]).filter(p=>p.dateMet>=trip.startDate&&p.dateMet<=trip.endDate).sort((a,b)=>(b.dateMet+(b.createdAt||'')).localeCompare(a.dateMet+(a.createdAt||'')));
if(peopleSearchQuery){const q=peopleSearchQuery.toLowerCase();items=items.filter(p=>(p.name||'').toLowerCase().includes(q)||(p.whereMet||'').toLowerCase().includes(q)||(p.contact||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)||(p.context||'').toLowerCase().includes(q))}
const uniqueDays=new Set(items.map(p=>p.dateMet)).size;
let html='<div class="people-header"><h1>ðŸ‘¥ People Met</h1><p>Connections made along the way</p></div>';
html+='<div class="people-stats"><div class="ps-card"><div class="ps-card-value">'+items.length+'</div><div class="ps-card-label">People</div></div><div class="ps-card"><div class="ps-card-value">'+uniqueDays+'</div><div class="ps-card-label">Days</div></div><div class="ps-card"><div class="ps-card-value">'+items.filter(p=>p.contact).length+'</div><div class="ps-card-label">Contacts</div></div></div>';
html+='<div class="people-search"><input type="text" placeholder="Search people..." value="'+escAttr(peopleSearchQuery)+'" oninput="peopleSearchQuery=this.value;renderPeople()"></div>';
if(!items.length){html+='<div class="people-empty"><div class="people-empty-icon">ðŸ‘¥</div><p>'+(peopleSearchQuery?'No matches found':'No people logged yet')+'</p>'+(peopleSearchQuery?'':'<button class="action-btn action-btn-primary" onclick="openPersonModal()" style="display:inline-flex">ðŸ‘¥ Log First Person</button>')+'</div>'}
else{items.forEach(p=>{html+=renderPersonCard(p)})}
c.innerHTML=html}

function renderPersonCard(p){
const initials=(p.name||'?').split(/\s+/).map(w=>w[0]).join('').toUpperCase().slice(0,2);
const avatarContent=p.photo?'<img src="'+p.photo+'" alt="">':initials;
let contactHtml='';
if(p.contact){const c=p.contact.trim();if(c.startsWith('@')){contactHtml='<a class="people-contact-link" href="https://instagram.com/'+encodeURIComponent(c.replace('@',''))+'" target="_blank" rel="noopener">ðŸ“¸ '+escHtml(c)+'</a>'}else if(c.includes('@')&&c.includes('.')){contactHtml='<a class="people-contact-link" href="mailto:'+encodeURIComponent(c)+'">âœ‰ï¸ '+escHtml(c)+'</a>'}else{contactHtml='<span class="people-contact-link">ðŸ’¬ '+escHtml(c)+'</span>'}}
let linkedHtml='';
if(p.linkedJournalEntry){const je=findJournalEntryById(p.linkedJournalEntry);if(je)linkedHtml='<div class="people-linked-entry" onclick="event.stopPropagation();goToJournalEntry(\''+je.date+'\',\''+je.id+'\')">ðŸ“– '+escHtml(je.name)+'</div>'}
return'<div class="people-card" onclick="this.classList.toggle(\'expanded\')">'+
'<div class="people-card-top">'+
'<div class="people-card-avatar">'+avatarContent+'</div>'+
'<div class="people-card-info">'+
'<div class="people-card-name">'+escHtml(p.name||'Unknown')+'</div>'+
(p.whereMet?'<div class="people-card-where">ðŸ“ '+escHtml(p.whereMet)+'</div>':'')+
'<div class="people-card-date">'+fmtDate(p.dateMet)+'</div>'+
'</div></div>'+
'<div class="people-card-detail">'+
(contactHtml?'<div class="people-detail-section"><div class="people-detail-label">Contact / é€£çµ¡å…ˆ</div>'+contactHtml+'</div>':'')+
(p.context?'<div class="people-detail-section"><div class="people-detail-label">How we met / å‡ºä¼šã£ãŸçµŒç·¯</div><div class="people-detail-text">'+escHtml(p.context)+'</div></div>':'')+

linkedHtml+
'<div class="people-card-actions">'+
'<button onclick="event.stopPropagation();openPersonModal(\''+p.id+'\')">âœï¸ Edit</button>'+
'<button class="danger" onclick="event.stopPropagation();deletePerson(\''+p.id+'\')">ðŸ—‘ï¸ Delete</button>'+
'</div></div></div>'}

function findJournalEntryById(entryId){const j=appData.journal||{};for(const ds of Object.keys(j)){const entries=j[ds]||[];const found=entries.find(e=>e.id===entryId);if(found)return{...found,date:ds}}return null}

function goToJournalEntry(date,entryId){journalDate=date;renderJournal();navigateTo('journal');setTimeout(()=>{const el=document.querySelector('[data-entry-id="'+entryId+'"]');if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},300)}

function openPersonModal(personId){editingPersonId=personId||null;personPhoto=null;
let p={};if(personId){p=appData.people.find(x=>x.id===personId)||{};personPhoto=p.photo||null}
const journalEntries=getJournalEntriesForTrip();
document.getElementById('personModalTitle').textContent=personId?'Edit Person':'Log Person';
const body=document.getElementById('personModalBody');
body.innerHTML=
'<div class="form-group"><label class="form-label"><div class="people-bilingual-label">Name <span class="jp">åå‰</span></div></label><input class="form-input" type="text" id="personName" value="'+escAttr(p.name||'')+'" placeholder="Their name"></div>'+
'<div class="form-group"><label class="form-label"><div class="people-bilingual-label">Contact <span class="jp">é€£çµ¡å…ˆï¼ˆä»»æ„ â€” Instagramã€ãƒ¡ãƒ¼ãƒ«ãªã©ï¼‰</span></div></label><input class="form-input" type="text" id="personContact" value="'+escAttr(p.contact||'')+'" placeholder="@instagram, email, or other"></div>'+
'<div class="form-group"><label class="form-label"><div class="people-bilingual-label">Where we met <span class="jp">å‡ºä¼šã£ãŸå ´æ‰€</span></div></label><input class="form-input" type="text" id="personWhereMet" value="'+escAttr(p.whereMet||'')+'" placeholder="Location or place name"></div>'+
'<div class="form-row"><div class="form-group"><label class="form-label">Date Met</label><input class="form-input" type="date" id="personDate" value="'+(p.dateMet||toDateStr(new Date()))+'"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="personTime" value="'+(p.time||'')+'"></div></div>'+
'<div class="form-group"><label class="form-label">Photo</label><div class="photo-upload-area" onclick="document.getElementById(\'personPhotoInput\').click()"><div class="photo-upload-area-icon">ðŸ“·</div><div class="photo-upload-area-text">'+(personPhoto?'Tap to change':'Tap to add photo')+'</div></div><input type="file" id="personPhotoInput" accept="image/*" style="display:none" onchange="handlePersonPhoto(event)"><div id="personPhotoPreview">'+(personPhoto?'<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+personPhoto+'" alt=""><button class="photo-preview-remove" onclick="personPhoto=null;document.getElementById(\'personPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>':'')+'</div></div>'+
'<div class="form-group"><label class="form-label">Context â€” how you met, what you talked about</label><textarea class="form-textarea" id="personContext" rows="3" placeholder="How did you meet? What did you talk about?">'+escHtml(p.context||'')+'</textarea></div>'+

'<div class="form-group"><label class="form-label">Link to Journal Entry</label><select class="form-select" id="personLinkedEntry"><option value="">â€” None â€”</option>'+journalEntries.map(je=>'<option value="'+je.id+'" '+(je.id===(p.linkedJournalEntry||'')?'selected':'')+'>'+escHtml(je.label)+'</option>').join('')+'</select></div>'+
'<button class="form-btn form-btn-primary" onclick="savePerson()">'+(personId?'Update':'Save Person')+'</button>'+
(personId?'<button class="form-btn form-btn-danger" onclick="deletePerson(\''+p.id+'\');closePersonModal()">Delete</button>':'');
document.getElementById('personModal').classList.add('open')}

function closePersonModal(){document.getElementById('personModal').classList.remove('open')}

function handlePersonPhoto(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo too large');return}const reader=new FileReader();reader.onload=ev=>{personPhoto=ev.target.result;document.getElementById('personPhotoPreview').innerHTML='<div class="photo-preview-grid"><div class="photo-preview-item"><img src="'+personPhoto+'" alt=""><button class="photo-preview-remove" onclick="personPhoto=null;document.getElementById(\'personPhotoPreview\').innerHTML=\'\'">âœ•</button></div></div>'};reader.readAsDataURL(file);e.target.value=''}

function savePerson(){const name=document.getElementById('personName').value.trim();if(!name){showToast('Enter a name');return}
const p={id:editingPersonId||generateId(),name,contact:document.getElementById('personContact').value.trim(),whereMet:document.getElementById('personWhereMet').value.trim(),dateMet:document.getElementById('personDate').value||toDateStr(new Date()),time:document.getElementById('personTime').value||'',photo:personPhoto,context:document.getElementById('personContext').value.trim(),linkedJournalEntry:document.getElementById('personLinkedEntry').value||null,createdAt:editingPersonId?undefined:new Date().toISOString(),updatedAt:new Date().toISOString()};
if(!Array.isArray(appData.people))appData.people=[];
if(editingPersonId){const idx=appData.people.findIndex(x=>x.id===editingPersonId);if(idx>=0){p.createdAt=appData.people[idx].createdAt;appData.people[idx]=p}else{appData.people.push(p)}}else{appData.people.push(p)}
saveData();closePersonModal();renderPeople();showToast(editingPersonId?'Person updated':'Person logged!')}

function deletePerson(id){if(!confirm('Delete this person?'))return;appData.people=appData.people.filter(p=>p.id!==id);saveData();closePersonModal();if(currentPage==='people')renderPeople();showToast('Person deleted')}

/* === MOMENTS GALLERY === */
function openMomentsPage(){
const trip=getTripById(hubTripId);
if(!trip){showToast('Select a trip first');return}
renderMoments();navigateTo('moments')}

function renderMoments(){
const trip=getTripById(hubTripId);if(!trip)return;
const c=document.getElementById('momentsContent');
if(!Array.isArray(appData.moments))appData.moments=[];
const items=appData.moments.filter(m=>m.tripId===trip.id).sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
const uniqueDays=new Set(items.map(m=>m.date)).size;
let html='<div class="moments-header"><h1>âœ¨ Moments</h1><p>Your shared graphics & memories</p></div>';
html+='<div class="moments-stats"><div class="ps-card"><div class="ps-card-value">'+items.length+'</div><div class="ps-card-label">Graphics</div></div><div class="ps-card"><div class="ps-card-value">'+uniqueDays+'</div><div class="ps-card-label">Days</div></div><div class="ps-card"><div class="ps-card-value">'+new Set(items.map(m=>m.frame)).size+'</div><div class="ps-card-label">Frames Used</div></div></div>';
if(!items.length){html+='<div class="moments-empty"><div class="moments-empty-icon">âœ¨</div><p>No share graphics yet</p><p style="font-size:0.8rem;margin-top:4px;color:var(--text-tertiary)">Create one from a journal entry using the ðŸ“¤ share button</p></div>'}
else{html+='<div class="moments-grid">'+items.map(m=>`<div class="moment-thumb" onclick="openMomentDetail('${m.id}')"><img src="${m.imageData}" alt=""><div class="moment-thumb-caption">${escHtml(m.location||'')}</div></div>`).join('')+'</div>'}
c.innerHTML=html}

function openMomentDetail(id){
const m=appData.moments.find(x=>x.id===id);if(!m)return;
document.getElementById('momentDetailImg').src=m.imageData;
document.getElementById('momentDetailLocation').textContent=m.location||'';
document.getElementById('momentDetailDate').textContent=m.date?fmtDate(m.date):'';
document.getElementById('momentDetailActions').innerHTML=
`<button onclick="reshareFromMoment('${m.id}')">ðŸ“¤ Re-Share</button>`+
`<button onclick="redownloadMoment('${m.id}')">ðŸ’¾ Save</button>`+
`<button class="danger" onclick="deleteMoment('${m.id}')">ðŸ—‘ï¸ Delete</button>`;
document.getElementById('momentDetailOverlay').classList.add('open')}

function closeMomentDetail(){document.getElementById('momentDetailOverlay').classList.remove('open')}

async function reshareFromMoment(id){
const m=appData.moments.find(x=>x.id===id);if(!m)return;
closeMomentDetail();
const blob=await(await fetch(m.imageData)).blob();
const file=new File([blob],'tabi-moment.png',{type:'image/png'});
if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
try{await navigator.share({files:[file],title:'Tabi Moment'})}catch(e){if(e.name!=='AbortError')downloadBlobFallback(blob)}}
else{downloadBlobFallback(blob)}}

async function redownloadMoment(id){
const m=appData.moments.find(x=>x.id===id);if(!m)return;
const blob=await(await fetch(m.imageData)).blob();
downloadBlobFallback(blob);showToast('Saved')}

function downloadBlobFallback(blob){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download='tabi-moment-'+Date.now()+'.png';a.click();
URL.revokeObjectURL(url)}

function deleteMoment(id){
if(!confirm('Delete this graphic?'))return;
appData.moments=appData.moments.filter(m=>m.id!==id);
saveData();closeMomentDetail();
if(currentPage==='moments')renderMoments();
showToast('Moment deleted')}

/* === INIT === */
document.addEventListener('DOMContentLoaded',init);

</script>
</body>
</html>